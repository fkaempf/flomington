<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#09090b">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Flomington</title>
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');

:root {
  color-scheme: dark;
  --bg: #09090b;
  --surface: rgba(255,255,255,0.05);
  --surface-2: rgba(255,255,255,0.08);
  --surface-3: rgba(255,255,255,0.12);
  --border: rgba(255,255,255,0.08);
  --border-2: rgba(255,255,255,0.14);
  --text-1: #fafafa;
  --text-2: #a1a1aa;
  --text-3: #52525b;
  --accent: #8b5cf6;
  --accent-2: #a78bfa;
  --accent-glow: rgba(139,92,246,0.15);
  --accent-glow-2: rgba(139,92,246,0.08);
  --green: #22c55e;
  --amber: #f59e0b;
  --red: #ef4444;
  --radius: 16px;
  --radius-sm: 12px;
  --radius-xs: 8px;
}

* { -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg);
  color: var(--text-2);
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  overscroll-behavior: none;
  letter-spacing: -0.01em;
}

/* Subtle noise texture overlay */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  opacity: 0.015;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 9999;
}

.mono { font-family: 'SF Mono', 'Fira Code', ui-monospace, monospace; font-size: 0.82em; letter-spacing: 0; }

::-webkit-scrollbar { width: 3px; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 3px; }
::-webkit-scrollbar-track { background: transparent; }

input, textarea, select {
  background: var(--surface) !important;
  border: 1px solid var(--border) !important;
  color: var(--text-1) !important;
  font-size: 16px !important;
  font-family: inherit !important;
  letter-spacing: -0.01em;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}
input:focus, textarea:focus, select:focus {
  border-color: var(--accent) !important;
  outline: none;
  box-shadow: 0 0 0 3px var(--accent-glow), 0 0 20px var(--accent-glow-2);
  background: var(--surface-2) !important;
}

/* ===== Glass Cards ===== */
.card {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.06);
  border-radius: var(--radius);
  backdrop-filter: blur(40px) saturate(1.6);
  -webkit-backdrop-filter: blur(40px) saturate(1.6);
  transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  position: relative;
  overflow: hidden;
}
.card::before {
  content: '';
  position: absolute; top: 0; left: 10%; right: 10%;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.08), transparent);
  transition: all 0.4s ease;
}
.card:hover {
  background: rgba(255, 255, 255, 0.06);
  border-color: rgba(0, 128, 128, 0.15);
  box-shadow: 0 8px 32px rgba(0,0,0,0.2), 0 0 60px rgba(0, 128, 128, 0.05);
  transform: translateY(-4px);
}
.card:hover::before {
  background: linear-gradient(90deg, transparent, rgba(0, 128, 128, 0.2), transparent);
}
.card-inner {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-xs);
}

/* ===== Animations ===== */
@keyframes slideUp {
  from { transform: translateY(12px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
@keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
@keyframes pulse-dot {
  0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
  50% { transform: translate(-50%, -50%) scale(1.4); opacity: 0.6; }
}
@keyframes shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}
@keyframes shake {
  0%,100% { transform: translateX(0); }
  20%,60% { transform: translateX(-8px); }
  40%,80% { transform: translateX(8px); }
}
@keyframes fab-in {
  from { transform: scale(0) rotate(-90deg); opacity: 0; }
  to { transform: scale(1) rotate(0); opacity: 1; }
}
@keyframes glow-pulse {
  0%, 100% { box-shadow: 0 0 20px var(--accent-glow); }
  50% { box-shadow: 0 0 30px var(--accent-glow), 0 0 60px rgba(139,92,246,0.05); }
}
@keyframes modal-in {
  from { transform: scale(0.95) translateY(10px); opacity: 0; }
  to { transform: scale(1) translateY(0); opacity: 1; }
}
@keyframes backdrop-in {
  from { opacity: 0; }
  to { opacity: 1; }
}

.anim-in { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
.anim-out { animation: fadeOut 0.2s ease forwards; }
.pulse-dot { animation: pulse-dot 2s ease-in-out infinite; }
.shake { animation: shake 0.4s ease; }
.fab-anim { animation: fab-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }

/* ===== Touch targets ===== */
.touch {
  min-height: 44px;
  min-width: 44px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  -webkit-user-select: none;
  user-select: none;
}

/* ===== Timeline ===== */
.tl-track {
  position: relative;
  height: 4px;
  background: var(--surface-2);
  border-radius: 4px;
}
.tl-fill {
  position: absolute;
  left: 0; top: 0;
  height: 100%;
  border-radius: 4px;
  transition: width 0.6s cubic-bezier(0.16, 1, 0.3, 1);
  background: linear-gradient(90deg, var(--green), var(--accent));
}
.tl-dot {
  position: absolute;
  top: 50%;
  transform: translate(-50%, -50%);
  border-radius: 50%;
  transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
}
.tl-dot-done {
  width: 10px; height: 10px;
  background: var(--green);
  box-shadow: 0 0 8px rgba(34,197,94,0.3);
}
.tl-dot-current {
  width: 14px; height: 14px;
  background: var(--accent);
  box-shadow: 0 0 12px var(--accent-glow), 0 0 4px var(--accent-glow);
  z-index: 2;
}
.tl-dot-future {
  width: 8px; height: 8px;
  background: var(--surface-3);
}
.tl-label {
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  font-weight: 600;
  white-space: nowrap;
}

/* ===== Progress bar ===== */
.prog-track {
  height: 6px;
  background: var(--surface-2);
  border-radius: 6px;
  overflow: hidden;
}
.prog-fill {
  height: 100%;
  border-radius: 6px;
  transition: width 0.5s cubic-bezier(0.16, 1, 0.3, 1);
  background: linear-gradient(90deg, #7c3aed, #a78bfa);
  box-shadow: 0 0 10px var(--accent-glow);
}
.prog-fill.done {
  background: linear-gradient(90deg, #059669, #34d399);
  box-shadow: 0 0 10px rgba(34,197,94,0.2);
}

/* ===== Badge ===== */
.badge {
  font-size: 0.6rem;
  padding: 3px 8px;
  border-radius: 99px;
  font-weight: 600;
  letter-spacing: 0.02em;
  white-space: nowrap;
  line-height: 1.5;
  backdrop-filter: blur(8px);
}

/* ===== PIN ===== */
.pin-dot {
  width: 12px; height: 12px;
  border-radius: 50%;
  border: 2px solid rgba(255,255,255,0.12);
  transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
}
.pin-dot.filled {
  background: var(--accent);
  border-color: var(--accent);
  box-shadow: 0 0 12px var(--accent-glow);
  transform: scale(1.15);
}

/* ===== Overflow menu ===== */
.overflow-menu {
  position: absolute;
  right: 0;
  top: 100%;
  margin-top: 8px;
  z-index: 30;
  min-width: 240px;
}

/* ===== Location cards ===== */
.loc-card {
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 16px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
  background: var(--surface);
}
.loc-card:active { transform: scale(0.97); }
.loc-card.selected {
  border-color: var(--accent);
  background: var(--accent-glow-2);
  box-shadow: 0 0 20px var(--accent-glow-2), inset 0 0 20px var(--accent-glow-2);
}

/* ===== Stock list search ===== */
.stock-pick {
  cursor: pointer;
  padding: 14px 16px;
  border-radius: var(--radius-sm);
  transition: all 0.15s;
}
.stock-pick:active { background: var(--accent-glow-2); transform: scale(0.98); }

/* ===== Quick log buttons ===== */
.qlog-btn {
  min-height: 44px;
  min-width: 52px;
  border-radius: var(--radius-sm);
  font-weight: 700;
  font-size: 14px;
  transition: all 0.15s cubic-bezier(0.16, 1, 0.3, 1);
  background: var(--accent-glow-2);
  color: var(--accent-2);
  border: 1px solid rgba(139,92,246,0.15);
}
.qlog-btn:active { background: var(--accent-glow); transform: scale(0.95); }

/* ===== Banner ===== */
.banner {
  border-radius: var(--radius);
  padding: 16px 20px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.15s;
  backdrop-filter: blur(12px);
}
.banner:active { transform: scale(0.98); }
.banner-red {
  background: linear-gradient(135deg, rgba(239,68,68,0.12), rgba(239,68,68,0.04));
  border: 1px solid rgba(239,68,68,0.15);
  color: #fca5a5;
}
.banner-amber {
  background: linear-gradient(135deg, rgba(245,158,11,0.12), rgba(245,158,11,0.04));
  border: 1px solid rgba(245,158,11,0.15);
  color: #fcd34d;
}
.banner-green {
  background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(34,197,94,0.03));
  border: 1px solid rgba(34,197,94,0.12);
  color: #86efac;
}

/* ===== Section headers ===== */
.section-header {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-3);
  margin-bottom: 16px;
}

/* ===== Floating nav ===== */
.bottom-nav {
  position: fixed;
  bottom: 16px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 40;
  background: rgba(24,24,27,0.85);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 999px;
  padding: 6px 8px;
  display: flex;
  gap: 4px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.03);
}
.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 8px 20px;
  border-radius: 999px;
  transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
  cursor: pointer;
  -webkit-user-select: none;
  user-select: none;
  gap: 2px;
  min-width: 72px;
}
.nav-item.active {
  background: var(--accent-glow);
}
.nav-item span {
  font-size: 9px;
  font-weight: 600;
  letter-spacing: 0.02em;
}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback, useMemo, useRef } = React;

/* ========== HELPERS ========== */
const uid = () => crypto.randomUUID?.() || Math.random().toString(36).slice(2) + Date.now().toString(36);
const today = () => new Date().toISOString().slice(0, 10);
const addDays = (d, n) => { const x = new Date(d + 'T12:00:00'); x.setDate(x.getDate() + n); return x.toISOString().slice(0, 10); };
const fmt = d => { if (!d) return '—'; return new Date(d + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); };
const fmtFull = d => { if (!d) return '—'; return new Date(d + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }); };
const isPast = d => d < today();
const isToday = d => d === today();
const dFromNow = d => Math.round((new Date(d + 'T12:00:00') - new Date(today() + 'T12:00:00')) / 864e5);

/* ========== SHEETS SYNC ========== */
const SYNC_FIELDS = ['id', 'name', 'genotype', 'variant', 'category', 'location', 'source', 'sourceId', 'flybaseId', 'maintainer', 'notes', 'isGift', 'giftFrom', 'createdAt', 'lastFlipped'];

async function sheetsPull(url) {
  const res = await fetch(url);
  const data = await res.json();
  if (data.error) throw new Error(data.error);
  return (data.stocks || []).map(s => {
    if (s.isGift === 'true') s.isGift = true;
    else if (s.isGift === 'false' || s.isGift === '') delete s.isGift;
    return s;
  });
}

async function sheetsPush(url, stocks) {
  const clean = stocks.map(s => {
    const o = {};
    SYNC_FIELDS.forEach(k => { if (s[k] !== undefined && s[k] !== null) o[k] = s[k]; });
    return o;
  });
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain' },
    body: JSON.stringify({ stocks: clean }),
    redirect: 'follow',
  });
  const data = await res.json();
  if (data.error) throw new Error(data.error);
  return data;
}

function mergeStocks(local, remote) {
  const merged = [...local];
  const localIds = new Set(local.map(s => s.id));
  remote.forEach(rs => {
    if (!localIds.has(rs.id)) merged.push(rs);
  });
  return merged;
}

const is18 = t => t === '18';
const tempLabel = t => ({ '25inc': '25°C Inc', '25room': '25°C Room', '18': '18°C', 'RT': 'RT', '25': '25°C' }[t] || t);
const tempFull = t => ({ '25inc': '25°C Incubator', '25room': '25°C Room', '18': '18°C Room', 'RT': 'Room Temp' }[t] || t);

const TEMPS = ['25inc', '25room', '18', 'RT'];
const DEFAULT_CATS = ['Lab Stocks', 'Flo Stocks 1', 'Flo Stocks 2', 'No Collection'];
const USERS = ['Flo', 'Bella', 'Seba', 'Catherine', 'Tomke', 'Shahar', 'Myrto'];
const STOCK_SOURCES = ['Bloomington', 'VDRC', 'Kyoto', 'Other'];
function stockUrl(source, stockId) {
  if (!source || !stockId) return null;
  const id = stockId.replace(/\D/g, '');
  if (source === 'Bloomington') return `https://bdsc.indiana.edu/Home/Search?presearch=${id}`;
  if (source === 'VDRC') return `https://stockcenter.vdrc.at/control/product/~VIEW_INDEX=0/~VIEW_SIZE=100/~product_id=${id}`;
  if (source === 'Kyoto') return `https://kyotofly.kit.jp/cgi-bin/stocks/search_res_det.cgi?DB_NUM=1&DG_NUM=${id}`;
  return null;
}
function parseFlyBase(input) {
  if (!input) return null;
  const trimmed = input.trim();
  const urlMatch = trimmed.match(/flybase\.org\/reports\/(FB\w+)/i);
  if (urlMatch) return urlMatch[1];
  if (/^FB\w+$/i.test(trimmed)) return trimmed;
  return trimmed;
}
function flybaseUrl(fbId) {
  if (!fbId) return null;
  const id = parseFlyBase(fbId);
  return id ? `https://flybase.org/reports/${id}` : null;
}
const STOCK_VARIANTS = ['stock', 'expanded'];

// Flip schedules: expanded always 25°C → 7d; stock varies by temp
function getFlipDays(s) {
  if ((s.variant || 'stock') === 'expanded') return 7;
  if (is18(s.location)) return 42;
  if (s.location === 'RT') return 28;
  return 14; // 25°C variants
}

function calcTL(setup, temp) {
  if (is18(temp)) return { virginStart: addDays(setup, 17), virginEnd: addDays(setup, 19), progenyStart: addDays(setup, 19), progenyEnd: addDays(setup, 23) };
  return { virginStart: addDays(setup, 9), virginEnd: addDays(setup, 11), progenyStart: addDays(setup, 11), progenyEnd: addDays(setup, 15) };
}
function getTL(c) {
  return calcTL(c.setupDate, c.temperature);
}

const STATUSES = ['set up', 'waiting for virgins', 'collecting virgins', 'waiting for progeny', 'collecting progeny', 'screening', 'ripening', 'done'];
const STATUS_SHORT = ['set', 'w.vgn', 'vgn', 'w.prg', 'coll', 'scr', 'ripe', 'done'];
const nextSt = s => { const i = STATUSES.indexOf(s); return i < STATUSES.length - 1 ? STATUSES[i + 1] : s; };
const stIdx = s => STATUSES.indexOf(s);

const OPTO = ['cschrimson', 'chrimson', 'chr2', 'reachr', 'chrmine', 'chronos', 'cochr', 'gtacr'];
const CALC = ['gcamp', 'jgcamp', 'rgeco', 'rcamp'];
function detect(g) { if (!g) return { o: false, c: false }; const l = g.toLowerCase(); return { o: OPTO.some(k => l.includes(k)), c: CALC.some(k => l.includes(k)) }; }
function crossDetect(c, stocks) {
  const a = detect(stocks.find(s => s.id === c.parentA)?.genotype);
  const b = detect(stocks.find(s => s.id === c.parentB)?.genotype);
  return { o: a.o || b.o, c: a.c || b.c };
}

// Deduce screening markers from parent genotypes
const BALANCER_MARKERS = [
  { pattern: /CyO/i, name: 'CyO', phenotype: 'Curly wings', select: 'non-Curly', chromosome: '2nd' },
  { pattern: /TM3/i, name: 'TM3', phenotype: 'Stubble bristles (short)', select: 'non-Stubble', chromosome: '3rd' },
  { pattern: /TM6B/i, name: 'TM6B', phenotype: 'Tubby (short fat larva/pupa) + Humeral', select: 'non-Tubby', chromosome: '3rd' },
  { pattern: /TM6/i, name: 'TM6', phenotype: 'Tubby', select: 'non-Tubby', chromosome: '3rd' },
  { pattern: /FM7/i, name: 'FM7', phenotype: 'Bar eyes (narrow)', select: 'non-Bar', chromosome: 'X' },
  { pattern: /Tb\b/i, name: 'Tb', phenotype: 'Tubby body', select: 'non-Tubby', chromosome: '' },
  { pattern: /Hu\b/i, name: 'Hu', phenotype: 'Humeral (extra bristles on humeri)', select: 'non-Humeral', chromosome: '' },
  { pattern: /Sb\b/i, name: 'Sb', phenotype: 'Stubble (short bristles)', select: 'non-Stubble', chromosome: '' },
  { pattern: /Ser\b/i, name: 'Ser', phenotype: 'Serrate wings', select: 'non-Serrate', chromosome: '' },
  { pattern: /\bw\[/i, name: 'w-', phenotype: 'White eyes', select: 'white-eyed (no mini-white)', chromosome: 'X' },
  { pattern: /\bw\+/i, name: 'w+', phenotype: 'Red/orange eyes (mini-white)', select: 'red/orange-eyed', chromosome: 'X' },
  { pattern: /GFP/i, name: 'GFP', phenotype: 'Green fluorescence', select: 'GFP-positive', chromosome: '' },
  { pattern: /DsRed|RFP|tdTomato/i, name: 'RFP', phenotype: 'Red fluorescence', select: 'RFP-positive', chromosome: '' },
];

function getScreeningGuide(cross, stocks) {
  const gA = stocks.find(s => s.id === cross.parentA)?.genotype || '';
  const gB = stocks.find(s => s.id === cross.parentB)?.genotype || '';
  const combined = gA + ' ; ' + gB;
  const found = [];
  const seen = new Set();
  BALANCER_MARKERS.forEach(m => {
    if (m.pattern.test(combined) && !seen.has(m.name)) {
      seen.add(m.name);
      const inA = m.pattern.test(gA);
      const inB = m.pattern.test(gB);
      found.push({ ...m, source: inA && inB ? 'both' : inA ? 'virgin' : 'male' });
    }
  });
  return found;
}

function useLS(key, init) {
  const [v, setV] = useState(() => { try { const s = localStorage.getItem(key); return s ? JSON.parse(s) : init; } catch { return init; } });
  const prevKey = useRef(key);
  useEffect(() => {
    if (prevKey.current !== key) {
      try { const s = localStorage.getItem(key); setV(s ? JSON.parse(s) : init); } catch { setV(init); }
      prevKey.current = key;
    }
  }, [key]);
  useEffect(() => { try { localStorage.setItem(key, JSON.stringify(v)); } catch {} }, [key, v]);
  return [v, setV];
}

function sn(stocks, id) { return stocks.find(s => s.id === id)?.name || '??'; }
function sg(stocks, id) { return stocks.find(s => s.id === id)?.genotype || ''; }
function cl(c, S) { return `${sn(S, c.parentA)} × ${sn(S, c.parentB)}`; }
function clFull(c, S) { return { virgin: sn(S, c.parentA), male: sn(S, c.parentB) }; }

/* ========== ICS EXPORT ========== */
function dlICS(events, name) {
  const f = d => d.replace(/-/g, '');
  let s = 'BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//Flomington//EN\r\nCALSCALE:GREGORIAN\r\n';
  events.forEach(e => {
    s += `BEGIN:VEVENT\r\nDTSTART;VALUE=DATE:${f(e.date)}\r\nDTEND;VALUE=DATE:${f(addDays(e.date, 1))}\r\nSUMMARY:${(e.title || '').replace(/[\\;,\n]/g, ' ')}\r\nDESCRIPTION:${(e.desc || '').replace(/[\\;,\n]/g, ' ')}\r\nUID:${uid()}@flomington\r\nEND:VEVENT\r\n`;
  });
  s += 'END:VCALENDAR\r\n';
  const b = new Blob([s], { type: 'text/calendar' }); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = name; a.click(); URL.revokeObjectURL(u);
}

/* ========== DEMO DATA ========== */
function makeDemoData() {
  const t = today();

  // ════════════════════════════════════════════════════════════════════
  // STOCKS — 24 entries
  // Coverage matrix:
  //   Temps:        25inc (8), 25room (4), 18 (7), RT (5)
  //   Variants:     expanded (7), stock (17)
  //   Collections:  Lab Stocks (7), Flo Stocks 1 (6), Flo Stocks 2 (5), No Collection (4), Opto Tools (2)
  //   Sources:      Bloomington (5), VDRC (3), Kyoto (2), Other (1), gift-only (3), none (10)
  //   Maintainers:  Flo (4), Bella (3), Seba (3), Catherine (3), Tomke (3), Shahar (3), Myrto (3), none (2)
  //   Flip status:  overdue 100%+ (4), near 80-99% (4), mid 40-79% (6), fresh <40% (8), exact threshold (2)
  //   Opto:         CsChrimson (2), Chrimson (1), ReaChR (1), GtACR (1)
  //   Imaging:      GCaMP/jGCaMP (3), RCaMP (1)
  //   FlyBase IDs:  6 stocks with, 18 without
  // ════════════════════════════════════════════════════════════════════
  const stocks = [
    // ── EXPANDED VARIANTS (7) ──────────────────────────────────────────
    // s1: Expanded, 25inc, Lab Stocks, OVERDUE (10d of 7d → 143%)
    //     Flo, Bloomington + FlyBase
    { id: 's1', name: 'Oregon-R', genotype: '+', location: '25inc',
      createdAt: addDays(t, -60), lastFlipped: addDays(t, -10),
      notes: 'Wild type reference strain — expanded, overdue for flip',
      variant: 'expanded', category: 'Lab Stocks', maintainer: 'Flo',
      source: 'Bloomington', sourceId: '25211', flybaseId: 'FBst0025211' },
    // s2: Expanded, 25room, No Collection, recently flipped (3d of 7d → 43%)
    //     Bella, no source
    { id: 's2', name: 'w1118', genotype: 'w[1118]', location: '25room',
      createdAt: addDays(t, -45), lastFlipped: addDays(t, -3),
      notes: 'White-eyed host — expanded, recently flipped',
      variant: 'expanded', category: 'No Collection', maintainer: 'Bella' },
    // s3: Expanded, RT, Flo Stocks 2, near flip (6d of 7d → 86%)
    //     Catherine, Kyoto source
    { id: 's3', name: 'Canton-S', genotype: '+', location: 'RT',
      createdAt: addDays(t, -120), lastFlipped: addDays(t, -6),
      notes: 'Wild type, good for behaviour — expanded at RT',
      variant: 'expanded', category: 'Flo Stocks 2', maintainer: 'Shahar',
      source: 'Kyoto', sourceId: '105666' },
    // s4e: Expanded, 18C, Lab Stocks, fresh (1d of 7d → 14%)
    //     Seba, Bloomington + FlyBase
    { id: 's4e', name: 'yw (expanded)', genotype: 'y[1] w[1]', location: '18',
      createdAt: addDays(t, -30), lastFlipped: addDays(t, -1),
      notes: 'Yellow-white host line — expanded backup at 18C, just flipped',
      variant: 'expanded', category: 'Lab Stocks', maintainer: 'Flo',
      source: 'Bloomington', sourceId: '1495', flybaseId: 'FBst0001495' },
    // s24: Expanded, 25inc, Flo Stocks 1, mid (4d of 7d → 57%)
    //     Tomke, no source
    { id: 's24', name: 'w[*] (expanded)', genotype: 'w[*]', location: '25inc',
      createdAt: addDays(t, -80), lastFlipped: addDays(t, -4),
      notes: 'White-star host for injections — expanded',
      variant: 'expanded', category: 'Flo Stocks 1', maintainer: 'Flo' },
    // s25: Expanded, RT, No Collection, OVERDUE (9d of 7d → 129%)
    //     Myrto, no source
    { id: 's25', name: 'Berlin-K', genotype: '+', location: 'RT',
      createdAt: addDays(t, -90), lastFlipped: addDays(t, -9),
      notes: 'Wild type Berlin strain — expanded at RT, overdue',
      variant: 'expanded', category: 'No Collection', maintainer: 'Myrto' },
    // s26: Expanded, 25room, Flo Stocks 2, exact threshold (7d of 7d → 100%)
    //     Shahar, gift from Dickson Lab
    { id: 's26', name: 'Iso31 (expanded)', genotype: 'w[1118] iso31', location: '25room',
      createdAt: addDays(t, -40), lastFlipped: addDays(t, -7),
      notes: 'Isogenic w1118 — expanded, exactly at flip threshold',
      variant: 'expanded', category: 'Flo Stocks 2', maintainer: 'Shahar',
      isGift: true, giftFrom: 'Dickson Lab' },

    // ── OPTO STOCKS (5) ────────────────────────────────────────────────
    // s4: Stock, 18C, Lab Stocks, OVERDUE (50d of 42d → 119%)
    //     Flo, Bloomington + FlyBase, CsChrimson
    { id: 's4', name: 'UAS-CsChrimson', genotype: 'w[*]; P{20XUAS-IVS-CsChrimson.mVenus}attP18',
      location: '18', createdAt: addDays(t, -90), lastFlipped: addDays(t, -50),
      notes: 'Channelrhodopsin for optogenetics — overdue at 18C',
      variant: 'stock', category: 'Lab Stocks', maintainer: 'Flo',
      source: 'Bloomington', sourceId: '79039', flybaseId: 'FBst0079039' },
    // s5: Stock, 25inc, Lab Stocks, fresh (2d of 14d → 14%)
    //     Seba, no source, CsChrimson split-GAL4
    { id: 's5', name: 'R58E02-AD; R40F04-DBD > CsChrimson',
      genotype: 'w[*]; P{R58E02-p65.AD}attP40/CyO; P{R40F04-GAL4.DBD}attP2/P{20XUAS-CsChrimson.mVenus}attP18',
      location: '25inc', createdAt: addDays(t, -20), lastFlipped: addDays(t, -2),
      notes: 'Split-GAL4 CsChrimson line for optogenetics',
      variant: 'stock', category: 'Lab Stocks', maintainer: 'Flo' },
    // s6: Stock, 25inc, Flo Stocks 2, near flip (13d of 14d → 93%)
    //     Tomke, no source, CsChrimson MBON split
    { id: 's6', name: 'MB298B > CsChrimson',
      genotype: 'w[*]; P{R19F09-p65.AD}attP40/P{20XUAS-CsChrimson.mVenus}su(Hw)attP5; P{R25D01-GAL4.DBD}attP2',
      location: '25inc', createdAt: addDays(t, -15), lastFlipped: addDays(t, -13),
      notes: 'MBON split for opto, near flip threshold',
      variant: 'stock', category: 'Flo Stocks 2', maintainer: 'Shahar' },
    // s7: Stock, 25inc, Lab Stocks, mid (8d of 14d → 57%), gift from Bhatt Lab
    //     Shahar, GtACR1 (OPTO detect)
    { id: 's7', name: 'UAS-GtACR1',
      genotype: 'w[*]; P{20XUAS-GtACR1-EYFP}attP2',
      location: '25inc', createdAt: addDays(t, -25), lastFlipped: addDays(t, -8),
      notes: 'Anion channelrhodopsin for silencing — gift from Bhatt Lab',
      variant: 'stock', category: 'Lab Stocks', maintainer: 'Flo',
      isGift: true, giftFrom: 'Bhatt Lab', flybaseId: 'FBtp0131990' },
    // s17: Stock, 18C, Opto Tools, fresh (5d of 42d → 12%)
    //     Bella, Bloomington, ReaChR (OPTO detect)
    { id: 's17', name: 'UAS-ReaChR',
      genotype: 'w[*]; P{20XUAS-IVS-ReaChR}attP2',
      location: '18', createdAt: addDays(t, -60), lastFlipped: addDays(t, -5),
      notes: 'Red-shifted channelrhodopsin for deep-tissue opto',
      variant: 'stock', category: 'Opto Tools', maintainer: 'Bella',
      source: 'Bloomington', sourceId: '53741', flybaseId: 'FBst0053741' },
    // s18: Stock, RT, Opto Tools, near (24d of 28d → 86%)
    //     Catherine, gift from Jayaraman Lab, Chrimson (OPTO detect — distinct from CsChrimson)
    { id: 's18', name: 'UAS-Chrimson',
      genotype: 'w[*]; P{20XUAS-IVS-Chrimson.mVenus}attP18',
      location: 'RT', createdAt: addDays(t, -70), lastFlipped: addDays(t, -24),
      notes: 'Chrimson (non-Cs variant) for opto — gift from Jayaraman Lab',
      variant: 'stock', category: 'Opto Tools', maintainer: 'Bella',
      isGift: true, giftFrom: 'Jayaraman Lab' },

    // ── CALCIUM / IMAGING STOCKS (4) ───────────────────────────────────
    // s8: Stock, 18C, Lab Stocks, near (38d of 42d → 90%), gift from Jefferis Lab
    //     Flo, jGCaMP7f (CALC detect)
    { id: 's8', name: 'UAS-jGCaMP7f',
      genotype: 'w[*]; P{20XUAS-jGCaMP7f}VK5',
      location: '18', createdAt: addDays(t, -30), lastFlipped: addDays(t, -38),
      notes: 'Fast calcium indicator — gift from Jefferis Lab',
      variant: 'stock', category: 'Lab Stocks', maintainer: 'Flo',
      isGift: true, giftFrom: 'Jefferis Lab' },
    // s9: Stock, 25inc, Flo Stocks 1, mid (5d of 14d → 36%)
    //     Myrto, no source, jGCaMP8m MBON split (CALC detect)
    { id: 's9', name: 'MBON-a1 > GCaMP8m',
      genotype: 'w[*]; P{R12G04-p65.AD}attP40/P{20XUAS-jGCaMP8m}attP40; P{VT060727-GAL4.DBD}attP2',
      location: '25inc', createdAt: addDays(t, -35), lastFlipped: addDays(t, -5),
      notes: 'MBON split-GAL4 with GCaMP8m for 2P imaging',
      variant: 'stock', category: 'Flo Stocks 1', maintainer: 'Flo' },
    // s10: Stock, 18C, Flo Stocks 1, mid (14d of 42d → 33%)
    //     Flo, VDRC, RCaMP (CALC detect)
    { id: 's10', name: 'UAS-RCaMP1.07',
      genotype: 'w[*]; P{UAS-RCaMP1.07}2',
      location: '18', createdAt: addDays(t, -55), lastFlipped: addDays(t, -14),
      notes: 'Red calcium indicator for dual-color imaging — from VDRC',
      variant: 'stock', category: 'Flo Stocks 1', maintainer: 'Flo',
      source: 'VDRC', sourceId: '330328' },
    // s19: Stock, 25room, Flo Stocks 1, fresh (2d of 14d → 14%)
    //     Myrto, no source, GCaMP6s (CALC detect)
    { id: 's19', name: 'UAS-GCaMP6s',
      genotype: 'w[*]; P{20XUAS-IVS-GCaMP6s}attP40',
      location: '25room', createdAt: addDays(t, -50), lastFlipped: addDays(t, -2),
      notes: 'Slow GCaMP6s for sustained calcium signals',
      variant: 'stock', category: 'Flo Stocks 1', maintainer: 'Flo' },

    // ── DRIVER & REPORTER STOCKS (8) ───────────────────────────────────
    // s11: Stock, 25inc, Flo Stocks 1, near (11d of 14d → 79%)
    //     Flo, Bloomington + FlyBase, balanced 2nd
    { id: 's11', name: 'elav-GAL4',
      genotype: 'P{GAL4-elav.L}2/CyO',
      location: '25inc', createdAt: addDays(t, -90), lastFlipped: addDays(t, -11),
      notes: 'Pan-neuronal driver — near flip threshold',
      variant: 'stock', category: 'Flo Stocks 1', maintainer: 'Flo',
      source: 'Bloomington', sourceId: '8765', flybaseId: 'FBst0008765' },
    // s12: Stock, 25room, No Collection, mid (10d of 14d → 71%)
    //     Catherine, no source
    { id: 's12', name: 'GMR-GAL4',
      genotype: 'P{GAL4-ninaE.GMR}12',
      location: '25room', createdAt: addDays(t, -90), lastFlipped: addDays(t, -10),
      notes: 'Eye-specific driver — No Collection category',
      variant: 'stock', category: 'No Collection', maintainer: 'Catherine' },
    // s13: Stock, 18C, Lab Stocks, fresh (4d of 42d → 10%)
    //     Seba, Bloomington + FlyBase, balanced 3rd (TM3/TM6B)
    { id: 's13', name: 'UAS-mCD8::GFP',
      genotype: 'w[*]; P{UAS-mCD8.GFP}LL5; TM3,Sb[1]/TM6B,Tb[1]',
      location: '18', createdAt: addDays(t, -50), lastFlipped: addDays(t, -4),
      notes: 'Membrane GFP, balanced 3rd — from Bloomington',
      variant: 'stock', category: 'Lab Stocks', maintainer: 'Flo',
      source: 'Bloomington', sourceId: '5130', flybaseId: 'FBst0005130' },
    // s14: Stock, 25inc, Flo Stocks 1, mid (7d of 14d → 50%)
    //     Tomke, VDRC
    { id: 's14', name: 'TH-GAL4 (VDRC)',
      genotype: 'P{GAL4-TH.D}D',
      location: '25inc', createdAt: addDays(t, -40), lastFlipped: addDays(t, -7),
      notes: 'Dopaminergic driver — from VDRC',
      variant: 'stock', category: 'Flo Stocks 1', maintainer: 'Flo',
      source: 'VDRC', sourceId: '108170' },
    // s15: Stock, RT, Flo Stocks 2, OVERDUE (30d of 28d → 107%)
    //     Shahar, Other source, gift from Rubin Lab
    { id: 's15', name: 'MB247-DsRed',
      genotype: 'w[*]; P{MB247-DsRed}1',
      location: 'RT', createdAt: addDays(t, -100), lastFlipped: addDays(t, -30),
      notes: 'Mushroom body reporter — gift from Rubin Lab, overdue at RT',
      variant: 'stock', category: 'Flo Stocks 2', maintainer: 'Shahar',
      source: 'Other', sourceId: '', isGift: true, giftFrom: 'Rubin Lab' },
    // s16: Stock, 25inc, Lab Stocks, exact threshold (14d of 14d → 100%)
    //     NO MAINTAINER, Kyoto + FlyBase
    { id: 's16', name: 'nSyb-GAL4',
      genotype: 'w[*]; P{nSyb-GAL4.S}3',
      location: '25inc', createdAt: addDays(t, -70), lastFlipped: addDays(t, -14),
      notes: 'Pan-neuronal driver (nSynaptobrevin) — exactly at flip day, unclaimed',
      variant: 'stock', category: 'Lab Stocks', maintainer: 'Flo',
      source: 'Kyoto', sourceId: '200228', flybaseId: 'FBst0500064' },
    // s20: Stock, RT, Flo Stocks 2, mid (15d of 28d → 54%)
    //     Tomke, VDRC, mushroom body driver
    { id: 's20', name: 'VT30559-GAL4',
      genotype: 'w[1118]; P{VT030559-GAL4.DBD}attP2',
      location: 'RT', createdAt: addDays(t, -65), lastFlipped: addDays(t, -15),
      notes: 'KC driver for mushroom body experiments',
      variant: 'stock', category: 'Flo Stocks 2', maintainer: 'Shahar',
      source: 'VDRC', sourceId: '200228' },
    // s21: Stock, 25room, No Collection, fresh (1d of 14d → 7%)
    //     NO MAINTAINER, no source — new arrival, not yet assigned
    { id: 's21', name: 'Repo-GAL4',
      genotype: 'w[*]; P{GAL4-repo}1/TM3,Sb[1]',
      location: '25room', createdAt: addDays(t, -1), lastFlipped: addDays(t, -1),
      notes: 'Glial driver — just arrived, needs assignment',
      variant: 'stock', category: 'No Collection' },
    // s22: Stock, 18C, Flo Stocks 2, OVERDUE (48d of 42d → 114%)
    //     Shahar, no source
    { id: 's22', name: 'OR-R (stock)',
      genotype: '+',
      location: '18', createdAt: addDays(t, -110), lastFlipped: addDays(t, -48),
      notes: 'Oregon-R stock backup at 18C — overdue',
      variant: 'stock', category: 'Flo Stocks 2', maintainer: 'Shahar' },
    // s23: Stock, RT, Flo Stocks 1, mid (12d of 28d → 43%)
    //     Seba, Kyoto source
    { id: 's23', name: 'fruP1-GAL4',
      genotype: 'w[*]; P{fruP1-GAL4}1',
      location: 'RT', createdAt: addDays(t, -45), lastFlipped: addDays(t, -12),
      notes: 'Fruitless driver for courtship circuits',
      variant: 'stock', category: 'Flo Stocks 1', maintainer: 'Flo',
      source: 'Kyoto', sourceId: '108522' },
  ];

  // ════════════════════════════════════════════════════════════════════
  // CROSSES — 20 entries
  // Coverage matrix:
  //   Statuses:     set up (2), waiting for virgins (2), collecting virgins (3),
  //                 waiting for progeny (2), collecting progeny (2), ripening (3),
  //                 screening (2), done (4)
  //   Temps:        25inc (12), 25room (3), 18 (4), RT (1)
  //   Opto ripening (3d): c6 (ripening), c13 (ripening, near done)
  //   GCaMP ripening (5d): c14 (ripening, mid)
  //   Skip ripening (no opto/calc): c4 (waiting for progeny), c8 (done), c15 (collecting progeny)
  //   Experiment types: optogenetics (5), 2p (4), 2p+vr (2), behavior (3),
  //                     flydisco (2), vr (1), dissection (1), other (1), none (1)
  //   Cross types:  simple (18), sequential (2)
  //   Owners:       Flo (3), Bella (3), Seba (3), Catherine (3), Tomke (2),
  //                 Shahar (3), Myrto (3)
  // ════════════════════════════════════════════════════════════════════
  const crosses = [
    // ── STATUS: 'set up' (2) ───────────────────────────────────────────
    // c1: set up, opto, 25inc, Flo
    //     elav-GAL4 (s11) x UAS-CsChrimson (s4)
    { id: 'c1', parentA: 's11', parentB: 's4', temperature: '25inc',
      setupDate: addDays(t, -3), status: 'set up', owner: 'Flo',
      notes: 'elav > CsChrimson for optogenetics behavior assay',
      targetCount: 30, collected: [], vials: [],
      manualFlipDate: '', manualEcloseDate: '', manualVirginDate: '',
      crossType: 'simple', parentCrossId: '',
      experimentType: 'optogenetics', experimentDate: addDays(t, 15),
      retinalStartDate: '' },
    // c9: set up, 2p+vr, 18C, Myrto
    //     MBON GCaMP (s9) x UAS-mCD8::GFP (s13), slow timeline
    { id: 'c9', parentA: 's9', parentB: 's13', temperature: '18',
      setupDate: addDays(t, -5), status: 'set up', owner: 'Myrto',
      notes: 'GCaMP imaging with VR at 18C — slow timeline',
      targetCount: 15, collected: [], vials: [],
      manualFlipDate: '', manualEcloseDate: '', manualVirginDate: '',
      crossType: 'simple', parentCrossId: '',
      experimentType: '2p+vr', experimentDate: '',
      retinalStartDate: '' },

    // ── STATUS: 'waiting for virgins' (2) ──────────────────────────────
    // c2: waiting for virgins, opto, 25inc, Seba, near auto-promote (8d of 9d)
    //     R58E02 CsChrimson (s5) x Canton-S (s3)
    { id: 'c2', parentA: 's5', parentB: 's3', temperature: '25inc',
      setupDate: addDays(t, -8), status: 'waiting for virgins', owner: 'Seba',
      notes: 'Opto cross — near auto-promote threshold',
      targetCount: 25, collected: [], vials: [],
      manualFlipDate: '', manualEcloseDate: '', manualVirginDate: '',
      crossType: 'simple', parentCrossId: '',
      experimentType: 'optogenetics', experimentDate: addDays(t, 10),
      retinalStartDate: addDays(t, -3) },
    // c13w: waiting for virgins, dissection, 18C, Bella, early (3d of 17d)
    //       TH-GAL4 (s14) x UAS-mCD8::GFP (s13)
    { id: 'c13w', parentA: 's14', parentB: 's13', temperature: '18',
      setupDate: addDays(t, -3), status: 'waiting for virgins', owner: 'Bella',
      notes: 'TH-GAL4 x GFP for dopaminergic neuron dissection at 18C',
      targetCount: 10, collected: [], vials: [],
      manualFlipDate: '', manualEcloseDate: '', manualVirginDate: '',
      crossType: 'simple', parentCrossId: '',
      experimentType: 'dissection', experimentDate: addDays(t, 30),
      retinalStartDate: '' },

    // ── STATUS: 'collecting virgins' (3) ───────────────────────────────
    // c3: collecting virgins, 2p, 25inc, Myrto, partial (5 of 5)
    //     MBON GCaMP (s9) x UAS-jGCaMP7f (s8)
    { id: 'c3', parentA: 's9', parentB: 's8', temperature: '25inc',
      setupDate: addDays(t, -10), status: 'collecting virgins', owner: 'Myrto',
      notes: 'GCaMP imaging cross — collecting virgins now',
      targetCount: 20, collected: [], vials: [],
      virginsCollected: 5,
      manualFlipDate: '', manualEcloseDate: '', manualVirginDate: '',
      crossType: 'simple', parentCrossId: '',
      experimentType: '2p', experimentDate: addDays(t, 5),
      retinalStartDate: '' },
    // c10: collecting virgins, opto, 25inc, Seba, partial (3 of 5)
    //      UAS-CsChrimson (s4) x TH-GAL4 (s14)
    { id: 'c10', parentA: 's4', parentB: 's14', temperature: '25inc',
      setupDate: addDays(t, -10), status: 'collecting virgins', owner: 'Seba',
      notes: 'CsChrimson x TH — partially collected virgins',
      targetCount: 20, collected: [], vials: [],
      virginsCollected: 3,
      manualFlipDate: '', manualEcloseDate: '', manualVirginDate: '',
      crossType: 'simple', parentCrossId: '',
      experimentType: 'optogenetics', experimentDate: addDays(t, 8),
      retinalStartDate: addDays(t, -5) },
    // c16: collecting virgins, flydisco, 25room, Catherine, just started (0 of 5)
    //      VT30559-GAL4 (s20) x UAS-CsChrimson (s4)
    { id: 'c16', parentA: 's20', parentB: 's4', temperature: '25room',
      setupDate: addDays(t, -10), status: 'collecting virgins', owner: 'Catherine',
      notes: 'FlyDisco arena cross — just started collecting',
      targetCount: 20, collected: [], vials: [],
      virginsCollected: 0,
      manualFlipDate: '', manualEcloseDate: '', manualVirginDate: '',
      crossType: 'simple', parentCrossId: '',
      experimentType: 'flydisco', experimentDate: addDays(t, 12),
      retinalStartDate: '' },

    // ── STATUS: 'waiting for progeny' (2) ──────────────────────────────
    // c4: waiting for progeny, no experiment type, 25inc, Catherine
    //     GMR-GAL4 (s12) x UAS-mCD8::GFP (s13) — skip-ripening (no opto/calc)
    { id: 'c4', parentA: 's12', parentB: 's13', temperature: '25inc',
      setupDate: addDays(t, -14), status: 'waiting for progeny', owner: 'Catherine',
      waitStartDate: addDays(t, -4),
      notes: 'Eye expression test — waiting for progeny to emerge (will skip ripening)',
      targetCount: 40, collected: [], vials: [],
      manualFlipDate: '', manualEcloseDate: '', manualVirginDate: '',
      crossType: 'simple', parentCrossId: '',
      experimentType: '', experimentDate: '', retinalStartDate: '' },
    // c11: waiting for progeny, 2p, 18C, Flo, slow timeline
    //      UAS-jGCaMP7f (s8) x UAS-CsChrimson (s4) — dual opto+calc
    { id: 'c11', parentA: 's8', parentB: 's4', temperature: '18',
      setupDate: addDays(t, -22), status: 'waiting for progeny', owner: 'Flo',
      waitStartDate: addDays(t, -3),
      notes: 'GCaMP x CsChrimson at 18C — slow progeny timeline',
      targetCount: 25, collected: [], vials: [],
      manualFlipDate: '', manualEcloseDate: '', manualVirginDate: '',
      crossType: 'simple', parentCrossId: '',
      experimentType: '2p', experimentDate: addDays(t, 14),
      retinalStartDate: '' },

    // ── STATUS: 'collecting progeny' (2) ───────────────────────────────
    // c5: collecting progeny, 2p, 25inc, Flo, with collected + vials
    //     elav-GAL4 (s11) x UAS-jGCaMP7f (s8)
    { id: 'c5', parentA: 's11', parentB: 's8', temperature: '25inc',
      setupDate: addDays(t, -18), status: 'collecting progeny', owner: 'Flo',
      waitStartDate: addDays(t, -9),
      notes: 'Neuronal GCaMP cross — collecting progeny now',
      targetCount: 50,
      collected: [
        { date: addDays(t, -3), count: 8 },
        { date: addDays(t, -2), count: 12 },
        { date: addDays(t, -1), count: 6 }
      ],
      vials: [
        { id: 'v1', setupDate: addDays(t, -16), notes: 'Re-vial 1' },
        { id: 'v2', setupDate: addDays(t, -13), notes: 'Re-vial 2' }
      ],
      manualFlipDate: '', manualEcloseDate: '', manualVirginDate: '',
      crossType: 'simple', parentCrossId: '',
      experimentType: '2p', experimentDate: addDays(t, 3),
      retinalStartDate: '' },
    // c15: collecting progeny, behavior (no opto/calc → will skip ripening), 25room, Shahar
    //      Canton-S (s3) x w1118 (s2) — control cross, recently started collecting
    { id: 'c15', parentA: 's3', parentB: 's2', temperature: '25room',
      setupDate: addDays(t, -16), status: 'collecting progeny', owner: 'Shahar',
      waitStartDate: addDays(t, -7),
      notes: 'Wild type control for behaviour — no opto/calc, will skip ripening',
      targetCount: 30,
      collected: [
        { date: addDays(t, -1), count: 5 },
        { date: addDays(t, 0), count: 7 }
      ],
      vials: [],
      manualFlipDate: '', manualEcloseDate: '', manualVirginDate: '',
      crossType: 'simple', parentCrossId: '',
      experimentType: 'behavior', experimentDate: addDays(t, 5),
      retinalStartDate: '' },

    // ── STATUS: 'ripening' (3) — opto 3d, imaging 5d, and dual ────────
    // c6: ripening, opto (CsChrimson → 3d), 25inc, Tomke
    //     TH-GAL4 (s14) x MB298B > CsChrimson (s6), 2d in → 1d remaining
    { id: 'c6', parentA: 's14', parentB: 's6', temperature: '25inc',
      setupDate: addDays(t, -22), status: 'ripening', owner: 'Tomke',
      waitStartDate: addDays(t, -12),
      ripeningStartDate: addDays(t, -2),
      notes: 'TH > CsChrimson — ripening before opto experiment (3d retinal)',
      targetCount: 30,
      collected: [
        { date: addDays(t, -5), count: 10 },
        { date: addDays(t, -4), count: 9 },
        { date: addDays(t, -3), count: 11 }
      ],
      vials: [],
      manualFlipDate: '', manualEcloseDate: '', manualVirginDate: '',
      crossType: 'simple', parentCrossId: '',
      experimentType: 'optogenetics', experimentDate: addDays(t, 2),
      retinalStartDate: addDays(t, -8) },
    // c13: ripening, opto (ReaChR → 3d), 25inc, Shahar, exactly at 3d → ready
    //      UAS-ReaChR (s17) x nSyb-GAL4 (s16)
    { id: 'c13', parentA: 's17', parentB: 's16', temperature: '25inc',
      setupDate: addDays(t, -24), status: 'ripening', owner: 'Shahar',
      waitStartDate: addDays(t, -14),
      ripeningStartDate: addDays(t, -3),
      notes: 'nSyb > ReaChR — ripening complete, ready to screen',
      targetCount: 25,
      collected: [
        { date: addDays(t, -7), count: 8 },
        { date: addDays(t, -6), count: 10 },
        { date: addDays(t, -5), count: 7 }
      ],
      vials: [{ id: 'v4', setupDate: addDays(t, -22), notes: 'Re-vial 1' }],
      manualFlipDate: '', manualEcloseDate: '', manualVirginDate: '',
      crossType: 'simple', parentCrossId: '',
      experimentType: 'optogenetics', experimentDate: addDays(t, 1),
      retinalStartDate: addDays(t, -10) },
    // c14: ripening, imaging (GCaMP → 5d), 18C, Myrto, 2d in → 3d remaining
    //      UAS-GCaMP6s (s19) x elav-GAL4 (s11)
    { id: 'c14', parentA: 's19', parentB: 's11', temperature: '18',
      setupDate: addDays(t, -30), status: 'ripening', owner: 'Myrto',
      waitStartDate: addDays(t, -10),
      ripeningStartDate: addDays(t, -2),
      notes: 'GCaMP6s pan-neuronal — ripening for GCaMP expression (5d)',
      targetCount: 15,
      collected: [
        { date: addDays(t, -4), count: 5 },
        { date: addDays(t, -3), count: 4 },
        { date: addDays(t, -2), count: 6 }
      ],
      vials: [],
      manualFlipDate: '', manualEcloseDate: '', manualVirginDate: '',
      crossType: 'simple', parentCrossId: '',
      experimentType: '2p', experimentDate: addDays(t, 5),
      retinalStartDate: '' },

    // ── STATUS: 'screening' (2) ────────────────────────────────────────
    // c7: screening, opto, 25inc, Bella
    //     UAS-GtACR1 (s7) x nSyb-GAL4 (s16) — GtACR inhibition
    { id: 'c7', parentA: 's7', parentB: 's16', temperature: '25inc',
      setupDate: addDays(t, -25), status: 'screening', owner: 'Bella',
      waitStartDate: addDays(t, -15),
      notes: 'nSyb > GtACR1 silencing — screening for correct genotype',
      targetCount: 30,
      collected: [
        { date: addDays(t, -6), count: 10 },
        { date: addDays(t, -5), count: 8 },
        { date: addDays(t, -4), count: 7 }
      ],
      vials: [],
      manualFlipDate: '', manualEcloseDate: '', manualVirginDate: '',
      crossType: 'simple', parentCrossId: '',
      experimentType: 'optogenetics', experimentDate: addDays(t, 1),
      retinalStartDate: addDays(t, -10) },
    // c17: screening, flydisco (no opto/calc), 25room, Tomke
    //      fruP1-GAL4 (s23) x MB247-DsRed (s15), sequential cross from c8
    { id: 'c17', parentA: 's23', parentB: 's15', temperature: '25room',
      setupDate: addDays(t, -28), status: 'screening', owner: 'Tomke',
      waitStartDate: addDays(t, -18),
      notes: 'F1 courtship screen from initial cross — screening DsRed+ / GAL4+',
      targetCount: 20,
      collected: [
        { date: addDays(t, -9), count: 7 },
        { date: addDays(t, -8), count: 6 },
        { date: addDays(t, -7), count: 7 }
      ],
      vials: [{ id: 'v5', setupDate: addDays(t, -26), notes: 'Re-vial 1' }],
      manualFlipDate: '', manualEcloseDate: '', manualVirginDate: '',
      crossType: 'sequential', parentCrossId: 'c8',
      experimentType: 'flydisco', experimentDate: addDays(t, 3),
      retinalStartDate: '' },

    // ── STATUS: 'done' (4) ─────────────────────────────────────────────
    // c8: done, behavior, 25inc, Bella, control cross
    //     Canton-S (s3) x Oregon-R (s1)
    { id: 'c8', parentA: 's3', parentB: 's1', temperature: '25inc',
      setupDate: addDays(t, -35), status: 'done', owner: 'Bella',
      waitStartDate: addDays(t, -25),
      notes: 'Control cross for behaviour — completed',
      targetCount: 50,
      collected: [
        { date: addDays(t, -20), count: 15 },
        { date: addDays(t, -19), count: 20 },
        { date: addDays(t, -18), count: 15 }
      ],
      vials: [],
      manualFlipDate: '', manualEcloseDate: '', manualVirginDate: '',
      crossType: 'simple', parentCrossId: '',
      experimentType: 'behavior', experimentDate: addDays(t, -15),
      retinalStartDate: '' },
    // c12: done, 2p, 25room, Catherine, with re-vial
    //      UAS-RCaMP (s10) x elav-GAL4 (s11)
    { id: 'c12', parentA: 's10', parentB: 's11', temperature: '25room',
      setupDate: addDays(t, -40), status: 'done', owner: 'Catherine',
      waitStartDate: addDays(t, -30),
      notes: 'RCaMP pan-neuronal imaging — completed',
      targetCount: 35,
      collected: [
        { date: addDays(t, -25), count: 12 },
        { date: addDays(t, -24), count: 14 },
        { date: addDays(t, -23), count: 9 }
      ],
      vials: [{ id: 'v3', setupDate: addDays(t, -38), notes: 'Re-vial 1' }],
      manualFlipDate: '', manualEcloseDate: '', manualVirginDate: '',
      crossType: 'simple', parentCrossId: '',
      experimentType: '2p', experimentDate: addDays(t, -20),
      retinalStartDate: '' },
    // c18: done, vr, 25inc, Seba, completed VR experiment
    //      UAS-Chrimson (s18) x elav-GAL4 (s11)
    { id: 'c18', parentA: 's18', parentB: 's11', temperature: '25inc',
      setupDate: addDays(t, -32), status: 'done', owner: 'Seba',
      waitStartDate: addDays(t, -22),
      notes: 'Chrimson pan-neuronal for VR closed-loop — completed',
      targetCount: 15,
      collected: [
        { date: addDays(t, -15), count: 5 },
        { date: addDays(t, -14), count: 6 },
        { date: addDays(t, -13), count: 4 }
      ],
      vials: [],
      manualFlipDate: '', manualEcloseDate: '', manualVirginDate: '',
      crossType: 'simple', parentCrossId: '',
      experimentType: 'vr', experimentDate: addDays(t, -10),
      retinalStartDate: addDays(t, -18) },
    // c19: done, other, 18C, Catherine, completed custom experiment (sequential)
    //      UAS-mCD8::GFP (s13) x GMR-GAL4 (s12)
    { id: 'c19', parentA: 's13', parentB: 's12', temperature: '18',
      setupDate: addDays(t, -50), status: 'done', owner: 'Catherine',
      waitStartDate: addDays(t, -35),
      notes: 'F1 balanced cross for eye-specific GFP — completed',
      targetCount: 20,
      collected: [
        { date: addDays(t, -28), count: 8 },
        { date: addDays(t, -27), count: 7 },
        { date: addDays(t, -26), count: 5 }
      ],
      vials: [{ id: 'v6', setupDate: addDays(t, -48), notes: 'Re-vial 1' }],
      manualFlipDate: '', manualEcloseDate: '', manualVirginDate: '',
      crossType: 'sequential', parentCrossId: '',
      experimentType: 'other', experimentDate: addDays(t, -22),
      retinalStartDate: '' },

    // ── ADDITIONAL CROSSES for coverage gaps ────────────────────────────
    // c20: waiting for progeny, behavior (no opto/calc), RT, Shahar
    //      Berlin-K (s25) x Canton-S (s3) — wild type cross at RT
    { id: 'c20', parentA: 's25', parentB: 's3', temperature: 'RT',
      setupDate: addDays(t, -12), status: 'waiting for progeny', owner: 'Shahar',
      waitStartDate: addDays(t, -2),
      notes: 'Wild type cross at RT — slow development, no opto/calc',
      targetCount: 20, collected: [], vials: [],
      manualFlipDate: '', manualEcloseDate: '', manualVirginDate: '',
      crossType: 'simple', parentCrossId: '',
      experimentType: 'behavior', experimentDate: addDays(t, 18),
      retinalStartDate: '' },
  ];

  // ════════════════════════════════════════════════════════════════════
  // VIRGIN BANK — entries for various stocks
  // ════════════════════════════════════════════════════════════════════
  const virginBank = {
    's4': 8,   // UAS-CsChrimson — enough banked virgins to auto-skip collecting
    's5': 3,   // R58E02 CsChrimson split — partial bank
    's11': 12, // elav-GAL4 — well stocked
    's9': 5,   // MBON GCaMP — moderate bank
    's8': 2,   // UAS-jGCaMP7f — very low bank
    's17': 6,  // UAS-ReaChR — decent bank
    's3': 4,   // Canton-S — some virgins
    's14': 1,  // TH-GAL4 — minimal bank
  };

  // ════════════════════════════════════════════════════════════════════
  // TRANSFERS — pending requests between users
  // Types: stock (maintainership), cross (ownership), collection (all stocks in cat)
  // ════════════════════════════════════════════════════════════════════
  const transfers = [
    // Flo wants to transfer s16 (nSyb-GAL4, unclaimed) maintainership to Tomke
    { id: 'tx1', from: 'Flo', to: 'Tomke', type: 'stock', itemId: 's16',
      name: 'nSyb-GAL4', status: 'pending', createdAt: addDays(t, -1) },
    // Seba wants to transfer cross c10 ownership to Catherine
    { id: 'tx2', from: 'Seba', to: 'Catherine', type: 'cross', itemId: 'c10',
      name: 'UAS-CsChrimson x TH-GAL4 (VDRC)', status: 'pending', createdAt: addDays(t, -2) },
    // Shahar wants to transfer "Opto Tools" collection to Bella
    { id: 'tx3', from: 'Shahar', to: 'Bella', type: 'collection', collection: 'Opto Tools',
      name: 'Opto Tools', status: 'pending', createdAt: addDays(t, 0) },
    // Myrto accepted Bella's stock transfer (resolved, for testing sentTransfers banner)
    { id: 'tx4', from: 'Bella', to: 'Myrto', type: 'stock', itemId: 's10',
      name: 'UAS-RCaMP1.07', status: 'accepted', createdAt: addDays(t, -3) },
    // Catherine declined Flo's collection transfer (resolved)
    { id: 'tx5', from: 'Flo', to: 'Catherine', type: 'collection', collection: 'Flo Stocks 1',
      name: 'Flo Stocks 1', status: 'declined', createdAt: addDays(t, -4) },
  ];

  // Custom collection that is not in DEFAULT_CATS
  const collections = [...DEFAULT_CATS.slice(0, -1), 'Opto Tools', 'No Collection'];

  return { stocks, crosses, virginBank, transfers, collections };
}

/* ========== PIN LOCK ========== */
async function hashPin(pin) {
  const data = new TextEncoder().encode(pin + 'flo-salt');
  const buf = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
}
function PinLock({ onUnlock, user, onSelectUser }) {
  const [mode, setMode] = useState(() => {
    if (!user) return 'select';
    if (!localStorage.getItem(`flo-pin-${user}`)) return 'setup';
    return 'enter';
  });
  const [pin, setPin] = useState('');
  const [confirm, setConfirm] = useState('');
  const [error, setError] = useState('');
  const [shaking, setShaking] = useState(false);

  function shake() { setShaking(true); setTimeout(() => setShaking(false), 500); }

  useEffect(() => {
    if (mode === 'select') return;
    function onKeyDown(e) {
      if (e.key >= '0' && e.key <= '9') handleKey(e.key);
      else if (e.key === 'Backspace') handleDel();
    }
    window.addEventListener('keydown', onKeyDown);
    return () => window.removeEventListener('keydown', onKeyDown);
  });

  function handleKey(n) {
    if (mode === 'setup') {
      if (confirm.length > 0 || pin.length === 4) {
        const next = confirm + n;
        setConfirm(next);
        if (next.length === 4) {
          if (next === pin) { hashPin(pin).then(h => { localStorage.setItem(`flo-pin-${user}`, h); onUnlock(); }); }
          else { setError("PINs didn't match"); shake(); setPin(''); setConfirm(''); }
        }
      } else {
        const next = pin + n;
        setPin(next);
        if (next.length === 4) { setConfirm(''); setError(''); }
      }
    } else {
      const next = pin + n;
      setPin(next);
      if (next.length === 4) {
        hashPin(next).then(h => {
          if (h === localStorage.getItem(`flo-pin-${user}`)) onUnlock();
          else { setError('Wrong PIN'); shake(); setPin(''); }
        });
      }
    }
  }
  function handleDel() {
    if (mode === 'setup' && pin.length === 4) setConfirm(confirm.slice(0, -1));
    else setPin(pin.slice(0, -1));
    setError('');
  }

  function pickUser(u) {
    onSelectUser(u);
    if (localStorage.getItem(`flo-pin-${u}`)) setMode('enter');
    else setMode('setup');
    setPin(''); setConfirm(''); setError('');
  }

  const current = mode === 'setup' && pin.length === 4 ? confirm : pin;
  const label = mode === 'select' ? 'Who are you?'
    : mode === 'setup' ? (pin.length < 4 ? `${user}, set a 4-digit PIN` : 'Confirm your PIN')
    : `Welcome back, ${user}`;

  return (
    <div className="min-h-screen flex flex-col items-center justify-center p-6" style={{ background: 'var(--bg)' }}>
      <div className="mb-10 text-center">
        <div className="w-12 h-12 rounded-2xl mx-auto mb-4 flex items-center justify-center" style={{ background: 'var(--accent-glow)', border: '1px solid rgba(139,92,246,0.2)' }}>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
            <path d="M7 11V7a5 5 0 0 1 10 0v4" />
          </svg>
        </div>
        <h1 className="text-xl font-bold tracking-tight" style={{ color: 'var(--text-1)' }}>Flomington</h1>
        <p className="text-xs mt-1" style={{ color: 'var(--text-3)' }}>fly stock manager</p>
      </div>
      <p className="text-sm mb-6" style={{ color: 'var(--text-2)' }}>{label}</p>
      {mode === 'select' ? (
        <div className="grid grid-cols-2 gap-3 w-72">
          {USERS.map(u => (
            <button key={u} onClick={() => pickUser(u)}
              className="px-4 py-4 text-sm font-semibold rounded-xl transition-all active:scale-95"
              style={{ background: 'var(--surface-2)', color: 'var(--text-1)', border: '1px solid var(--border)' }}>
              {u}
            </button>
          ))}
        </div>
      ) : (
        <>
          <div className={`flex gap-5 mb-4 ${shaking ? 'shake' : ''}`}>
            {[0, 1, 2, 3].map(i => <div key={i} className={`pin-dot ${i < current.length ? 'filled' : ''}`} />)}
          </div>
          {error && <p className="text-xs text-red-400 mb-4 font-medium">{error}</p>}
          <div className="grid grid-cols-3 gap-3 mt-6" style={{ maxWidth: 260 }}>
            {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(n => (
              <button key={n} onClick={() => handleKey(String(n))}
                className="touch w-20 h-14 rounded-2xl text-lg font-semibold transition-all active:scale-95"
                style={{ color: 'var(--text-1)', background: 'var(--surface-2)', border: '1px solid var(--border)' }}>
                {n}
              </button>
            ))}
            <button onClick={handleDel}
              className="touch w-20 h-14 rounded-2xl text-sm transition-all active:scale-95"
              style={{ color: 'var(--text-3)', background: 'var(--surface)' }}>Del</button>
            <button onClick={() => handleKey('0')}
              className="touch w-20 h-14 rounded-2xl text-lg font-semibold transition-all active:scale-95"
              style={{ color: 'var(--text-1)', background: 'var(--surface-2)', border: '1px solid var(--border)' }}>0</button>
          </div>
          {(mode === 'setup' || mode === 'enter') && (
            <button onClick={() => { setMode('select'); setPin(''); setConfirm(''); setError(''); }}
              className="text-xs mt-8 touch" style={{ color: 'var(--text-3)' }}>Not {user}? Switch user</button>
          )}
          {mode === 'setup' && <p className="text-[10px] mt-4 max-w-xs text-center" style={{ color: 'var(--text-3)' }}>Your PIN is personal — only you need it to switch back.</p>}
        </>
      )}
    </div>
  );
}

/* ========== TOAST SYSTEM ========== */
function Toasts({ items, remove }) {
  return (
    <div className="fixed bottom-28 left-0 right-0 z-[100] flex flex-col items-center gap-2 px-4 pointer-events-none">
      {items.map(t => (
        <div key={t.id} className={`pointer-events-auto px-4 py-3 flex items-center gap-3 max-w-sm w-full rounded-2xl ${t.out ? 'anim-out' : 'anim-in'}`}
          style={{ background: 'rgba(24,24,27,0.9)', backdropFilter: 'blur(20px)', border: '1px solid var(--border)', boxShadow: '0 8px 32px rgba(0,0,0,0.3)' }}>
          <span className="text-sm flex-1" style={{ color: 'var(--text-1)' }}>{t.msg}</span>
          {t.undo && <button onClick={() => { t.undo(); remove(t.id); }} className="text-sm font-bold touch" style={{ color: 'var(--accent-2)' }}>Undo</button>}
        </div>
      ))}
    </div>
  );
}
function useToast() {
  const [items, set] = useState([]);
  const add = useCallback((msg, undo) => {
    const id = uid();
    set(p => [...p, { id, msg, undo }]);
    setTimeout(() => set(p => p.map(t => t.id === id ? { ...t, out: true } : t)), 3500);
    setTimeout(() => set(p => p.filter(t => t.id !== id)), 3900);
  }, []);
  const rm = useCallback(id => {
    set(p => p.map(t => t.id === id ? { ...t, out: true } : t));
    setTimeout(() => set(p => p.filter(t => t.id !== id)), 300);
  }, []);
  return { items, add, rm };
}

/* ========== UI COMPONENTS ========== */
function Modal({ open, onClose, title, children, wide }) {
  if (!open) return null;

  useEffect(() => {
    const handleEsc = (e) => { if (e.key === 'Escape') onClose(); };
    document.addEventListener('keydown', handleEsc);
    return () => document.removeEventListener('keydown', handleEsc);
  }, [onClose]);

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-5" onClick={onClose}>
      <div className="absolute inset-0" style={{ background: 'rgba(0,0,0,0.6)', backdropFilter: 'blur(8px)', WebkitBackdropFilter: 'blur(8px)', animation: 'backdrop-in 0.2s ease' }} />
      <div className={`relative w-full ${wide ? 'max-w-2xl' : 'max-w-lg'} max-h-[75vh] overflow-y-auto`}
        style={{
          borderRadius: '28px',
          padding: '2.5rem',
          backgroundColor: 'rgba(15, 12, 41, 0.3)',
          backgroundImage: 'linear-gradient(135deg, rgba(255,255,255,0.06) 0%, rgba(0,128,128,0.04) 30%, rgba(138,154,91,0.04) 60%, rgba(255,255,255,0.06) 100%)',
          backdropFilter: 'blur(40px) saturate(1.6) brightness(1.1)',
          WebkitBackdropFilter: 'blur(40px) saturate(1.6) brightness(1.1)',
          border: '1px solid rgba(255,255,255,0.12)',
          boxShadow: '0 0 0 1px rgba(255,255,255,0.06) inset, 0 1px 0 0 rgba(255,255,255,0.1) inset, 0 -1px 0 0 rgba(255,255,255,0.02) inset, 0 8px 40px rgba(0,0,0,0.35), 0 0 120px rgba(0,128,128,0.06), 0 0 60px rgba(204,119,34,0.04)',
          animation: 'modal-in 0.35s cubic-bezier(0.16, 1, 0.3, 1)',
        }}
        onClick={e => e.stopPropagation()}>
        {title && (
          <div className="flex items-center justify-between mb-5">
            <h3 className="text-base font-bold" style={{ color: 'var(--text-1)' }}>{title}</h3>
            <button onClick={onClose} className="touch rounded-full w-8 h-8 flex items-center justify-center transition-all active:scale-90 hover:opacity-80" style={{ background: 'rgba(255,255,255,0.05)', backdropFilter: 'blur(12px)', WebkitBackdropFilter: 'blur(12px)', border: '1px solid rgba(255,255,255,0.1)', color: 'rgba(255,255,255,0.5)' }}>
              <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><line x1="1" y1="1" x2="13" y2="13"/><line x1="13" y1="1" x2="1" y2="13"/></svg>
            </button>
          </div>
        )}
        <div>{children}</div>
      </div>
    </div>
  );
}

function Confirm({ open, onOk, onNo, title, msg }) {
  if (!open) return null;
  return (
    <div className="fixed inset-0 z-[60] flex items-center justify-center p-4" onClick={onNo}>
      <div className="absolute inset-0" style={{ background: 'rgba(0,0,0,0.6)', backdropFilter: 'blur(8px)' }} />
      <div className="relative card p-6 max-w-sm w-full anim-in" onClick={e => e.stopPropagation()}>
        <p className="text-sm font-bold mb-2" style={{ color: 'var(--text-1)' }}>{title}</p>
        <p className="text-xs mb-5" style={{ color: 'var(--text-3)' }}>{msg}</p>
        <div className="flex gap-2">
          <button onClick={onOk} className="touch flex-1 px-4 py-2.5 text-sm font-semibold rounded-xl transition-all active:scale-95"
            style={{ background: 'rgba(239,68,68,0.12)', color: '#fca5a5', border: '1px solid rgba(239,68,68,0.15)' }}>Delete</button>
          <button onClick={onNo} className="touch flex-1 px-4 py-2.5 text-sm font-semibold rounded-xl transition-all active:scale-95"
            style={{ background: 'var(--surface-2)', color: 'var(--text-2)', border: '1px solid var(--border)' }}>Cancel</button>
        </div>
      </div>
    </div>
  );
}

function Btn({ children, onClick, v = 'p', className = '', disabled, ...props }) {
  const styles = {
    p: { background: 'linear-gradient(135deg, #7c3aed, #8b5cf6)', color: '#fff', border: 'none', boxShadow: '0 4px 16px var(--accent-glow)' },
    s: { background: 'var(--surface-2)', color: 'var(--text-2)', border: '1px solid var(--border)' },
    d: { background: 'rgba(239,68,68,0.1)', color: '#fca5a5', border: '1px solid rgba(239,68,68,0.12)' },
    g: { background: 'transparent', color: 'var(--text-3)', border: 'none' },
    ok: { background: 'linear-gradient(135deg, #059669, #10b981)', color: '#fff', border: 'none', boxShadow: '0 4px 16px rgba(34,197,94,0.2)' },
    advance: { background: 'linear-gradient(135deg, #7c3aed, #6d28d9)', color: '#fff', border: 'none', boxShadow: '0 4px 16px var(--accent-glow)' },
  };
  return (
    <button onClick={onClick} disabled={disabled}
      className={`touch px-4 py-2.5 text-sm font-semibold rounded-xl transition-all active:scale-[0.97] ${disabled ? 'opacity-30 pointer-events-none' : ''} ${className}`}
      style={styles[v] || styles.p} {...props}>
      {children}
    </button>
  );
}

function Inp(props) {
  return <input {...props} className={`w-full px-4 py-3 text-sm rounded-xl ${props.className || ''}`} />;
}
function Txt(props) {
  return <textarea {...props} className={`w-full px-4 py-3 text-sm rounded-xl resize-y ${props.className || ''}`} />;
}

function Field({ label, children }) {
  return (
    <label className="block mb-4">
      <span className="text-[11px] uppercase tracking-wider font-semibold" style={{ color: 'var(--text-3)' }}>{label}</span>
      <div className="mt-1.5">{children}</div>
    </label>
  );
}

/* ========== TIMELINE VISUALIZATION ========== */
function CrossTimeline({ cross }) {
  const si = stIdx(cross.status);
  const positions = STATUSES.map((_, i) => (i / (STATUSES.length - 1)) * 100);
  const fillPct = positions[si];

  return (
    <div className="py-3 px-1">
      <div className="tl-track">
        <div className="tl-fill" style={{ width: `${fillPct}%` }} />
        {STATUSES.map((st, i) => {
          let cls = 'tl-dot ';
          if (i < si) cls += 'tl-dot-done';
          else if (i === si) cls += 'tl-dot-current pulse-dot';
          else cls += 'tl-dot-future';
          return <div key={i} className={cls} style={{ left: `${positions[i]}%` }} />;
        })}
      </div>
      <div className="relative mt-3" style={{ height: '14px' }}>
        {STATUS_SHORT.map((lbl, i) => (
          <span key={i} className="tl-label"
            style={{
              position: 'absolute',
              left: `${positions[i]}%`,
              transform: 'translateX(-50%)',
              color: i < si ? 'rgba(34,197,94,0.5)' : i === si ? 'var(--accent-2)' : 'var(--text-3)',
              fontWeight: i === si ? 700 : 600,
            }}>
            {lbl}
          </span>
        ))}
      </div>
    </div>
  );
}

/* ========== NEXT ACTION HELPER ========== */
function getNextAction(cross, stocks) {
  const tl = getTL(cross);
  const cd = crossDetect(cross, stocks);

  if (cross.status === 'done') return null;

  switch (cross.status) {
    case 'set up':
      return { text: 'Cross set up — advance when ready', urgent: false };
    case 'waiting for virgins': {
      const waited = -dFromNow(cross.setupDate);
      const remaining = 9 - waited;
      if (remaining <= 0) return { text: 'Virgins eclosing — collect now!', urgent: true };
      if (remaining === 1) return { text: 'Virgins eclose tomorrow', urgent: false };
      return { text: `Waiting for virgins — ${remaining}d remaining`, urgent: false };
    }
    case 'collecting virgins':
      return { text: 'Collecting virgins — set up cross when ready', urgent: false };
    case 'waiting for progeny': {
      const waitStart = cross.waitStartDate;
      if (waitStart) {
        const waited = -dFromNow(waitStart);
        const remaining = 9 - waited;
        if (remaining <= 0) return { text: 'Progeny ready — collect now!', urgent: true };
        return { text: `Waiting for progeny — ${remaining}d remaining`, urgent: false };
      }
      return { text: 'Waiting for progeny', urgent: false };
    }
    case 'collecting progeny':
      return { text: 'Collecting progeny', urgent: false };
    case 'ripening': {
      const rStart = cross.ripeningStartDate;
      if (rStart) {
        const days = -dFromNow(rStart);
        const target = cd.o ? 3 : 5; // retinal needs 3d, GCaMP needs 5d expression
        const remaining = target - days;
        if (remaining <= 0) return { text: `Ripening complete — ready for experiment`, urgent: true };
        return { text: `Ripening — ${remaining}d remaining (${cd.o ? 'retinal uptake' : 'GCaMP expression'})`, urgent: false };
      }
      return { text: cd.o ? 'Ripening — retinal uptake (3d)' : 'Ripening — GCaMP expression (5d)', urgent: false };
    }
    case 'screening':
      return { text: 'Screen and score', urgent: false };
    default:
      return null;
  }
}

/* ========== CIRCULAR PROGRESS ========== */
function CircleProgress({ value, max, size = 40, stroke = 3, countUp }) {
  const pct = max > 0 ? Math.min(1, value / max) : 0;
  const r = (size - stroke) / 2;
  const circ = 2 * Math.PI * r;
  const done = pct >= 1;
  return (
    <svg width={size} height={size} className="shrink-0">
      <circle cx={size / 2} cy={size / 2} r={r} fill="none" stroke="rgba(255,255,255,0.06)" strokeWidth={stroke} />
      <circle cx={size / 2} cy={size / 2} r={r} fill="none"
        stroke={done ? '#22c55e' : '#8b5cf6'} strokeWidth={stroke}
        strokeDasharray={circ} strokeDashoffset={circ * (1 - pct)}
        strokeLinecap="round" transform={`rotate(-90 ${size / 2} ${size / 2})`}
        style={{ transition: 'stroke-dashoffset 0.5s ease' }} />
      <text x={size / 2} y={size / 2} textAnchor="middle" dominantBaseline="central"
        fill={done ? '#86efac' : 'var(--text-3)'} fontSize="9" fontWeight="700" fontFamily="'SF Mono', monospace">
        {done ? '✓' : countUp ? value : Math.max(0, max - value)}
      </text>
    </svg>
  );
}

/* ========== CROSS CARD (COMPACT) ========== */
function CrossCard({ cross, stocks, setCrosses, toast, virginBank, setVirginBank, virginsPerCross, forceOpen, currentUser, onTransfer, printListCrosses, setPrintListCrosses }) {
  const [detailOpen, setDetailOpen] = useState(false);
  useEffect(() => { if (forceOpen) setDetailOpen(true); }, [forceOpen]);
  const [editing, setEditing] = useState(false);
  const [deleting, setDeleting] = useState(false);

  const tl = getTL(cross);
  const cd = crossDetect(cross, stocks);
  const tot = (cross.collected || []).reduce((s, e) => s + e.count, 0);
  const isVirginPhase = ['waiting for virgins', 'collecting virgins'].includes(cross.status);
  const vTarget = virginsPerCross || 5;
  const vCollected = cross.virginsCollected || 0;
  const hasTarget = isVirginPhase ? vTarget > 0 : cross.targetCount > 0;
  const isCollecting = ['waiting for virgins', 'collecting virgins', 'waiting for progeny', 'collecting progeny', 'screening'].includes(cross.status);
  const nextAction = getNextAction(cross, stocks);
  const isDone = cross.status === 'done';

  function advance(e) {
    e?.stopPropagation();
    let ns = nextSt(cross.status);
    // Skip ripening for crosses without opto/imaging
    if (ns === 'ripening' && !cd.o && !cd.c) ns = nextSt(ns);
    // Auto-skip "collecting virgins" if enough virgins are banked for the virgin parent
    if (ns === 'collecting virgins' && virginBank && setVirginBank) {
      const needed = virginsPerCross || 5;
      const available = virginBank[cross.parentA] || 0;
      if (available >= needed) {
        setVirginBank(prev => ({ ...prev, [cross.parentA]: (prev[cross.parentA] || 0) - needed }));
        ns = 'collecting progeny';
        toast.add(`Used ${needed} banked virgins → ${ns}`);
        setCrosses(p => p.map(c => c.id === cross.id ? { ...c, status: ns } : c));
        return;
      }
    }
    const extra = ns === 'waiting for progeny' ? { waitStartDate: today() }
      : ns === 'ripening' ? { ripeningStartDate: today() } : {};
    setCrosses(p => p.map(c => c.id === cross.id ? { ...c, status: ns, ...extra } : c));
    toast.add(`→ ${ns}`);
  }

  function quickLog(n) {
    setCrosses(p => p.map(c => c.id !== cross.id ? c : { ...c, collected: [...(c.collected || []), { date: today(), count: n }] }));
    toast.add(`+${n} logged`);
  }

  function logVirgin(n) {
    const newCount = vCollected + n;
    if (newCount >= vTarget) {
      setCrosses(p => p.map(c => c.id === cross.id ? { ...c, virginsCollected: newCount, status: 'waiting for progeny', waitStartDate: today() } : c));
      toast.add(`${vTarget} virgins collected → waiting for progeny`);
    } else {
      setCrosses(p => p.map(c => c.id === cross.id ? { ...c, virginsCollected: newCount } : c));
      toast.add(`+${n} virgin${n > 1 ? 's' : ''}`);
    }
  }

  function revial() {
    const clone = {
      ...cross,
      id: uid(),
      setupDate: today(),
      status: 'waiting for progeny',
      waitStartDate: today(),
      collected: [],
      vials: [],
      notes: `Re-vial of ${cl(cross, stocks)}`,
    };
    setCrosses(p => [...p, clone]);
    toast.add('Re-vialed — new cross created');
  }

  function exportCal() {
    const lb = cl(cross, stocks);
    const ev = [
      { date: tl.virginStart, title: `Virgins start: ${lb}`, desc: 'Start collecting virgins' },
      { date: tl.virginEnd, title: `Virgins end: ${lb}`, desc: 'Last day for virgins' },
      { date: tl.progenyStart, title: `Progeny start: ${lb}`, desc: 'Start collecting progeny' },
      { date: tl.progenyEnd, title: `Progeny end: ${lb}`, desc: 'Last day for progeny' },
    ];
    if (cross.experimentDate) ev.push({ date: cross.experimentDate, title: `Experiment: ${lb}`, desc: cross.experimentType || '' });
    dlICS(ev, `cross-${cross.id.slice(0, 6)}.ics`);
    toast.add('Calendar exported');
  }

  function doDelete() {
    const backup = { ...cross };
    setCrosses(p => p.filter(c => c.id !== cross.id));
    setDeleting(false);
    setDetailOpen(false);
    toast.add('Cross deleted', () => setCrosses(p => [...p, backup]));
  }

  function setStatus(st) {
    const extra = st === 'waiting for progeny' ? { waitStartDate: today() } : {};
    setCrosses(p => p.map(c => c.id === cross.id ? { ...c, status: st, ...extra } : c));
    toast.add(`Set to: ${st}`);
  }

  /* --- Compact card (tap to open detail) --- */
  return (
    <>
      <div className={`card anim-in cursor-pointer transition-all active:scale-[0.98] ${isDone ? 'opacity-50' : ''}`}
        style={['collecting virgins', 'collecting progeny', 'ripening'].includes(cross.status)
          ? { borderColor: 'rgba(239,68,68,0.25)', background: 'rgba(239,68,68,0.06)', boxShadow: '0 0 20px rgba(239,68,68,0.08)' }
          : (cross.status === 'waiting for virgins' && -dFromNow(cross.setupDate) >= 7) || (cross.status === 'waiting for progeny' && cross.waitStartDate && -dFromNow(cross.waitStartDate) >= 7)
            ? { borderColor: 'rgba(245,158,11,0.25)', background: 'rgba(245,158,11,0.06)', boxShadow: '0 0 20px rgba(245,158,11,0.08)' }
            : {}}
        onClick={() => setDetailOpen(true)}>
        <div className="p-4 flex items-center gap-4">
          {/* Circular progress — hide during waiting statuses */}
          {hasTarget && !['waiting for virgins', 'waiting for progeny'].includes(cross.status) ? (
            <CircleProgress value={isVirginPhase ? vCollected : tot} max={isVirginPhase ? vTarget : cross.targetCount} countUp={['collecting virgins', 'collecting progeny'].includes(cross.status)} />
          ) : (
            <div className="w-10 h-10 rounded-full flex items-center justify-center shrink-0"
              style={{ background: isDone ? 'rgba(34,197,94,0.1)' : 'var(--accent-glow-2)', border: `1px solid ${isDone ? 'rgba(34,197,94,0.15)' : 'rgba(139,92,246,0.15)'}` }}>
              <span className="text-xs font-bold" style={{ color: isDone ? '#86efac' : 'var(--accent-2)' }}>
                {isDone ? '✓'
                  : cross.status === 'waiting for progeny' && cross.waitStartDate ? Math.max(0, 9 - (-dFromNow(cross.waitStartDate))) + 'd'
                  : cross.status === 'waiting for virgins' ? Math.max(0, 9 - (-dFromNow(cross.setupDate))) + 'd'
                  : STATUS_SHORT[stIdx(cross.status)]}
              </span>
            </div>
          )}

          {/* Names + info */}
          <div className="flex-1 min-w-0">
            <div className="flex items-center gap-2 mb-0.5">
              <div className="text-[14px] font-bold leading-snug truncate" style={{ color: 'var(--text-1)' }}>
                <span style={{ color: '#f9a8d4' }}>♀</span> {sn(stocks, cross.parentA)} <span style={{ color: 'var(--text-3)', fontWeight: 400 }}>×</span> <span style={{ color: '#93c5fd' }}>♂</span> {sn(stocks, cross.parentB)}
              </div>
              <span className="badge shrink-0" style={{ background: 'var(--surface-2)', color: 'var(--text-2)' }}>{tempLabel(cross.temperature)}</span>
            </div>
            <div className="flex items-center gap-1.5 flex-wrap">
              {cd.o && <span className="badge" style={{ background: 'rgba(239,68,68,0.1)', color: '#fca5a5' }}>opto</span>}
              {cd.c && <span className="badge" style={{ background: 'rgba(34,197,94,0.1)', color: '#86efac' }}>imaging</span>}
              {cross.experimentType && <span className="badge" style={{ background: 'var(--surface-2)', color: 'var(--text-2)' }}>{cross.experimentType}</span>}
            </div>
          </div>

          {/* Next action indicator */}
          {nextAction && (
            <div className="shrink-0 text-right">
              {nextAction.urgent && <div className="w-2 h-2 rounded-full ml-auto mb-1" style={{ background: 'var(--red)', boxShadow: '0 0 6px rgba(239,68,68,0.4)' }} />}
              {nextAction.date && <span className="text-[11px] font-medium" style={{ color: nextAction.urgent ? '#fca5a5' : 'var(--text-3)' }}>{fmt(nextAction.date)}</span>}
            </div>
          )}
        </div>
      </div>

      {/* ===== DETAIL POPUP ===== */}
      <Modal open={detailOpen} onClose={() => setDetailOpen(false)} title={<div className="flex items-center gap-2">{cl(cross, stocks)} <span className="badge" style={{ background: 'var(--surface-2)', color: 'var(--text-3)', fontWeight: 500, fontSize: '11px' }}>{tempLabel(cross.temperature)}</span>{setPrintListCrosses && <button onClick={() => { const inList = (printListCrosses || []).includes(cross.id); setPrintListCrosses(p => inList ? p.filter(x => x !== cross.id) : [...p, cross.id]); toast.add(inList ? 'Removed from print list' : 'Added to print list'); }} className="touch p-1.5 rounded-lg transition-all active:scale-90" style={{ color: (printListCrosses || []).includes(cross.id) ? '#5eead4' : 'var(--text-3)' }} title={(printListCrosses || []).includes(cross.id) ? 'In print list' : 'Add to print list'}><svg width="16" height="16" viewBox="0 0 24 24" fill={(printListCrosses || []).includes(cross.id) ? 'currentColor' : 'none'} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg></button>}</div>}>
        {/* Parents with genotypes */}
        <div className="grid gap-3 mb-5">
          <div className="card-inner p-4">
            <span className="text-sm font-bold" style={{ color: '#f9a8d4' }}>♀ Virgin</span>
            <p className="text-[15px] font-bold" style={{ color: 'var(--text-1)' }}>{sn(stocks, cross.parentA)}</p>
            {sg(stocks, cross.parentA) && sg(stocks, cross.parentA) !== '+' && (
              <p className="text-xs mono mt-1 break-all" style={{ color: 'rgba(167,139,250,0.5)' }}>{sg(stocks, cross.parentA)}</p>
            )}
          </div>
          <div className="card-inner p-4">
            <span className="text-sm font-bold" style={{ color: '#93c5fd' }}>♂ Male</span>
            <p className="text-[15px] font-bold" style={{ color: 'var(--text-1)' }}>{sn(stocks, cross.parentB)}</p>
            {sg(stocks, cross.parentB) && sg(stocks, cross.parentB) !== '+' && (
              <p className="text-xs mono mt-1 break-all" style={{ color: 'rgba(167,139,250,0.5)' }}>{sg(stocks, cross.parentB)}</p>
            )}
          </div>
        </div>

        {/* Timeline */}
        <p className="section-header">Timeline</p>
        <CrossTimeline cross={cross} />

        {/* Dates — hide range for current collecting phase */}
        {(() => {
          const showVirgin = !['collecting virgins', 'collecting progeny', 'ripening', 'screening', 'done'].includes(cross.status);
          const showProgeny = !['collecting progeny', 'ripening', 'screening', 'done'].includes(cross.status);
          if (!showVirgin && !showProgeny) return null;
          return (
            <div className={`grid gap-3 mt-3 mb-5 ${showVirgin && showProgeny ? 'grid-cols-2' : 'grid-cols-1'}`}>
              {showVirgin && (
                <div className="card-inner p-3 text-center">
                  <p className="text-[10px] uppercase tracking-wider mb-1" style={{ color: 'var(--text-3)' }}>Virgins</p>
                  <p className="text-sm font-bold" style={{ color: 'var(--text-1)' }}>{fmt(tl.virginStart)} – {fmt(tl.virginEnd)}</p>
                </div>
              )}
              {showProgeny && (
                <div className="card-inner p-3 text-center">
                  <p className="text-[10px] uppercase tracking-wider mb-1" style={{ color: 'var(--text-3)' }}>Progeny</p>
                  <p className="text-sm font-bold" style={{ color: 'var(--text-1)' }}>{fmt(tl.progenyStart)} – {fmt(tl.progenyEnd)}</p>
                </div>
              )}
            </div>
          );
        })()}

        {/* Next action */}
        {nextAction && (
          <div className="flex items-center gap-2 mb-5 p-3 rounded-xl" style={{ background: nextAction.urgent ? 'rgba(239,68,68,0.06)' : 'var(--accent-glow-2)', border: `1px solid ${nextAction.urgent ? 'rgba(239,68,68,0.1)' : 'rgba(139,92,246,0.1)'}` }}>
            <div className="w-2 h-2 rounded-full shrink-0" style={{ background: nextAction.urgent ? 'var(--red)' : 'var(--accent)' }} />
            <span className="text-sm font-medium flex-1" style={{ color: nextAction.urgent ? '#fca5a5' : 'var(--text-2)' }}>{nextAction.text}</span>
            {nextAction.date && <span className="text-xs" style={{ color: 'var(--text-3)' }}>{fmt(nextAction.date)}</span>}
          </div>
        )}

        {/* Ripening progress (retinal/GCaMP timing shown during ripening) */}
        {(cd.o || cd.c) && cross.ripeningStartDate && cross.status === 'ripening' && (
          <div className="text-xs mb-5" style={{ color: 'rgba(252,165,165,0.5)' }}>
            {cd.o ? 'Retinal uptake' : 'GCaMP expression'} — {-dFromNow(cross.ripeningStartDate)}d / {cd.o ? 3 : 5}d {-dFromNow(cross.ripeningStartDate) >= (cd.o ? 3 : 5) ? '— ready' : ''}
          </div>
        )}

        {/* Virgin collection progress — only during collecting */}
        {cross.status === 'collecting virgins' && (
          <div className="mb-5">
            <p className="section-header">Virgin Collection</p>
            <div className="flex items-center gap-4 mb-3">
              <CircleProgress value={vCollected} max={vTarget} size={56} stroke={4} countUp />
              <div>
                <p className="text-lg font-bold" style={{ color: 'var(--text-1)' }}>{vCollected} <span className="text-sm font-normal" style={{ color: 'var(--text-3)' }}>/ {vTarget}</span></p>
                <p className="text-xs" style={{ color: 'var(--text-3)' }}>{Math.round((vCollected / vTarget) * 100)}% collected</p>
              </div>
            </div>
            <div className="flex gap-2">
              {[1, 3, 5].map(n => (
                <button key={n} onClick={() => logVirgin(n)} className="qlog-btn flex-1">+{n}</button>
              ))}
            </div>
          </div>
        )}

        {/* Progeny collection progress — hide during waiting statuses */}
        {!isVirginPhase && !['waiting for progeny'].includes(cross.status) && hasTarget && (
          <div className="mb-5">
            <p className="section-header">Collection Progress</p>
            <div className="flex items-center gap-4 mb-3">
              <CircleProgress value={tot} max={cross.targetCount} size={56} stroke={4} countUp />
              <div>
                <p className="text-lg font-bold" style={{ color: 'var(--text-1)' }}>{tot} <span className="text-sm font-normal" style={{ color: 'var(--text-3)' }}>/ {cross.targetCount}</span></p>
                <p className="text-xs" style={{ color: 'var(--text-3)' }}>{Math.round((tot / cross.targetCount) * 100)}% collected</p>
              </div>
            </div>
            {isCollecting && !isDone && (
              <div className="flex gap-2">
                {[1, 5, 10].map(n => (
                  <button key={n} onClick={() => quickLog(n)} className="qlog-btn flex-1">+{n}</button>
                ))}
              </div>
            )}
            {(cross.collected || []).length > 0 && (
              <div className="text-xs mt-3" style={{ color: 'var(--text-3)' }}>
                Recent: {(cross.collected || []).slice(-5).map((e, i) => <span key={i}>{i > 0 ? ', ' : ''}{fmt(e.date)} +{e.count}</span>)}
              </div>
            )}
          </div>
        )}

        {/* Notes */}
        {cross.notes && (
          <div className="mb-5">
            <p className="section-header">Notes</p>
            <p className="text-sm" style={{ color: 'var(--text-2)' }}>{cross.notes}</p>
          </div>
        )}

        {/* Screening Guide */}
        {['collecting progeny', 'screening'].includes(cross.status) && (() => {
          const guide = getScreeningGuide(cross, stocks);
          if (guide.length === 0) return null;
          return (
            <div className="mb-5">
              <p className="section-header">What to look for</p>
              <div className="grid gap-2">
                {guide.map((m, i) => (
                  <div key={i} className="card-inner p-3 rounded-xl">
                    <div className="flex items-center gap-2 mb-1">
                      <span className="text-xs font-bold" style={{ color: 'var(--text-1)' }}>{m.name}</span>
                      {m.chromosome && <span className="badge" style={{ background: 'var(--surface-2)', color: 'var(--text-2)' }}>{m.chromosome}</span>}
                      <span className="badge" style={{ background: 'var(--surface-2)', color: 'var(--text-2)' }}>{m.source}</span>
                    </div>
                    <p className="text-xs" style={{ color: 'var(--text-3)' }}>{m.phenotype}</p>
                    <p className="text-xs font-semibold mt-1" style={{ color: '#86efac' }}>Select: {m.select}</p>
                  </div>
                ))}
              </div>
            </div>
          );
        })()}

        {/* Actions */}
        <div className="grid gap-2">
          {!isDone ? (
            <Btn v="advance" onClick={advance} className="w-full">Advance → {(() => { let ns = nextSt(cross.status); if (ns === 'ripening' && !cd.o && !cd.c) ns = nextSt(ns); return ns; })()}</Btn>
          ) : (
            <Btn v="s" onClick={() => {
              setCrosses(p => [...p, {
                ...cross, id: uid(), status: 'set up', setupDate: today(),
                collected: [], vials: [], retinalStartDate: '', notes: cross.notes ? `Repeat: ${cross.notes}` : 'Repeat',
                manualFlipDate: '', manualEcloseDate: '', manualVirginDate: '',
              }]);
              toast.add('Cross repeated');
              setDetailOpen(false);
            }} className="w-full">Repeat Cross</Btn>
          )}
          <div className="grid grid-cols-3 gap-2">
            <Btn v="s" onClick={() => { setEditing(true); setDetailOpen(false); }}>Edit</Btn>
            <Btn v="s" onClick={exportCal}>Calendar</Btn>
            {cross.status === 'waiting for progeny' ? (
              <Btn v="s" onClick={revial}>Re-vial</Btn>
            ) : isDone ? (
              <Btn v="d" onClick={() => { setDeleting(true); setDetailOpen(false); }}>Delete</Btn>
            ) : <Btn v="s" disabled style={{ opacity: 0.3 }}>Re-vial</Btn>}
          </div>
          {!isDone && (
            <>
              <p className="text-[10px] uppercase tracking-wider font-semibold mt-2" style={{ color: 'var(--text-3)' }}>Jump to status</p>
              <div className="flex flex-wrap gap-1.5">
                {STATUSES.filter(s => s !== cross.status).map(s => (
                  <button key={s} onClick={() => setStatus(s)}
                    className="px-3 py-1.5 text-xs rounded-lg transition-all active:scale-95 cursor-pointer"
                    style={{ background: 'var(--surface-2)', color: 'var(--text-3)', border: '1px solid var(--border)' }}>{s}</button>
                ))}
              </div>
              <Btn v="d" onClick={() => { setDeleting(true); setDetailOpen(false); }} className="w-full mt-2">Delete Cross</Btn>
            </>
          )}
          {onTransfer && (
            <div className="mt-3">
              <p className="text-[10px] uppercase tracking-wider font-semibold mb-2" style={{ color: 'var(--text-3)' }}>Transfer ownership</p>
              <div className="flex flex-wrap gap-1.5">
                {USERS.filter(u => u !== currentUser).map(u => (
                  <button key={u} onClick={() => { onTransfer({ type: 'cross', itemId: cross.id, name: cl(cross, stocks), to: u }); setDetailOpen(false); }}
                    className="px-3 py-1.5 text-xs rounded-lg transition-all active:scale-95 cursor-pointer"
                    style={{ background: 'rgba(139,92,246,0.08)', color: '#a78bfa', border: '1px solid rgba(139,92,246,0.15)' }}>{u}</button>
                ))}
              </div>
            </div>
          )}
        </div>
      </Modal>

      <EditCrossModal open={editing} onClose={() => setEditing(false)} cross={cross} stocks={stocks} setCrosses={setCrosses} toast={toast} allCrosses={[]} />
      <Confirm open={deleting} onOk={doDelete} onNo={() => setDeleting(false)} title="Delete cross?" msg="This cross and all collection data will be permanently removed." />
    </>
  );
}

/* ========== EDIT CROSS MODAL ========== */
function EditCrossModal({ open, onClose, cross, stocks, setCrosses, toast, allCrosses }) {
  const [f, setF] = useState({});
  const [showAdv, setShowAdv] = useState(false);
  const [showNotes, setShowNotes] = useState(false);

  useEffect(() => {
    if (open && cross) {
      setF({ ...cross });
      setShowNotes(!!cross.notes);
      setShowAdv(!!cross.manualFlipDate || !!cross.manualEcloseDate || !!cross.manualVirginDate || cross.crossType === 'sequential');
    }
  }, [open, cross?.id]);

  if (!open) return null;

  function save() {
    setCrosses(p => p.map(c => c.id === cross.id ? { ...c, ...f } : c));
    toast.add('Cross updated');
    onClose();
  }

  return (
    <Modal open={open} onClose={onClose} title="Edit Cross">
      <Field label="Virgin parent">
        <div className="card-inner px-4 py-3 text-sm" style={{ color: 'var(--text-2)' }}>{sn(stocks, f.parentA)}</div>
      </Field>
      <Field label="Male parent">
        <div className="card-inner px-4 py-3 text-sm" style={{ color: 'var(--text-2)' }}>{sn(stocks, f.parentB)}</div>
      </Field>
      <Field label="Location">
        <div className="grid grid-cols-2 gap-2">
          {TEMPS.map(t => (
            <div key={t} onClick={() => setF({ ...f, temperature: t })} className={`loc-card ${f.temperature === t ? 'selected' : ''}`}>
              <div className="text-sm font-bold" style={{ color: 'var(--text-1)' }}>{tempFull(t)}</div>
            </div>
          ))}
        </div>
      </Field>
      <div className="grid grid-cols-2 gap-3">
        <Field label="Target count"><Inp type="number" min="0" value={f.targetCount || ''} onChange={e => setF({ ...f, targetCount: parseInt(e.target.value) || 0 })} /></Field>
        <Field label="Experiment type">
          <select value={f.experimentType || ''} onChange={e => setF({ ...f, experimentType: e.target.value })}
            className="w-full px-4 py-3 text-sm rounded-xl">
            <option value="">None</option>
            <option value="optogenetics">Optogenetics</option>
            <option value="2p">2P</option>
            <option value="2p+vr">2P + VR</option>
            <option value="behavior">Behaviour</option>

            <option value="flydisco">FlyDisco</option>
            <option value="vr">VR</option>
            <option value="dissection">Dissection / Immunostaining</option>
            <option value="other">Other</option>
          </select>
        </Field>
      </div>
      {f.experimentType && <Field label="Experiment date"><Inp type="date" value={f.experimentDate || ''} onChange={e => setF({ ...f, experimentDate: e.target.value })} /></Field>}
      {!showNotes ? (
        <button onClick={() => setShowNotes(true)} className="text-xs mb-4 touch" style={{ color: 'var(--accent-2)' }}>+ add notes</button>
      ) : (
        <Field label="Notes"><Txt value={f.notes || ''} onChange={e => setF({ ...f, notes: e.target.value })} rows={2} /></Field>
      )}
      <button onClick={() => setShowAdv(!showAdv)} className="text-xs mb-3 touch" style={{ color: 'var(--text-3)' }}>{showAdv ? 'Hide' : 'Show'} advanced</button>
      {showAdv && (
        <div className="card-inner p-4 mb-4">
          <p className="text-[11px] mb-3" style={{ color: 'var(--text-3)' }}>Override calculated dates:</p>
          <div className="grid grid-cols-3 gap-2">
            <Field label="Flip"><Inp type="date" value={f.manualFlipDate || ''} onChange={e => setF({ ...f, manualFlipDate: e.target.value })} /></Field>
            <Field label="Virgin"><Inp type="date" value={f.manualVirginDate || ''} onChange={e => setF({ ...f, manualVirginDate: e.target.value })} /></Field>
            <Field label="Eclose"><Inp type="date" value={f.manualEcloseDate || ''} onChange={e => setF({ ...f, manualEcloseDate: e.target.value })} /></Field>
          </div>
          <Field label="Cross type">
            <select value={f.crossType || 'simple'} onChange={e => setF({ ...f, crossType: e.target.value })}
              className="w-full px-4 py-3 text-sm rounded-xl">
              <option value="simple">Simple</option>
              <option value="sequential">Sequential (F1 cross)</option>
            </select>
          </Field>
          <Field label="Setup date"><Inp type="date" value={f.setupDate || ''} onChange={e => setF({ ...f, setupDate: e.target.value })} /></Field>
        </div>
      )}
      <div className="flex gap-2">
        <Btn onClick={save} className="flex-1">Save</Btn>
        <Btn v="s" onClick={onClose}>Cancel</Btn>
      </div>
    </Modal>
  );
}

/* ========== NEW CROSS WIZARD ========== */
function NewCrossWizard({ open, onClose, stocks, setCrosses, toast, virginBank, setVirginBank, preselectedVirgin, virginsPerCross, currentUser }) {
  const [step, setStep] = useState(1);
  const [parentA, setParentA] = useState(null);
  const [parentB, setParentB] = useState(null);
  const [temperature, setTemperature] = useState('25inc');
  const [targetCount, setTargetCount] = useState('');
  const [experimentType, setExperimentType] = useState('optogenetics');
  const [notes, setNotes] = useState('');
  const [showNotes, setShowNotes] = useState(false);
  const [search, setSearch] = useState('');

  useEffect(() => {
    if (open) {
      setTemperature('25inc');
      setExperimentType(''); setNotes(''); setShowNotes(false); setSearch('');
      if (preselectedVirgin) {
        const stock = stocks.find(s => s.id === preselectedVirgin);
        setParentA(stock || null);
        setParentB(null);
        setStep(stock ? 2 : 1);
        setTargetCount('15');
      } else {
        setStep(1); setParentA(null); setParentB(null); setTargetCount('');
      }
    }
  }, [open]);

  if (!open) return null;

  const filteredStocks = stocks.filter(s =>
    !search || [s.name, s.genotype, s.notes || ''].some(x => x.toLowerCase().includes(search.toLowerCase()))
  );

  function finish() {
    const needed = virginsPerCross || 5;
    const available = virginBank?.[parentA.id] || 0;
    let initialStatus = 'waiting for virgins';
    let msg = 'Cross created — waiting for virgins';

    if (available >= needed) {
      setVirginBank(prev => ({ ...prev, [parentA.id]: (prev[parentA.id] || 0) - needed }));
      initialStatus = 'waiting for progeny';
      msg = `Cross created — used ${needed} banked virgins`;
    }

    const cross = {
      id: uid(), parentA: parentA.id, parentB: parentB.id, temperature,
      setupDate: today(), status: initialStatus, notes,
      targetCount: parseInt(targetCount) || 0, collected: [], vials: [],
      manualFlipDate: '', manualEcloseDate: '', manualVirginDate: '',
      crossType: 'simple', parentCrossId: '',
      experimentType, experimentDate: '', retinalStartDate: '',
      owner: currentUser,
      ...(initialStatus === 'waiting for progeny' ? { waitStartDate: today() } : {}),
    };
    setCrosses(p => [...p, cross]);
    toast.add(msg);
    onClose();
  }

  function StockList({ onPick, exclude }) {
    return (
      <div>
        <Inp placeholder="Search stocks..." value={search} onChange={e => setSearch(e.target.value)} className="mb-3" autoFocus />
        {filteredStocks.length === 0 ? (
          <p className="text-sm text-center py-8" style={{ color: 'var(--text-3)' }}>No stocks found</p>
        ) : (
          <div className="grid gap-1 max-h-[50vh] overflow-y-auto">
            {filteredStocks.filter(s => !exclude || s.id !== exclude).map(s => {
              const dc = detect(s.genotype);
              return (
                <div key={s.id} onClick={() => { onPick(s); setSearch(''); }} className="stock-pick card-inner">
                  <div className="flex items-center gap-2 flex-wrap">
                    <span className="text-[15px] font-bold" style={{ color: 'var(--text-1)' }}>{s.name}</span>
                    <span className="badge" style={{ background: 'var(--surface-2)', color: 'var(--text-2)' }}>{tempLabel(s.location)}</span>
                    {dc.o && <span className="badge" style={{ background: 'rgba(239,68,68,0.1)', color: '#fca5a5' }}>opto</span>}
                    {dc.c && <span className="badge" style={{ background: 'rgba(34,197,94,0.1)', color: '#86efac' }}>imaging</span>}
                  </div>
                  {s.genotype && s.genotype !== '+' && <p className="text-xs mono truncate mt-1" style={{ color: 'rgba(167,139,250,0.4)' }}>{s.genotype}</p>}
                </div>
              );
            })}
          </div>
        )}
      </div>
    );
  }

  const DEFAULT_TARGETS = { optogenetics: 30, '2p': 15, '2p+vr': 15, behavior: 20, flydisco: 20, vr: 15, dissection: 10, other: 15, '': 15 };
  function onExpTypeChange(val) {
    setExperimentType(val);
    if (!targetCount || targetCount === String(DEFAULT_TARGETS[experimentType] || 15)) {
      setTargetCount(String(DEFAULT_TARGETS[val] || 15));
    }
  }
  const titles = { 1: 'Pick ♀ virgin parent', 2: 'Pick ♂ male parent', 3: 'Pick location', 4: 'Details (optional)' };

  return (
    <Modal open={open} onClose={onClose} title={titles[step]}>
      {/* Progress dots */}
      <div className="flex items-center justify-center gap-2 mb-5">
        {[1, 2, 3, 4].map(s => (
          <div key={s} className="rounded-full transition-all" style={{
            width: s === step ? 24 : 8,
            height: 8,
            background: s === step ? 'var(--accent)' : s < step ? 'rgba(139,92,246,0.4)' : 'var(--surface-3)',
            boxShadow: s === step ? '0 0 12px var(--accent-glow)' : 'none',
          }} />
        ))}
      </div>

      {step === 1 && (
        <div>
          {stocks.length === 0 ? (
            <p className="text-sm text-center py-8" style={{ color: 'var(--text-3)' }}>Add stocks first</p>
          ) : (
            <StockList onPick={s => { setParentA(s); setStep(2); }} />
          )}
        </div>
      )}

      {step === 2 && (
        <div>
          <div className="card-inner px-4 py-3 mb-4 flex items-center gap-2">
            <span className="text-xs" style={{ color: 'var(--text-3)' }}>♀</span>
            <span className="text-sm font-medium" style={{ color: 'var(--text-1)' }}>{parentA?.name}</span>
            <button onClick={() => setStep(1)} className="ml-auto text-xs touch" style={{ color: 'var(--accent-2)' }}>change</button>
          </div>
          <StockList onPick={s => { setParentB(s); setStep(3); }} exclude={parentA?.id} />
        </div>
      )}

      {step === 3 && (
        <div>
          <div className="card-inner px-4 py-3 mb-4">
            <div className="text-sm font-medium" style={{ color: 'var(--text-1)' }}>{parentA?.name} <span style={{ color: 'var(--text-3)' }}>×</span> {parentB?.name}</div>
          </div>
          <div className="grid grid-cols-2 gap-3 mb-5">
            {TEMPS.map(t => (
              <div key={t} onClick={() => setTemperature(t)} className={`loc-card ${temperature === t ? 'selected' : ''}`}>
                <div className="text-base font-bold mb-0.5" style={{ color: 'var(--text-1)' }}>{tempFull(t)}</div>
              </div>
            ))}
          </div>
          <Btn onClick={() => setStep(4)} className="w-full">Next</Btn>
        </div>
      )}

      {step === 4 && (
        <div>
          <div className="card-inner px-4 py-3 mb-4">
            <div className="text-sm font-medium" style={{ color: 'var(--text-1)' }}>{parentA?.name} <span style={{ color: 'var(--text-3)' }}>×</span> {parentB?.name}</div>
            <div className="text-xs mt-0.5" style={{ color: 'var(--text-3)' }}>{tempFull(temperature)} · Setup today</div>
          </div>
          <div className="grid grid-cols-2 gap-3">
            <Field label="Target count"><Inp type="number" min="0" value={targetCount} onChange={e => setTargetCount(e.target.value)} placeholder="0" /></Field>
            <Field label="Experiment type">
              <select value={experimentType} onChange={e => onExpTypeChange(e.target.value)}
                className="w-full px-4 py-3 text-sm rounded-xl">
                <option value="optogenetics">Optogenetics</option>
                <option value="2p">2P</option>
                <option value="2p+vr">2P + VR</option>
                <option value="behavior">Behaviour</option>
    
                <option value="flydisco">FlyDisco</option>
                <option value="vr">VR</option>
                <option value="dissection">Dissection / Immunostaining</option>
                <option value="other">Other</option>
              </select>
            </Field>
          </div>
          {!showNotes ? (
            <button onClick={() => setShowNotes(true)} className="text-xs mb-4 touch" style={{ color: 'var(--accent-2)' }}>+ add notes</button>
          ) : (
            <Field label="Notes"><Txt value={notes} onChange={e => setNotes(e.target.value)} rows={2} placeholder="Optional notes..." /></Field>
          )}
          <Btn onClick={finish} className="w-full">Create Cross</Btn>
          <p className="text-[11px] text-center mt-3" style={{ color: 'var(--text-3)' }}>Setup date = today, timeline auto-calculated</p>
        </div>
      )}

      {step > 1 && (
        <button onClick={() => setStep(step - 1)} className="text-xs mt-3 touch block mx-auto" style={{ color: 'var(--text-3)' }}>← Back</button>
      )}
    </Modal>
  );
}

/* ========== HOME SCREEN ========== */
function HomeScreen({ stocks, setStocks, crosses, setCrosses, toast, onNewCross, virginBank, setVirginBank, virginsPerCross, currentUser, transfers, onAcceptTransfer, onDeclineTransfer, onTransfer, STOCK_CATS, sentTransfers, onDismissTransfer, printListCrosses, setPrintListCrosses }) {
  const [showCompleted, setShowCompleted] = useState(false);
  const [flipCat, setFlipCat] = useState(null);
  const [flipDate, setFlipDate] = useState(today());
  const [selectedCrossId, setSelectedCrossId] = useState(null);
  const activeRef = useRef(null);
  const healthRef = useRef(null);

  const myCrosses = useMemo(() => crosses.filter(c => !c.owner || c.owner === currentUser), [crosses, currentUser]);
  const activeCrosses = useMemo(() => {
    const urgent = ['collecting virgins', 'collecting progeny', 'ripening'];
    return myCrosses.filter(c => c.status !== 'done').sort((a, b) => urgent.includes(b.status) - urgent.includes(a.status));
  }, [myCrosses]);
  const completedCrosses = useMemo(() => myCrosses.filter(c => c.status === 'done'), [myCrosses]);

  // Auto-promote waiting states
  useEffect(() => {
    const promotions = [
      { from: 'waiting for virgins', to: 'collecting virgins', field: 'setupDate', days: 9 },
      { from: 'waiting for progeny', to: 'collecting progeny', field: 'waitStartDate', days: 9 },
    ];
    let changed = false;
    const updated = crosses.map(c => {
      for (const p of promotions) {
        if (c.status === p.from && c[p.field] && -dFromNow(c[p.field]) >= p.days) {
          changed = true;
          toast.add(`${cl(c, stocks)} → ${p.to}`);
          return { ...c, status: p.to };
        }
      }
      return c;
    });
    if (changed) setCrosses(updated);
  }, [crosses, stocks]);

  // Active tasks: crosses approaching a transition
  const activeTasks = useMemo(() => activeCrosses.filter(c =>
    c.status === 'collecting virgins' ||
    c.status === 'collecting progeny' ||
    c.status === 'ripening' ||
    (c.status === 'waiting for virgins' && -dFromNow(c.setupDate) >= 7) ||
    (c.status === 'waiting for progeny' && c.waitStartDate && -dFromNow(c.waitStartDate) >= 7)
  ), [activeCrosses]);

  const actionSummary = useMemo(() => {
    let overdue = 0;
    let dueToday = 0;

    activeCrosses.forEach(c => {
      const tl = getTL(c);
      const cd = crossDetect(c, stocks);
      if (c.status === 'set up') {
        const d = dFromNow(tl.virginStart);
        if (d < 0) overdue++;
        else if (d === 0) dueToday++;
      }
      if (c.status === 'waiting for progeny' && c.waitStartDate && -dFromNow(c.waitStartDate) >= 9) overdue++;
      // retinal starts automatically when entering ripening
    });

    stocks.forEach(s => {
      if (s.maintainer && s.maintainer !== currentUser) return;
      const ld = s.lastFlipped || s.createdAt;
      if (!ld) return;
      const age = -dFromNow(ld);
      const threshold = getFlipDays(s);
      if (age >= threshold) overdue++;
    });

    return { overdue, dueToday };
  }, [activeCrosses, stocks]);

  const stocksNeedFlip = useMemo(() => {
    return stocks.filter(s => {
      if (s.maintainer && s.maintainer !== currentUser) return false;
      const ld = s.lastFlipped || s.createdAt;
      if (!ld) return false;
      const age = -dFromNow(ld);
      const threshold = getFlipDays(s);
      return age >= threshold;
    });
  }, [stocks, currentUser]);

  function flipStock(id) {
    setStocks(p => p.map(s => s.id === id ? { ...s, lastFlipped: today() } : s));
    toast.add('Flipped');
  }

  function scrollToActive() {
    activeRef.current?.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  return (
    <div className="pb-8">
      {/* Transfer notifications */}
      {transfers && transfers.length > 0 && (
        <div className="mb-6 space-y-2">
          {transfers.map(t => (
            <div key={t.id} className="card p-4" style={{ borderColor: 'rgba(139,92,246,0.2)', background: 'rgba(139,92,246,0.06)' }}>
              <div className="flex items-center justify-between gap-3">
                <div className="flex-1 min-w-0">
                  <p className="text-sm font-bold" style={{ color: 'var(--text-1)' }}>
                    {t.from} wants to transfer {t.type === 'collection' ? `"${t.collection}" collection` : t.name || t.type}
                  </p>
                  <p className="text-xs mt-0.5" style={{ color: 'var(--text-3)' }}>
                    {t.type === 'stock' ? 'Stock maintainership' : t.type === 'cross' ? 'Cross ownership' : 'Entire collection'}
                  </p>
                </div>
                <div className="flex gap-2 shrink-0">
                  <Btn onClick={() => onAcceptTransfer(t)} style={{ fontSize: '12px', padding: '6px 12px' }}>Accept</Btn>
                  <Btn v="s" onClick={() => onDeclineTransfer(t)} style={{ fontSize: '12px', padding: '6px 12px' }}>Decline</Btn>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Sent transfer results */}
      {sentTransfers && sentTransfers.length > 0 && (
        <div className="mb-6 space-y-2">
          {sentTransfers.map(t => (
            <div key={t.id} className="card p-4" style={{ borderColor: t.status === 'accepted' ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)', background: t.status === 'accepted' ? 'rgba(34,197,94,0.06)' : 'rgba(239,68,68,0.06)' }}>
              <div className="flex items-center justify-between gap-3">
                <div className="flex-1 min-w-0">
                  <p className="text-sm font-bold" style={{ color: 'var(--text-1)' }}>
                    {t.to} {t.status} your transfer of {t.type === 'collection' ? `"${t.collection}" collection` : t.name || t.type}
                  </p>
                </div>
                <button onClick={() => onDismissTransfer(t)}
                  className="text-xs px-3 py-1.5 rounded-lg transition-all active:scale-95 shrink-0"
                  style={{ background: 'var(--surface-2)', color: 'var(--text-3)', border: '1px solid var(--border)' }}>OK</button>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Action banner */}
      <div className="mb-6">
        {actionSummary.overdue > 0 ? (
          <div className="banner banner-red" onClick={scrollToActive}>
            {actionSummary.overdue} thing{actionSummary.overdue > 1 ? 's' : ''} overdue
          </div>
        ) : actionSummary.dueToday > 0 ? (
          <div className="banner banner-amber" onClick={scrollToActive}>
            {actionSummary.dueToday} thing{actionSummary.dueToday > 1 ? 's' : ''} due today
          </div>
        ) : null}
      </div>

      {/* Active Tasks */}
      {activeTasks.length > 0 && (
        <div className="mb-6">
          <p className="section-header">Active Tasks</p>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
            {activeTasks.map(c => {
              const isCollVgn = c.status === 'collecting virgins';
              const isCollProg = c.status === 'collecting progeny';
              const isRipening = c.status === 'ripening';
              const isVirgin = c.status === 'waiting for virgins';
              const cd = crossDetect(c, stocks);
              let waited, ripeRemaining;
              if (isRipening && c.ripeningStartDate) {
                const rDays = -dFromNow(c.ripeningStartDate);
                const rTarget = cd.o ? 3 : 5;
                ripeRemaining = Math.max(0, rTarget - rDays);
              }
              waited = (isCollVgn || isCollProg || isRipening) ? 0 : -dFromNow(isVirgin ? c.setupDate : c.waitStartDate);
              const target = 9;
              const remaining = (isCollVgn || isCollProg || isRipening) ? 0 : target - waited;
              const ready = isCollVgn || isCollProg || (isRipening && (ripeRemaining === undefined || ripeRemaining <= 0)) || remaining <= 0;
              const ripeWaiting = isRipening && ripeRemaining > 0;
              const tintR = ready ? 'rgba(239,68,68,' : 'rgba(245,158,11,';
              const tintC = ready ? '#fca5a5' : '#fcd34d';
              return (
                <div key={c.id} className="card p-4 cursor-pointer" style={{ borderColor: tintR + '0.15)', background: tintR + '0.06)' }}
                  onClick={() => { setSelectedCrossId(null); setTimeout(() => setSelectedCrossId(c.id), 0); activeRef.current?.scrollIntoView({ behavior: 'smooth', block: 'start' }); }}>
                  <div className="flex items-center gap-3">
                    <div className="w-8 h-8 rounded-full flex items-center justify-center shrink-0" style={{
                      background: tintR + '0.1)',
                      border: '1px solid ' + tintR + '0.15)',
                    }}>
                      <span className="text-xs" style={{ color: tintC }}>{ripeWaiting ? ripeRemaining + 'd' : ready ? '!' : remaining + 'd'}</span>
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="text-sm font-bold truncate" style={{ color: 'var(--text-1)' }}>{cl(c, stocks)}</p>
                      <p className="text-xs" style={{ color: tintC }}>
                        {isRipening ? (ripeRemaining <= 0 ? 'Ripening complete — ready!' : `${ripeRemaining}d ${cd.o ? 'retinal uptake' : 'GCaMP expression'} remaining`)
                          : isCollProg ? 'Collect progeny now!'
                          : isCollVgn ? 'Collect virgins for this cross'
                          : ready
                            ? (isVirgin ? 'Virgins eclosing — collect now!' : 'Progeny ready — collect now!')
                            : (isVirgin ? `${remaining}d until virgins eclose` : `${remaining}d until progeny ready`)}
                      </p>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      )}

      {/* Onboarding */}
      {stocks.length === 0 && crosses.length === 0 && (
        <div className="card p-8 mb-6 text-center">
          <div className="w-16 h-16 rounded-2xl mx-auto mb-4 flex items-center justify-center" style={{ background: 'var(--accent-glow-2)', border: '1px solid rgba(139,92,246,0.15)' }}>
            <span className="text-3xl">🪰</span>
          </div>
          <p className="text-base font-bold mb-2" style={{ color: 'var(--text-1)' }}>Welcome to Flomington</p>
          <p className="text-sm mb-1" style={{ color: 'var(--text-3)' }}>Add your fly stocks first, then start crossing.</p>
          <p className="text-xs mb-5" style={{ color: 'var(--text-3)' }}>Or load demo data from Settings.</p>
        </div>
      )}

      {/* Active Crosses */}
      {activeCrosses.length > 0 && (
        <div ref={activeRef} className="mb-8">
          <p className="section-header">Active Crosses</p>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
            {activeCrosses.map(c => (
              <CrossCard key={c.id} cross={c} stocks={stocks} setCrosses={setCrosses} toast={toast} virginBank={virginBank} setVirginBank={setVirginBank} virginsPerCross={virginsPerCross} forceOpen={selectedCrossId === c.id} currentUser={currentUser} onTransfer={onTransfer} printListCrosses={printListCrosses} setPrintListCrosses={setPrintListCrosses} />
            ))}
          </div>
        </div>
      )}

      {/* Stock Collections — only show categories with stocks due for flipping (excluding expanded) */}
      {(() => {
        // Individual stocks: expanded + "No Collection" (only show if maintainer matches)
        const myStocks = stocks.filter(s => !s.maintainer || s.maintainer === currentUser);
        const dueIndividual = myStocks.filter(s => (s.variant || 'stock') === 'expanded' || (s.category || 'Lab Stocks') === 'No Collection').filter(s => {
          const age = s.lastFlipped || s.createdAt ? -dFromNow(s.lastFlipped || s.createdAt) : null;
          return age !== null && age >= getFlipDays(s);
        });
        const dueCats = STOCK_CATS.filter(cat => cat !== 'No Collection').filter(cat => {
          const catStocks = myStocks.filter(s => (s.variant || 'stock') !== 'expanded' && (s.category || 'Lab Stocks') === cat);
          return catStocks.some(s => {
            const age = s.lastFlipped || s.createdAt ? -dFromNow(s.lastFlipped || s.createdAt) : null;
            const flipDays = getFlipDays(s);
            return age !== null && age >= flipDays;
          });
        });
        if (dueIndividual.length === 0 && dueCats.length === 0) return null;
        return (
          <div ref={healthRef} className="mb-8">
            <p className="section-header">Stocks Due for Flipping</p>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
              {dueIndividual.map(s => (
                <div key={s.id} className="card p-4" style={{ borderColor: 'rgba(239,68,68,0.15)', background: 'rgba(239,68,68,0.04)' }}>
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-[15px] font-bold" style={{ color: 'var(--text-1)' }}>{s.name}</p>
                      <p className="text-xs mt-0.5" style={{ color: '#fca5a5' }}>{-dFromNow(s.lastFlipped || s.createdAt)}d — needs flip</p>
                    </div>
                    <button onClick={() => flipStock(s.id)}
                      className="touch px-4 py-2 text-sm font-semibold rounded-xl transition-all active:scale-95 shrink-0"
                      style={{ background: 'rgba(239,68,68,0.1)', color: '#fca5a5', border: '1px solid rgba(239,68,68,0.15)' }}>
                      Flip
                    </button>
                  </div>
                </div>
              ))}
              {dueCats.map(cat => {
                const catStocks = myStocks.filter(s => (s.variant || 'stock') !== 'expanded' && (s.category || 'Lab Stocks') === cat);
                const dueCount = catStocks.filter(s => {
                  const age = s.lastFlipped || s.createdAt ? -dFromNow(s.lastFlipped || s.createdAt) : null;
                  const flipDays = getFlipDays(s);
                  return age !== null && age >= flipDays;
                }).length;
                return (
                  <div key={cat} className="card p-5 cursor-pointer" style={{ borderColor: 'rgba(239,68,68,0.1)' }} onClick={() => { setFlipCat(cat); setFlipDate(today()); }}>
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-[15px] font-bold" style={{ color: 'var(--text-1)' }}>{cat}</p>
                        <p className="text-xs mt-1" style={{ color: 'var(--text-3)' }}>{catStocks.length} stock{catStocks.length !== 1 ? 's' : ''}</p>
                      </div>
                      <span className="badge" style={{ background: 'rgba(239,68,68,0.1)', color: '#fca5a5', border: '1px solid rgba(239,68,68,0.15)' }}>
                        {dueCount} to flip
                      </span>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        );
      })()}

      {/* Completed */}
      {completedCrosses.length > 0 && (
        <div className="mb-6">
          <button onClick={() => setShowCompleted(!showCompleted)}
            className="text-xs font-medium touch w-full text-left py-2" style={{ color: 'var(--text-3)' }}>
            {showCompleted ? '▾' : '▸'} {completedCrosses.length} completed
          </button>
          {showCompleted && (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 mt-2">
              {completedCrosses.map(c => (
                <CrossCard key={c.id} cross={c} stocks={stocks} setCrosses={setCrosses} toast={toast} virginBank={virginBank} setVirginBank={setVirginBank} virginsPerCross={virginsPerCross} printListCrosses={printListCrosses} setPrintListCrosses={setPrintListCrosses} />
              ))}
            </div>
          )}
        </div>
      )}


      {/* Flip date modal for stock collections */}
      <Modal open={!!flipCat} onClose={() => setFlipCat(null)} title={`${flipCat === '__expanded' ? 'Expanded' : flipCat} — Set Last Flipped`}>
        {flipCat && (() => {
          const catStocks = flipCat === '__expanded'
            ? stocks.filter(s => (s.variant || 'stock') === 'expanded')
            : stocks.filter(s => (s.variant || 'stock') !== 'expanded' && (s.category || 'Lab Stocks') === flipCat);
          return (
            <div>
              <p className="text-xs mb-4" style={{ color: 'var(--text-3)' }}>Set the last flipped date for all {catStocks.length} stocks in {flipCat === '__expanded' ? 'Expanded' : flipCat}.</p>
              <Field label="Last flipped date">
                <Inp type="date" value={flipDate} onChange={e => setFlipDate(e.target.value)} />
              </Field>
              <div className="flex gap-2 mt-2">
                <Btn onClick={() => {
                  const ids = new Set(catStocks.map(s => s.id));
                  setStocks(p => p.map(s => ids.has(s.id) ? { ...s, lastFlipped: flipDate } : s));
                  toast.add(`${flipCat === '__expanded' ? 'Expanded' : flipCat} flipped on ${fmt(flipDate)}`);
                  setFlipCat(null);
                }} className="flex-1">Set All Flipped</Btn>
                <Btn v="s" onClick={() => setFlipCat(null)}>Cancel</Btn>
              </div>
            </div>
          );
        })()}
      </Modal>
    </div>
  );
}

/* ========== STOCKS SCREEN ========== */
function StocksScreen({ stocks, setStocks, toast, currentUser, onTransfer, STOCK_CATS, setCollections, virginBank, setVirginBank, initialStockId, printList, setPrintList, onOpenPrint }) {
  const [search, setSearch] = useState('');
  const [catFilter, setCatFilter] = useState(() => initialStockId ? 'all' : 'all');
  const [showAll, setShowAll] = useState(() => !!initialStockId);
  const [accessDenied, setAccessDenied] = useState(null);
  const [editing, setEditing] = useState(() => {
    if (initialStockId) {
      const s = stocks.find(x => x.id === initialStockId);
      if (s && s.maintainer && s.maintainer !== currentUser) return null;
      return s ? { ...s } : null;
    }
    return null;
  });
  useEffect(() => {
    if (initialStockId) {
      const s = stocks.find(x => x.id === initialStockId);
      if (s && s.maintainer && s.maintainer !== currentUser) {
        setAccessDenied(s.name);
      }
    }
  }, []);
  const [deleting, setDeleting] = useState(null);
  const [flipCat, setFlipCat] = useState(null);
  const [flipDate, setFlipDate] = useState('');
  const [addingCat, setAddingCat] = useState(false);
  const [newCatName, setNewCatName] = useState('');
  const [collectionDetail, setCollectionDetail] = useState(null);

  const filtered = useMemo(() => {
    let result = stocks;
    if (!showAll) result = result.filter(s => s.maintainer === currentUser);
    if (catFilter === 'expanded') {
      result = result.filter(s => (s.variant || 'stock') === 'expanded');
    } else if (catFilter !== 'all') {
      result = result.filter(s => (s.variant || 'stock') !== 'expanded' && (s.category || 'Lab Stocks') === catFilter);
    }
    if (search) {
      const q = search.toLowerCase();
      result = result.filter(s => [s.name, s.genotype || '', s.notes || ''].some(x => x.toLowerCase().includes(q)));
    }
    return result;
  }, [stocks, search, catFilter, showAll, currentUser]);

  function flipStock(id) {
    setStocks(p => p.map(s => s.id === id ? { ...s, lastFlipped: today() } : s));
    toast.add('Flipped');
  }

  function doDelete() {
    const s = stocks.find(x => x.id === deleting);
    setStocks(p => p.filter(x => x.id !== deleting));
    setDeleting(null);
    if (s) toast.add(`Deleted "${s.name}"`, () => setStocks(p => [...p, s]));
  }

  return (
    <div>
      {/* Mine / All toggle */}
      <div className="flex items-center justify-between mb-4">
        <div className="flex gap-2">
          {['mine', 'all'].map(v => (
            <button key={v} onClick={() => setShowAll(v === 'all')}
              className="px-3 py-1.5 text-xs font-semibold rounded-lg transition-all active:scale-95 capitalize"
              style={(v === 'all') === showAll
                ? { background: 'rgba(139,92,246,0.15)', color: '#a78bfa', border: '1px solid rgba(139,92,246,0.2)' }
                : { background: 'var(--surface-2)', color: 'var(--text-3)', border: '1px solid var(--border)' }
              }>{v === 'mine' ? 'My Stocks' : 'All Stocks'}</button>
          ))}
        </div>
        <button onClick={onOpenPrint} className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-semibold rounded-lg transition-all active:scale-95"
          style={{ background: printList.length > 0 ? 'rgba(0,128,128,0.12)' : 'var(--surface-2)', color: printList.length > 0 ? '#5eead4' : 'var(--text-3)', border: printList.length > 0 ? '1px solid rgba(0,128,128,0.2)' : '1px solid var(--border)' }}>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
          {printList.length > 0 && <span>{printList.length}</span>}
        </button>
      </div>
      {/* Collection filter chips */}
      <div className="flex gap-2 mb-4 overflow-x-auto pb-2" style={{ WebkitOverflowScrolling: 'touch', position: 'relative', zIndex: 5 }}>
        {['all', 'expanded', ...STOCK_CATS].map(cat => (
          <button key={cat} onClick={() => setCatFilter(cat)}
            className="px-4 py-2 text-xs font-semibold rounded-xl transition-all active:scale-95 cursor-pointer whitespace-nowrap shrink-0"
            style={catFilter === cat
              ? { background: 'rgba(0,128,128,0.15)', color: '#5eead4', border: '1px solid rgba(0,128,128,0.3)' }
              : { background: 'var(--surface-2)', color: 'var(--text-3)', border: '1px solid var(--border)' }
            }>{cat === 'all' ? 'All' : cat}</button>
        ))}
        <button onClick={() => { setAddingCat(true); setNewCatName(''); }}
          className="px-3 py-2 text-xs font-semibold rounded-xl transition-all active:scale-95 cursor-pointer whitespace-nowrap shrink-0"
          style={{ background: 'var(--surface-2)', color: 'var(--accent-2)', border: '1px solid var(--border)' }}>+</button>
      </div>

      <div className="flex gap-3 mb-5">
        <Inp placeholder={catFilter === 'all' ? 'Search all stocks...' : `Search ${catFilter}...`} value={search} onChange={e => setSearch(e.target.value)} className="flex-1" />
        <Btn onClick={() => setEditing({ id: null, name: '', genotype: '', category: catFilter === 'all' || catFilter === 'expanded' ? 'Lab Stocks' : catFilter, location: '25inc', notes: '', variant: catFilter === 'expanded' ? 'expanded' : 'stock', lastFlipped: today(), createdAt: today(), maintainer: currentUser })}>+ Add</Btn>
      </div>

      {catFilter !== 'all' && catFilter !== 'expanded' && catFilter !== 'No Collection' && filtered.length > 0 && (() => {
        const dueCount = filtered.filter(s => {
          const age = s.lastFlipped || s.createdAt ? -dFromNow(s.lastFlipped || s.createdAt) : null;
          return age !== null && age >= getFlipDays(s);
        }).length;
        const label = catFilter;
        const allStocksInCat = stocks.filter(s => (s.variant || 'stock') !== 'expanded' && (s.category || 'Lab Stocks') === catFilter);
        const maintainers = [...new Set(allStocksInCat.map(s => s.maintainer).filter(Boolean))];
        const collMaintainer = maintainers.length === 1 ? maintainers[0] : null;
        return (
          <div className="card p-4 mb-5 cursor-pointer" onClick={() => setCollectionDetail(catFilter)}>
            <div className="flex items-center justify-between gap-3">
              <div className="flex-1 min-w-0">
                <p className="text-[15px] font-bold" style={{ color: 'var(--text-1)' }}>{label}</p>
                <p className="text-xs mt-0.5" style={{ color: 'var(--text-3)' }}>
                  {filtered.length} stock{filtered.length !== 1 ? 's' : ''}{dueCount > 0 ? ` · ${dueCount} due` : ''}
                  {collMaintainer ? ` · ${collMaintainer}` : maintainers.length > 1 ? ` · mixed` : ''}
                </p>
              </div>
              <span className="badge" style={{ background: dueCount > 0 ? 'rgba(239,68,68,0.1)' : 'var(--surface-2)', color: dueCount > 0 ? '#fca5a5' : 'var(--text-3)', border: dueCount > 0 ? '1px solid rgba(239,68,68,0.15)' : '1px solid var(--border)' }}>
                {dueCount > 0 ? `${dueCount} to flip` : 'Flip All'}
              </span>
            </div>
          </div>
        );
      })()}

      {filtered.length === 0 ? (
        <div className="text-center py-16"><p className="text-sm" style={{ color: 'var(--text-3)' }}>{stocks.length ? 'No matches' : 'No stocks yet'}</p></div>
      ) : (
        <>
          {(() => {
            const groups = [];
            const expandedStocks = filtered.filter(s => (s.variant || 'stock') === 'expanded');
            if (expandedStocks.length > 0) groups.push({ label: 'Expanded', items: expandedStocks });
            STOCK_CATS.forEach(cat => {
              const catStocks = filtered.filter(s => (s.variant || 'stock') !== 'expanded' && (s.category || 'Lab Stocks') === cat);
              if (catStocks.length > 0) groups.push({ label: cat, items: catStocks });
            });
            return groups.map(({ label, items }) => (
              <div key={label} className="mb-8">
                <p className="section-header">{label}</p>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                  {items.map(s => {
                    const isMine = !s.maintainer || s.maintainer === currentUser;
                    const age = s.lastFlipped || s.createdAt ? -dFromNow(s.lastFlipped || s.createdAt) : null;
                    const flipDays = getFlipDays(s);
                    const needsFlip = isMine && age !== null && age >= flipDays;
                    const nearFlip = isMine && age !== null && !needsFlip && age / flipDays >= 0.8;
                    const dc = detect(s.genotype);
                    return (
                      <div key={s.id} className="card p-4" style={needsFlip ? { borderColor: 'rgba(239,68,68,0.15)', background: 'rgba(239,68,68,0.06)' } : nearFlip ? { borderColor: 'rgba(245,158,11,0.15)', background: 'rgba(245,158,11,0.06)' } : {}} onClick={() => setEditing({ ...s })}>
                        <div className="flex items-start gap-3">
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2 flex-wrap mb-0.5">
                              <span className="text-[15px] font-bold" style={{ color: 'var(--text-1)' }}>{s.name}</span>
                              <span className="badge" style={{ background: 'var(--surface-2)', color: 'var(--text-2)' }}>{(s.variant || 'stock') === 'expanded' ? '7d' : tempLabel(s.location)}</span>
                              {dc.o && <span className="badge" style={{ background: 'rgba(239,68,68,0.1)', color: '#fca5a5' }}>opto</span>}
                              {dc.c && <span className="badge" style={{ background: 'rgba(34,197,94,0.1)', color: '#86efac' }}>imaging</span>}
                              {s.maintainer && <span className="badge" style={{ background: 'var(--surface-2)', color: 'var(--text-2)' }}>{s.maintainer}</span>}
                            </div>
                            {s.genotype && s.genotype !== '+' && <p className="text-xs mono truncate" style={{ color: 'rgba(167,139,250,0.35)' }}>{s.genotype}</p>}
                            {isMine && age !== null && (
                              <div className="mt-2">
                                <div className="flex items-center justify-between mb-1">
                                  <p className="text-xs" style={{ color: needsFlip ? '#fca5a5' : nearFlip ? '#fcd34d' : 'var(--text-3)', fontWeight: (needsFlip || nearFlip) ? 500 : 400 }}>
                                    {needsFlip ? `${age}d — needs flip` : `${age}d / ${flipDays}d`}
                                  </p>
                                  <p className="text-xs" style={{ color: 'var(--text-3)' }}>{Math.min(Math.round((age / flipDays) * 100), 100)}%</p>
                                </div>
                                <div className="w-full rounded-full overflow-hidden" style={{ height: '4px', background: 'rgba(255,255,255,0.06)' }}>
                                  <div className="h-full rounded-full transition-all" style={{
                                    width: `${Math.min((age / flipDays) * 100, 100)}%`,
                                    background: needsFlip
                                      ? 'linear-gradient(90deg, #ef4444, #fca5a5)'
                                      : nearFlip
                                        ? 'linear-gradient(90deg, #f59e0b, #fcd34d)'
                                        : 'linear-gradient(90deg, #008080, #8a9a5b)',
                                  }} />
                                </div>
                              </div>
                            )}
                          </div>
                          {isMine && needsFlip && (
                            <button onClick={e => { e.stopPropagation(); flipStock(s.id); }}
                              className="touch px-4 py-2 text-sm font-semibold rounded-xl transition-all active:scale-95 shrink-0"
                              style={{ background: 'rgba(239,68,68,0.1)', color: '#fca5a5', border: '1px solid rgba(239,68,68,0.15)' }}>
                              Flip
                            </button>
                          )}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            ));
          })()}
        </>
      )}

      <StockModal stock={editing} onClose={() => setEditing(null)} stocks={stocks} setStocks={setStocks} toast={toast} onDelete={id => { setEditing(null); setDeleting(id); }} STOCK_CATS={STOCK_CATS} currentUser={currentUser} onTransfer={onTransfer} virginBank={virginBank} setVirginBank={setVirginBank} printList={printList} setPrintList={setPrintList} />
      <Confirm open={!!deleting} onOk={doDelete} onNo={() => setDeleting(null)} title="Delete stock?" msg="This stock will be permanently removed." />

      {/* Access denied for deep link */}
      <Modal open={!!accessDenied} onClose={() => setAccessDenied(null)} title="Access Denied">
        <p className="text-sm mb-4" style={{ color: 'var(--text-2)' }}>The stock "{accessDenied}" is maintained by another user. Switch to the correct account to view it.</p>
        <Btn v="s" onClick={() => setAccessDenied(null)} className="w-full">Close</Btn>
      </Modal>

      {/* Collection detail modal */}
      <Modal open={!!collectionDetail} onClose={() => setCollectionDetail(null)} title={collectionDetail || ''}>
        {collectionDetail && (() => {
          const allInCat = stocks.filter(s => (s.variant || 'stock') !== 'expanded' && (s.category || 'Lab Stocks') === collectionDetail);
          const mains = [...new Set(allInCat.map(s => s.maintainer).filter(Boolean))];
          const cm = mains.length === 1 ? mains[0] : null;
          const noMaint = allInCat.some(s => !s.maintainer);
          const dueCount = allInCat.filter(s => {
            const age = s.lastFlipped || s.createdAt ? -dFromNow(s.lastFlipped || s.createdAt) : null;
            return age !== null && age >= getFlipDays(s);
          }).length;
          return (
            <div>
              <p className="text-xs mb-4" style={{ color: 'var(--text-3)' }}>
                {allInCat.length} stock{allInCat.length !== 1 ? 's' : ''}{dueCount > 0 ? ` · ${dueCount} due for flipping` : ''}
                {cm ? ` · Maintainer: ${cm}` : mains.length > 1 ? ` · Mixed maintainers` : ' · No maintainer'}
              </p>

              <Btn onClick={() => { setFlipCat(collectionDetail); setFlipDate(today()); setCollectionDetail(null); }} className="w-full mb-4">
                {dueCount > 0 ? `Flip All (${dueCount} due)` : 'Set All Flipped'}
              </Btn>

              {(noMaint || !cm) && (
                <div className="mb-4">
                  <p className="text-[10px] uppercase tracking-wider font-semibold mb-2" style={{ color: 'var(--text-3)' }}>Assign collection maintainer</p>
                  <div className="flex flex-wrap gap-1.5">
                    {USERS.map(u => (
                      <button key={u} onClick={() => {
                        const ids = new Set(allInCat.map(s => s.id));
                        setStocks(p => p.map(s => ids.has(s.id) ? { ...s, maintainer: u } : s));
                        toast.add(`${u} assigned as maintainer for ${collectionDetail}`);
                        setCollectionDetail(null);
                      }}
                        className="px-3 py-1.5 text-xs rounded-lg transition-all active:scale-95 cursor-pointer"
                        style={{ background: 'rgba(0,128,128,0.08)', color: '#5eead4', border: '1px solid rgba(0,128,128,0.15)' }}>{u}</button>
                    ))}
                  </div>
                </div>
              )}

              {cm === currentUser && onTransfer && (
                <div className="mb-4">
                  <p className="text-[10px] uppercase tracking-wider font-semibold mb-2" style={{ color: 'var(--text-3)' }}>Transfer collection</p>
                  <div className="flex flex-wrap gap-1.5">
                    {USERS.filter(u => u !== currentUser).map(u => (
                      <button key={u} onClick={() => { onTransfer({ type: 'collection', collection: collectionDetail, name: collectionDetail, to: u }); setCollectionDetail(null); }}
                        className="px-3 py-1.5 text-xs rounded-lg transition-all active:scale-95 cursor-pointer"
                        style={{ background: 'rgba(139,92,246,0.08)', color: '#a78bfa', border: '1px solid rgba(139,92,246,0.15)' }}>{u}</button>
                    ))}
                  </div>
                </div>
              )}

              <Btn v="s" onClick={() => setCollectionDetail(null)} className="w-full">Close</Btn>
            </div>
          );
        })()}
      </Modal>

      {/* Flip all popup */}
      <Modal open={!!flipCat} onClose={() => setFlipCat(null)} title={`${flipCat} — Set Last Flipped`}>
        {flipCat && (() => {
          const catStocks = stocks.filter(s => (s.variant || 'stock') !== 'expanded' && (s.category || 'Lab Stocks') === flipCat);
          return (
            <div>
              <p className="text-xs mb-4" style={{ color: 'var(--text-3)' }}>Set the last flipped date for all {catStocks.length} stocks in {flipCat}.</p>
              <Field label="Last flipped date">
                <Inp type="date" value={flipDate} onChange={e => setFlipDate(e.target.value)} />
              </Field>
              <div className="flex gap-2 mt-2">
                <Btn onClick={() => {
                  const ids = new Set(catStocks.map(s => s.id));
                  setStocks(p => p.map(s => ids.has(s.id) ? { ...s, lastFlipped: flipDate } : s));
                  toast.add(`${flipCat} flipped on ${fmt(flipDate)}`);
                  setFlipCat(null);
                }} className="flex-1">Set All Flipped</Btn>
                <Btn v="s" onClick={() => setFlipCat(null)}>Cancel</Btn>
              </div>
            </div>
          );
        })()}
      </Modal>

      {/* Add collection modal */}
      <Modal open={addingCat} onClose={() => setAddingCat(false)} title="New Collection">
        <Field label="Collection name">
          <Inp value={newCatName} onChange={e => setNewCatName(e.target.value)} placeholder="e.g. Screen Stocks" autoFocus
            onKeyDown={e => {
              if (e.key === 'Enter' && newCatName.trim() && !STOCK_CATS.includes(newCatName.trim())) {
                const name = newCatName.trim();
                const idx = STOCK_CATS.indexOf('No Collection');
                const next = [...STOCK_CATS];
                if (idx >= 0) next.splice(idx, 0, name); else next.push(name);
                setCollections(next);
                setCatFilter(name);
                setAddingCat(false);
                toast.add(`Collection "${name}" added`);
              }
            }} />
        </Field>
        {newCatName.trim() && STOCK_CATS.includes(newCatName.trim()) && (
          <p className="text-xs text-red-400 mb-3">Collection already exists</p>
        )}
        <div className="flex gap-2 mt-2">
          <Btn disabled={!newCatName.trim() || STOCK_CATS.includes(newCatName.trim())} onClick={() => {
            const name = newCatName.trim();
            const idx = STOCK_CATS.indexOf('No Collection');
            const next = [...STOCK_CATS];
            if (idx >= 0) next.splice(idx, 0, name); else next.push(name);
            setCollections(next);
            setCatFilter(name);
            setAddingCat(false);
            toast.add(`Collection "${name}" added`);
          }} className="flex-1">Add</Btn>
          <Btn v="s" onClick={() => setAddingCat(false)}>Cancel</Btn>
        </div>
      </Modal>
    </div>
  );
}

function StockModal({ stock, onClose, stocks, setStocks, toast, onDelete, STOCK_CATS, currentUser, onTransfer, virginBank, setVirginBank, printList, setPrintList }) {
  const [f, setF] = useState({});
  const [showNotes, setShowNotes] = useState(false);
  const [nameError, setNameError] = useState('');

  useEffect(() => {
    if (stock) {
      setF({ ...stock });
      setShowNotes(!!stock.notes);
      setNameError('');
    }
  }, [stock?.id, stock !== null]);

  if (!stock) return null;
  const isNew = !stock.id;

  function save() {
    if (!f.name?.trim()) { setNameError('Name is required'); return; }
    const saving = { ...f };
    // Auto-inherit collection maintainer when stock has no maintainer
    if ((saving.variant || 'stock') !== 'expanded' && saving.category && saving.category !== 'No Collection') {
      const catStocks = stocks.filter(s => s.id !== saving.id && (s.variant || 'stock') !== 'expanded' && (s.category || 'Lab Stocks') === saving.category);
      const maintainers = [...new Set(catStocks.map(s => s.maintainer).filter(Boolean))];
      if (maintainers.length === 1 && !saving.maintainer) saving.maintainer = maintainers[0];
    }
    if (isNew) {
      setStocks(p => [...p, { ...saving, id: uid(), createdAt: today(), lastFlipped: today() }]);
      toast.add('Stock added');
    } else {
      setStocks(p => p.map(s => s.id === saving.id ? { ...s, ...saving } : s));
      toast.add('Stock updated');
    }
    onClose();
  }

  return (
    <Modal open={!!stock} onClose={onClose} title={isNew ? 'New Stock' : <div className="flex items-center gap-2">{f.name || 'Edit Stock'}<button onClick={() => { const inList = printList && printList.includes(f.id); setPrintList(p => inList ? p.filter(x => x !== f.id) : [...p, f.id]); toast.add(inList ? 'Removed from print list' : 'Added to print list'); }} className="touch p-1.5 rounded-lg transition-all active:scale-90" style={{ color: printList && printList.includes(f.id) ? '#5eead4' : 'var(--text-3)' }} title={printList && printList.includes(f.id) ? 'In print list' : 'Add to print list'}><svg width="16" height="16" viewBox="0 0 24 24" fill={printList && printList.includes(f.id) ? 'currentColor' : 'none'} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg></button></div>}>
      <Field label="Name *">
        <Inp value={f.name || ''} onChange={e => { setF({ ...f, name: e.target.value }); setNameError(''); }} placeholder="e.g. Oregon-R" autoFocus />
        {nameError && <p className="text-xs text-red-400 mt-1">{nameError}</p>}
      </Field>
      <Field label="Variant">
        <div className="grid grid-cols-2 gap-2">
          {STOCK_VARIANTS.map(v => (
            <div key={v} onClick={() => {
              const upd = { ...f, variant: v };
              if (v === 'expanded') { upd.location = '25inc'; upd.category = null; }
              setF(upd);
            }} className={`loc-card ${(f.variant || 'stock') === v ? 'selected' : ''}`}>
              <div className="text-sm font-bold capitalize" style={{ color: 'var(--text-1)' }}>{v}</div>
              <div className="text-xs mt-0.5" style={{ color: 'var(--text-3)' }}>{v === 'expanded' ? '7d flip @ 25°C' : 'Variable flip'}</div>
            </div>
          ))}
        </div>
      </Field>
      {(f.variant || 'stock') !== 'expanded' && (
        <Field label="Collection">
          <div className="grid grid-cols-3 gap-2">
            {STOCK_CATS.map(cat => (
              <div key={cat} onClick={() => setF({ ...f, category: cat })} className={`loc-card ${f.category === cat ? 'selected' : ''}`}>
                <div className="text-xs font-bold" style={{ color: 'var(--text-1)' }}>{cat}</div>
              </div>
            ))}
          </div>
        </Field>
      )}
      <Field label="Genotype">
        <Inp value={f.genotype || ''} onChange={e => setF({ ...f, genotype: e.target.value })} placeholder="e.g. w[1118]; UAS-CsChrimson/CyO" />
      </Field>
      <div className="flex items-center gap-3 mb-3">
        <div onClick={() => setF({ ...f, isGift: !f.isGift, source: f.isGift ? f.source : '', sourceId: f.isGift ? f.sourceId : '' })}
          className="loc-card flex items-center gap-2 px-4 py-2 cursor-pointer" style={f.isGift ? { borderColor: 'rgba(0,128,128,0.3)', background: 'rgba(0,128,128,0.08)' } : {}}>
          <span className="text-sm">{f.isGift ? '✓' : ''}</span>
          <span className="text-sm font-bold" style={{ color: 'var(--text-1)' }}>Gift</span>
        </div>
      </div>
      {f.isGift ? (
        <Field label="From lab">
          <Inp value={f.giftFrom || ''} onChange={e => setF({ ...f, giftFrom: e.target.value })} placeholder="e.g. Jefferis Lab" />
        </Field>
      ) : (
        <>
          <div className="grid grid-cols-2 gap-3">
            <Field label="Source">
              <select value={f.source || ''} onChange={e => setF({ ...f, source: e.target.value })}
                className="w-full px-4 py-3 text-sm rounded-xl">
                <option value="">—</option>
                {STOCK_SOURCES.map(s => <option key={s} value={s}>{s}</option>)}
              </select>
            </Field>
            <Field label="Stock #">
              <Inp value={f.sourceId || ''} onChange={e => setF({ ...f, sourceId: e.target.value })} placeholder="79039" />
            </Field>
          </div>
          {f.source && f.sourceId && stockUrl(f.source, f.sourceId) && (
            <a href={stockUrl(f.source, f.sourceId)} target="_blank" rel="noopener" className="text-xs mb-3 inline-block touch" style={{ color: 'var(--accent-2)' }}>
              View on {f.source} ↗
            </a>
          )}
          {f.source && !stockUrl(f.source, f.sourceId) && f.source !== 'Other' && (
            <p className="text-xs mb-3" style={{ color: 'var(--text-3)' }}>Source: {f.source}{f.sourceId ? ` #${f.sourceId}` : ''}</p>
          )}
        </>
      )}
      <Field label="FlyBase">
        <Inp value={f.flybaseId || ''} onChange={e => {
          const v = e.target.value;
          const parsed = parseFlyBase(v);
          setF({ ...f, flybaseId: parsed || v });
        }} placeholder="FBst0079039 or flybase.org/reports/..." />
      </Field>
      {f.flybaseId && flybaseUrl(f.flybaseId) && (
        <a href={flybaseUrl(f.flybaseId)} target="_blank" rel="noopener" className="text-xs mb-3 inline-block touch" style={{ color: 'var(--accent-2)' }}>
          View on FlyBase ↗
        </a>
      )}
      {(f.variant || 'stock') !== 'expanded' && (
        <Field label="Location">
          <div className="grid grid-cols-2 gap-2">
            {TEMPS.map(t => (
              <div key={t} onClick={() => setF({ ...f, location: t })} className={`loc-card ${f.location === t ? 'selected' : ''}`}>
                <div className="text-sm font-bold" style={{ color: 'var(--text-1)' }}>{tempFull(t)}</div>
              </div>
            ))}
          </div>
        </Field>
      )}
      {!isNew && (
        <Field label="Last Flipped">
          <Inp type="date" value={f.lastFlipped || ''} onChange={e => setF({ ...f, lastFlipped: e.target.value })} />
          {f.lastFlipped && <p className="text-xs mt-1" style={{ color: 'var(--text-3)' }}>{-dFromNow(f.lastFlipped)}d ago — next flip in {Math.max(0, getFlipDays(f) - (-dFromNow(f.lastFlipped)))}d</p>}
        </Field>
      )}
      {!f.maintainer ? (
        <Field label="Maintainer">
          <select value={f.maintainer || ''} onChange={e => setF({ ...f, maintainer: e.target.value })}
            className="w-full px-4 py-3 text-sm rounded-xl">
            <option value="">—</option>
            {USERS.map(u => <option key={u} value={u}>{u}</option>)}
          </select>
        </Field>
      ) : (
        <Field label="Maintainer">
          <p className="text-sm font-medium mb-2" style={{ color: 'var(--text-1)' }}>{f.maintainer}</p>
          {onTransfer && f.maintainer === currentUser && !isNew && (
            <div>
              <p className="text-[10px] uppercase tracking-wider font-semibold mb-2" style={{ color: 'var(--text-3)' }}>Transfer maintainership</p>
              <div className="flex flex-wrap gap-1.5">
                {USERS.filter(u => u !== currentUser).map(u => (
                  <button key={u} onClick={() => { onTransfer({ type: 'stock', itemId: f.id, name: f.name, to: u }); onClose(); }}
                    className="px-3 py-1.5 text-xs rounded-lg transition-all active:scale-95 cursor-pointer"
                    style={{ background: 'rgba(139,92,246,0.08)', color: '#a78bfa', border: '1px solid rgba(139,92,246,0.15)' }}>{u}</button>
                ))}
              </div>
            </div>
          )}
        </Field>
      )}
      {!showNotes ? (
        <button onClick={() => setShowNotes(true)} className="text-xs mb-4 touch" style={{ color: 'var(--accent-2)' }}>+ add notes</button>
      ) : (
        <Field label="Notes"><Txt value={f.notes || ''} onChange={e => setF({ ...f, notes: e.target.value })} rows={2} /></Field>
      )}
      {!isNew && virginBank && setVirginBank && (
        <div className="mb-4 p-3 rounded-xl" style={{ background: 'var(--surface-2)', border: '1px solid var(--border)' }}>
          <div className="flex items-center justify-between mb-2">
            <p className="text-xs font-semibold" style={{ color: 'var(--text-2)' }}>Virgin Bank</p>
            <p className="text-xs" style={{ color: 'var(--text-3)' }}>{virginBank[f.id] || 0} banked</p>
          </div>
          <div className="flex gap-2">
            <button onClick={() => { if ((virginBank[f.id] || 0) > 0) { setVirginBank(prev => ({ ...prev, [f.id]: Math.max(0, (prev[f.id] || 0) - 1) })); toast.add('-1 virgin'); } }}
              disabled={(virginBank[f.id] || 0) <= 0}
              className="flex-1 px-2 py-1.5 text-xs font-semibold rounded-lg transition-all active:scale-95 cursor-pointer"
              style={(virginBank[f.id] || 0) > 0 ? { background: 'rgba(239,68,68,0.08)', color: '#fca5a5', border: '1px solid rgba(239,68,68,0.15)' } : { background: 'var(--surface-2)', color: 'var(--text-3)', border: '1px solid var(--border)', opacity: 0.4 }}>-1</button>
            {[1, 3, 5].map(n => (
              <button key={n} onClick={() => { setVirginBank(prev => ({ ...prev, [f.id]: (prev[f.id] || 0) + n })); toast.add(`+${n} virgins banked`); }}
                className="flex-1 px-2 py-1.5 text-xs font-semibold rounded-lg transition-all active:scale-95 cursor-pointer"
                style={{ background: 'rgba(0,128,128,0.08)', color: '#5eead4', border: '1px solid rgba(0,128,128,0.15)' }}>+{n}</button>
            ))}
            {(virginBank[f.id] || 0) > 0 && (
              <button onClick={() => { setVirginBank(prev => { const next = { ...prev }; delete next[f.id]; return next; }); toast.add('Cleared'); }}
                className="px-2 py-1.5 text-xs font-semibold rounded-lg transition-all active:scale-95 cursor-pointer"
                style={{ background: 'rgba(239,68,68,0.08)', color: '#fca5a5', border: '1px solid rgba(239,68,68,0.15)' }}>Clear</button>
            )}
          </div>
        </div>
      )}
      {!isNew && (
        <button onClick={() => {
          const url = window.location.origin + window.location.pathname + '?stock=' + f.id;
          navigator.clipboard.writeText(url).then(() => toast.add('Link copied'));
        }}
          className="w-full text-xs mb-3 touch" style={{ color: 'var(--accent-2)' }}>
          Copy share link
        </button>
      )}
      <div className="flex gap-2">
        <Btn onClick={save} className="flex-1">Save</Btn>
        {!isNew && <Btn v="s" onClick={() => {
          const split = { ...f, id: uid(), name: f.name + ' (split)', maintainer: currentUser, createdAt: today(), lastFlipped: today() };
          delete split.notes;
          setStocks(p => [...p, split]);
          toast.add(`Split off "${split.name}"`);
          onClose();
        }}>Split</Btn>}
        {!isNew && <Btn v="d" onClick={() => onDelete(f.id)}>Delete</Btn>}
        <Btn v="s" onClick={onClose}>Cancel</Btn>
      </div>
    </Modal>
  );
}

/* ========== VIRGINS SCREEN ========== */
function VirginsScreen({ stocks, virginBank, setVirginBank, toast, onStartCross }) {
  const [search, setSearch] = useState('');
  const stocksWithVirgins = useMemo(() => {
    return stocks.map(s => ({
      ...s,
      count: virginBank[s.id] || 0,
    })).sort((a, b) => b.count - a.count);
  }, [stocks, virginBank]);

  function addVirgins(stockId, n) {
    setVirginBank(prev => ({ ...prev, [stockId]: (prev[stockId] || 0) + n }));
    toast.add(`+${n} virgins logged`);
  }

  function clearStock(stockId) {
    setVirginBank(prev => { const next = { ...prev }; delete next[stockId]; return next; });
    toast.add('Cleared');
  }

  const totalVirgins = Object.values(virginBank).reduce((s, n) => s + n, 0);

  const bankedStocks = useMemo(() => stocksWithVirgins.filter(s => s.count > 0), [stocksWithVirgins]);

  return (
    <div>
      {/* Virgin Bank Overview */}
      <div className="card p-5 mb-6">
        <div className="flex items-center justify-between mb-4">
          <p className="text-sm font-bold" style={{ color: 'var(--text-1)' }}>Virgin Bank</p>
          <span className="text-xs" style={{ color: 'var(--text-3)' }}>{totalVirgins} total</span>
        </div>
        {bankedStocks.length > 0 ? (
          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
            {bankedStocks.map(s => (
              <div key={s.id} className="flex items-center gap-2 p-3 rounded-xl cursor-pointer transition-all active:scale-95" style={{ background: 'rgba(249,168,212,0.06)', border: '1px solid rgba(249,168,212,0.1)' }} onClick={() => onStartCross?.(s.id)}>
                <span className="text-xl font-bold" style={{ color: '#f9a8d4' }}>{s.count}</span>
                <div className="flex-1 min-w-0">
                  <p className="text-xs font-semibold truncate" style={{ color: 'var(--text-1)' }}>{s.name}</p>
                  <p className="text-[10px]" style={{ color: 'var(--text-3)' }}>♀ banked · tap to cross</p>
                </div>
              </div>
            ))}
          </div>
        ) : (
          <p className="text-xs text-center py-3" style={{ color: 'var(--text-3)' }}>No virgins banked yet</p>
        )}
      </div>

      {/* Log Virgins */}
      <p className="section-header">Log Virgins</p>
      <Inp placeholder="Search stocks..." value={search} onChange={e => setSearch(e.target.value)} className="mb-4" />
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 mb-8">
        {stocks.filter(s => !search || [s.name, s.genotype || ''].some(x => x.toLowerCase().includes(search.toLowerCase()))).map(s => {
          const count = virginBank[s.id] || 0;
          return (
            <div key={s.id} className="card p-4">
              <div className="flex items-center gap-3 mb-3">
                <div className="flex-1 min-w-0">
                  <span className="text-[15px] font-bold" style={{ color: 'var(--text-1)' }}>{s.name}</span>
                  {count > 0 && <span className="badge ml-2" style={{ background: 'rgba(249,168,212,0.12)', color: '#f9a8d4', border: '1px solid rgba(249,168,212,0.15)' }}>{count} ♀</span>}
                </div>
                {count > 0 && (
                  <button onClick={() => clearStock(s.id)} className="text-xs cursor-pointer" style={{ color: 'var(--text-3)' }}>clear</button>
                )}
              </div>
              <div className="flex gap-2">
                <button onClick={() => addVirgins(s.id, -1)} className="qlog-btn flex-1" disabled={count <= 0} style={count <= 0 ? { opacity: 0.3 } : {}}>-1</button>
                {[1, 3, 5].map(n => (
                  <button key={n} onClick={() => addVirgins(s.id, n)} className="qlog-btn flex-1">+{n}</button>
                ))}
              </div>
            </div>
          );
        })}
      </div>

      {stocks.length === 0 && (
        <div className="text-center py-16">
          <p className="text-sm" style={{ color: 'var(--text-3)' }}>Add stocks first to track virgins</p>
        </div>
      )}
    </div>
  );
}

/* ========== SETTINGS SCREEN ========== */
function SettingsScreen({ stocks, crosses, setStocks, setCrosses, toast, bgEffect, setBgEffect, virginsPerCross, setVirginsPerCross, setVirginBank, setTransfers, setCollections, notifyVirgins, setNotifyVirgins, syncUrl, setSyncUrl, syncStatus, setSyncStatus }) {
  const fileRef = useRef(null);
  const [showRef, setShowRef] = useState(false);

  function exportJSON() {
    const d = JSON.stringify({ stocks, crosses, exportedAt: new Date().toISOString() }, null, 2);
    const b = new Blob([d], { type: 'application/json' });
    const u = URL.createObjectURL(b);
    const a = document.createElement('a');
    a.href = u; a.download = `flomington-${today()}.json`; a.click();
    URL.revokeObjectURL(u);
    toast.add('Backup exported');
  }

  function importJSON(e) {
    const file = e.target.files[0];
    if (!file) return;
    const r = new FileReader();
    r.onload = ev => {
      try {
        const d = JSON.parse(ev.target.result);
        if (d.stocks) setStocks(d.stocks);
        if (d.crosses) setCrosses(d.crosses);
        toast.add('Data imported');
      } catch { toast.add('Invalid file'); }
    };
    r.readAsText(file);
    e.target.value = '';
  }

  function exportAllICS() {
    const ev = [];
    crosses.forEach(c => {
      const tl = getTL(c);
      const lb = cl(c, stocks);
      ev.push(
        { date: tl.virginStart, title: `Virgins start: ${lb}`, desc: '' },
        { date: tl.progenyStart, title: `Progeny start: ${lb}`, desc: '' },
      );
      if (c.experimentDate) ev.push({ date: c.experimentDate, title: `Experiment: ${lb}`, desc: c.experimentType || '' });
      (c.vials || []).forEach((v, i) => {
        const vt = calcTL(v.setupDate, c.temperature);
        ev.push(
          { date: vt.virginStart, title: `Virgins V${i + 2}: ${lb}`, desc: '' },
          { date: vt.progenyStart, title: `Progeny V${i + 2}: ${lb}`, desc: '' },
        );
      });
    });
    if (!ev.length) { toast.add('No events to export'); return; }
    dlICS(ev, `flo-all-${today()}.ics`);
    toast.add('Calendar exported');
  }

  function loadDemo() {
    const d = makeDemoData();
    setStocks(d.stocks);
    setCrosses(d.crosses);
    if (d.virginBank && setVirginBank) setVirginBank(d.virginBank);
    if (d.transfers && setTransfers) setTransfers(d.transfers);
    if (d.collections && setCollections) setCollections(d.collections);
    toast.add('Demo data loaded');
  }

  function clearAll() {
    setStocks([]);
    setCrosses([]);
    toast.add('All data cleared');
  }

  // PIN gate for destructive actions
  const [pinAction, setPinAction] = useState(null); // 'clear' | 'demo' | null
  const [pinInput, setPinInput] = useState('');
  const [pinError, setPinError] = useState('');

  function requestPinAction(action) {
    setPinAction(action);
    setPinInput('');
    setPinError('');
  }

  // Keyboard support for settings PIN prompt
  useEffect(() => {
    if (!pinAction) return;
    function onKeyDown(e) {
      if (e.key >= '0' && e.key <= '9') {
        setPinInput(prev => {
          const next = prev + e.key;
          setPinError('');
          if (next.length === 4) {
            const floHash = localStorage.getItem('flo-pin-Flo');
            if (!floHash) { setPinError('Flo has no PIN set'); return ''; }
            hashPin(next).then(h => {
              if (h === floHash) { if (pinAction === 'clear') clearAll(); else if (pinAction === 'demo') loadDemo(); setPinAction(null); setPinInput(''); setPinError(''); }
              else { setPinError('Wrong PIN'); setPinInput(''); }
            });
          }
          return next.length <= 4 ? next : prev;
        });
      } else if (e.key === 'Backspace') {
        setPinInput(prev => prev.slice(0, -1));
        setPinError('');
      } else if (e.key === 'Escape') {
        setPinAction(null);
      }
    }
    window.addEventListener('keydown', onKeyDown);
    return () => window.removeEventListener('keydown', onKeyDown);
  }, [pinAction]);

  function handlePinSubmit() {
    const floHash = localStorage.getItem('flo-pin-Flo');
    if (!floHash) { setPinError('Flo has no PIN set'); return; }
    hashPin(pinInput).then(h => {
      if (h === floHash) {
        if (pinAction === 'clear') clearAll();
        else if (pinAction === 'demo') loadDemo();
        setPinAction(null);
        setPinInput('');
        setPinError('');
      } else {
        setPinError('Wrong PIN');
        setPinInput('');
      }
    });
  }

  function changePin() {
    USERS.forEach(u => localStorage.removeItem(`flo-pin-${u}`));
    window.location.reload();
  }

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
      <div className="card p-5">
        <p className="text-sm font-bold mb-1" style={{ color: 'var(--text-1)' }}>Virgins Per Cross</p>
        <p className="text-xs mb-3" style={{ color: 'var(--text-3)' }}>Number of virgins used when starting a cross from the bank.</p>
        <div className="flex items-center gap-3">
          <button onClick={() => setVirginsPerCross(Math.max(1, virginsPerCross - 1))}
            className="w-10 h-10 rounded-xl flex items-center justify-center text-lg font-bold cursor-pointer"
            style={{ background: 'var(--surface-2)', color: 'var(--text-1)', border: '1px solid var(--border)' }}>-</button>
          <span className="text-2xl font-bold flex-1 text-center" style={{ color: 'var(--text-1)' }}>{virginsPerCross}</span>
          <button onClick={() => setVirginsPerCross(virginsPerCross + 1)}
            className="w-10 h-10 rounded-xl flex items-center justify-center text-lg font-bold cursor-pointer"
            style={{ background: 'var(--surface-2)', color: 'var(--text-1)', border: '1px solid var(--border)' }}>+</button>
        </div>
      </div>

      <div className="card p-5">
        <p className="text-sm font-bold mb-1" style={{ color: 'var(--text-1)' }}>Google Sheets Sync</p>
        <p className="text-xs mb-3" style={{ color: 'var(--text-3)' }}>Sync stocks to a Google Sheet via Apps Script. See google-apps-script.js for setup.</p>
        <Inp value={syncUrl} onChange={e => setSyncUrl(e.target.value)} placeholder="Apps Script web app URL" className="mb-2" />
        {syncUrl && (
          <div className="flex gap-2 mb-2">
            <Btn v="s" onClick={() => {
              setSyncStatus('Pushing...');
              sheetsPush(syncUrl, stocks).then(r => {
                setSyncStatus('Pushed ' + r.count + ' stocks');
                toast.add('Stocks pushed to sheet');
              }).catch(e => { setSyncStatus('Push failed'); toast.add('Push failed: ' + e.message); });
            }} className="flex-1">Push to Sheet</Btn>
            <Btn v="s" onClick={() => {
              setSyncStatus('Pulling...');
              sheetsPull(syncUrl).then(remote => {
                setStocks(local => mergeStocks(local, remote));
                setSyncStatus('Pulled ' + remote.length + ' stocks');
                toast.add('Stocks pulled from sheet');
              }).catch(e => { setSyncStatus('Pull failed'); toast.add('Pull failed: ' + e.message); });
            }} className="flex-1">Pull from Sheet</Btn>
          </div>
        )}
        {syncStatus && <p className="text-xs" style={{ color: 'var(--text-3)' }}>{syncStatus}</p>}
      </div>

      <div className="card p-5">
        <p className="text-sm font-bold mb-1" style={{ color: 'var(--text-1)' }}>Virgin Collection Reminders</p>
        <p className="text-xs mb-3" style={{ color: 'var(--text-3)' }}>Notifications at 9:00, 13:30, and 18:00 when you have active virgin crosses.</p>
        <button onClick={() => {
          if (!notifyVirgins) {
            if (!('Notification' in window)) { toast.add('Notifications not supported'); return; }
            if (Notification.permission === 'denied') { toast.add('Notifications blocked — enable in browser settings'); return; }
            if (Notification.permission === 'default') {
              Notification.requestPermission().then(p => {
                if (p === 'granted') { setNotifyVirgins(true); toast.add('Reminders enabled'); }
                else toast.add('Permission denied');
              });
            } else { setNotifyVirgins(true); toast.add('Reminders enabled'); }
          } else { setNotifyVirgins(false); toast.add('Reminders disabled'); }
        }}
          className="w-full px-4 py-2.5 text-sm font-semibold rounded-xl transition-all active:scale-[0.97]"
          style={notifyVirgins
            ? { background: 'rgba(34,197,94,0.1)', color: '#86efac', border: '1px solid rgba(34,197,94,0.2)' }
            : { background: 'var(--surface-2)', color: 'var(--text-2)', border: '1px solid var(--border)' }
          }>{notifyVirgins ? 'Enabled' : 'Enable Reminders'}</button>
      </div>

      <div className="card p-5">
        <p className="text-sm font-bold mb-1" style={{ color: 'var(--text-1)' }}>Export Backup</p>
        <p className="text-xs mb-3" style={{ color: 'var(--text-3)' }}>Download all data as JSON.</p>
        <Btn v="s" onClick={exportJSON} className="w-full">Export JSON</Btn>
      </div>

      <div className="card p-5">
        <p className="text-sm font-bold mb-1" style={{ color: 'var(--text-1)' }}>Import Backup</p>
        <p className="text-xs mb-3" style={{ color: 'var(--text-3)' }}>Load from a JSON backup. Replaces current data.</p>
        <input type="file" accept=".json" ref={fileRef} onChange={importJSON} className="hidden" />
        <Btn v="s" onClick={() => fileRef.current.click()} className="w-full">Import JSON</Btn>
      </div>

      <div className="card p-5">
        <p className="text-sm font-bold mb-1" style={{ color: 'var(--text-1)' }}>Calendar Export</p>
        <p className="text-xs mb-3" style={{ color: 'var(--text-3)' }}>All cross milestones as .ics file.</p>
        <Btn v="s" onClick={exportAllICS} className="w-full">Export All (.ics)</Btn>
      </div>

      <div className="card p-5">
        <p className="text-sm font-bold mb-1" style={{ color: 'var(--text-1)' }}>Background Effect</p>
        <p className="text-xs mb-3" style={{ color: 'var(--text-3)' }}>Choose an animated background.</p>
        <div className="grid grid-cols-3 gap-2">
          {BG_TYPES.map(t => (
            <button key={t} onClick={() => setBgEffect(t)}
              className="px-3 py-2.5 text-xs font-semibold rounded-xl transition-all active:scale-95 cursor-pointer"
              style={bgEffect === t
                ? { background: 'var(--accent-glow)', color: 'var(--accent-2)', border: '1px solid rgba(139,92,246,0.3)' }
                : { background: 'var(--surface-2)', color: 'var(--text-3)', border: '1px solid var(--border)' }
              }>{BG_LABELS[t]}</button>
          ))}
        </div>
      </div>

      <div className="card p-5">
        <p className="text-sm font-bold mb-1" style={{ color: 'var(--text-1)' }}>Demo Data</p>
        <p className="text-xs mb-3" style={{ color: 'var(--text-3)' }}>Load sample stocks and crosses.</p>
        <Btn v="s" onClick={() => requestPinAction('demo')} className="w-full">Load Demo Data</Btn>
      </div>

      <div className="card p-5">
        <button onClick={() => setShowRef(!showRef)} className="flex items-center justify-between w-full touch">
          <span className="text-sm font-bold" style={{ color: 'var(--text-1)' }}>Quick Reference</span>
          <span style={{ color: 'var(--text-3)' }}>{showRef ? '▴' : '▾'}</span>
        </button>
        {showRef && (
          <div className="text-xs space-y-3 leading-relaxed mt-4" style={{ color: 'var(--text-3)' }}>
            <p><b style={{ color: 'var(--text-2)' }}>25°C</b> — Virgins day 9–11, progeny day 11–15.</p>
            <p><b style={{ color: 'var(--text-2)' }}>18°C</b> — Virgins day 17–19, progeny day 19–23.</p>
            <p><b style={{ color: 'var(--text-2)' }}>Stocks (25°C)</b> — Flip every 2-3 weeks.</p>
            <p><b style={{ color: 'var(--text-2)' }}>Stocks (18°C)</b> — Flip every 6 weeks.</p>
            <p><b style={{ color: 'var(--text-2)' }}>Re-vial</b> — Move parents to new vial after 2-4d for more offspring.</p>
            <p><b style={{ color: 'var(--text-2)' }}>Optogenetics</b> — CsChrimson/ChR2 need 4+ days on all-trans retinal food.</p>
            <p><b style={{ color: 'var(--text-2)' }}>GCaMP</b> — Expression improves 3-5d post-eclosion.</p>
            <p><b style={{ color: 'var(--text-2)' }}>Balancers</b> — FM7 (X), CyO (2nd), TM3/TM6B (3rd).</p>
            <p><b style={{ color: 'var(--text-2)' }}>Nomenclature</b> — Semicolons separate chromosomes. Lowercase = recessive, Uppercase = dominant.</p>
          </div>
        )}
      </div>

      <div className="card p-5">
        <p className="text-sm font-bold mb-1" style={{ color: 'var(--text-1)' }}>Clear All Data</p>
        <Btn v="d" onClick={() => requestPinAction('clear')} className="w-full mt-2">Clear Everything</Btn>
      </div>

      <div className="card p-5">
        <p className="text-sm font-bold mb-1" style={{ color: 'var(--text-1)' }}>Change PIN</p>
        <p className="text-xs mb-3" style={{ color: 'var(--text-3)' }}>Reset and set a new PIN.</p>
        <Btn v="s" onClick={changePin} className="w-full">Reset PIN</Btn>
      </div>

      <p className="text-[10px] text-center mt-4 mb-2" style={{ color: 'var(--text-3)' }}>Flomington</p>

      {pinAction && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4" onClick={() => setPinAction(null)}>
          <div className="absolute inset-0" style={{ background: 'rgba(0,0,0,0.6)', backdropFilter: 'blur(8px)' }} />
          <div className="relative w-72 p-6 rounded-3xl" onClick={e => e.stopPropagation()}
            style={{ background: 'rgba(15,12,41,0.3)', backdropFilter: 'blur(40px) saturate(1.6)', WebkitBackdropFilter: 'blur(40px) saturate(1.6)', border: '1px solid rgba(255,255,255,0.12)', boxShadow: '0 8px 40px rgba(0,0,0,0.35)' }}>
            <p className="text-sm font-bold text-center mb-1" style={{ color: 'var(--text-1)' }}>Enter Flo's PIN</p>
            <p className="text-xs text-center mb-5" style={{ color: 'var(--text-3)' }}>
              {pinAction === 'clear' ? 'Required to clear all data' : 'Required to load demo data'}
            </p>
            <div className="flex gap-3 justify-center mb-4">
              {[0, 1, 2, 3].map(i => <div key={i} className={`pin-dot ${i < pinInput.length ? 'filled' : ''}`} />)}
            </div>
            {pinError && <p className="text-xs text-red-400 mb-3 text-center font-medium">{pinError}</p>}
            <div className="grid grid-cols-3 gap-2 mb-3" style={{ maxWidth: 220, margin: '0 auto' }}>
              {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(n => (
                <button key={n} onClick={() => {
                  const next = pinInput + String(n);
                  setPinInput(next);
                  setPinError('');
                  if (next.length === 4) {
                    const floHash = localStorage.getItem('flo-pin-Flo');
                    if (!floHash) { setPinError('Flo has no PIN set'); setPinInput(''); return; }
                    hashPin(next).then(h => {
                      if (h === floHash) { if (pinAction === 'clear') clearAll(); else if (pinAction === 'demo') loadDemo(); setPinAction(null); setPinInput(''); setPinError(''); }
                      else { setPinError('Wrong PIN'); setPinInput(''); }
                    });
                  }
                }}
                  className="touch w-16 h-11 rounded-xl text-base font-semibold transition-all active:scale-95"
                  style={{ color: 'var(--text-1)', background: 'var(--surface-2)', border: '1px solid var(--border)' }}>
                  {n}
                </button>
              ))}
              <button onClick={() => { setPinInput(pinInput.slice(0, -1)); setPinError(''); }}
                className="touch w-16 h-11 rounded-xl text-xs transition-all active:scale-95"
                style={{ color: 'var(--text-3)', background: 'var(--surface)' }}>Del</button>
              <button onClick={() => {
                const next = pinInput + '0';
                setPinInput(next);
                setPinError('');
                if (next.length === 4) {
                  const floHash = localStorage.getItem('flo-pin-Flo');
                  if (!floHash) { setPinError('Flo has no PIN set'); setPinInput(''); return; }
                  hashPin(next).then(h => {
                    if (h === floHash) { if (pinAction === 'clear') clearAll(); else if (pinAction === 'demo') loadDemo(); setPinAction(null); setPinInput(''); setPinError(''); }
                    else { setPinError('Wrong PIN'); setPinInput(''); }
                  });
                }
              }}
                className="touch w-16 h-11 rounded-xl text-base font-semibold transition-all active:scale-95"
                style={{ color: 'var(--text-1)', background: 'var(--surface-2)', border: '1px solid var(--border)' }}>0</button>
            </div>
            <button onClick={() => setPinAction(null)} className="w-full text-xs mt-2 touch" style={{ color: 'var(--text-3)' }}>Cancel</button>
          </div>
        </div>
      )}
    </div>
  );
}

/* ========== MAIN APP ========== */
/* ========== BACKGROUND EFFECTS ========== */
const BG_TYPES = ['none', 'grainient', 'particles', 'squares', 'dots', 'snow'];
const BG_LABELS = { none: 'None', grainient: 'Grainient', particles: 'Particles', squares: 'Squares', dots: 'Dot Grid', snow: 'Pixel Snow' };

function BackgroundCanvas({ type }) {
  const canvasRef = useRef(null);
  const rafRef = useRef(null);
  const glRef = useRef(null);

  useEffect(() => {
    if (!type || type === 'none') return;
    const canvas = canvasRef.current;
    if (!canvas) return;

    let raf;
    const dpr = Math.min(window.devicePixelRatio || 1, 2);

    const resize = () => {
      canvas.width = window.innerWidth * dpr;
      canvas.height = window.innerHeight * dpr;
      canvas.style.width = window.innerWidth + 'px';
      canvas.style.height = window.innerHeight + 'px';
    };
    resize();
    window.addEventListener('resize', resize);

    if (type === 'grainient') {
      // WebGL2 grainient shader
      const gl = canvas.getContext('webgl2', { alpha: false, antialias: false });
      if (!gl) return;
      glRef.current = gl;

      const vs = `#version 300 es
        in vec2 position;
        void main() { gl_Position = vec4(position, 0.0, 1.0); }`;

      const fs = `#version 300 es
        precision highp float;
        uniform vec2 iResolution;
        uniform float iTime;
        out vec4 fragColor;
        mat2 Rot(float a){float s=sin(a),c=cos(a);return mat2(c,-s,s,c);}
        vec2 hash(vec2 p){p=vec2(dot(p,vec2(2127.1,81.17)),dot(p,vec2(1269.5,283.37)));return fract(sin(p)*43758.5453);}
        float noise(vec2 p){vec2 i=floor(p),f=fract(p),u=f*f*(3.0-2.0*f);float n=mix(mix(dot(-1.0+2.0*hash(i),f),dot(-1.0+2.0*hash(i+vec2(1,0)),f-vec2(1,0)),u.x),mix(dot(-1.0+2.0*hash(i+vec2(0,1)),f-vec2(0,1)),dot(-1.0+2.0*hash(i+vec2(1,1)),f-vec2(1,1)),u.x),u.y);return 0.5+0.5*n;}
        void main(){
          float t=iTime*0.25;
          vec2 uv=gl_FragCoord.xy/iResolution.xy;
          float ratio=iResolution.x/iResolution.y;
          vec2 tuv=uv-0.5;
          tuv/=0.9;
          float degree=noise(vec2(t*0.1,tuv.x*tuv.y)*2.0);
          tuv.y*=1.0/ratio;
          tuv*=Rot(radians((degree-0.5)*500.0+180.0));
          tuv.y*=ratio;
          float amp=50.0;
          tuv.x+=sin(tuv.y*5.0+t*2.0)/amp;
          tuv.y+=sin(tuv.x*7.5+t*2.0)/(amp*0.5);
          vec3 c1=vec3(0.35,0.5,0.2);
          vec3 c2=vec3(0.0,0.502,0.502);
          vec3 c3=vec3(0.8,0.6,0.2);
          mat2 br=Rot(radians(0.0));
          float bx=(tuv*br).x;
          vec3 l1=mix(c3,c2,smoothstep(-0.3,-0.1+0.3,bx));
          vec3 l2=mix(c2,c1,smoothstep(-0.3,-0.1+0.3,bx));
          vec3 col=mix(l1,l2,smoothstep(0.5,-0.3,tuv.y));
          vec2 guv=uv*2.0+vec2(iTime*0.05);
          float grain=fract(sin(dot(guv,vec2(12.9898,78.233)))*43758.5453);
          col+=(grain-0.5)*0.1;
          col=(col-0.5)*1.5+0.5;
          col=clamp(col*0.35,0.0,1.0);
          fragColor=vec4(col,1.0);
        }`;

      function makeShader(gl, type, src) {
        const s = gl.createShader(type);
        gl.shaderSource(s, src);
        gl.compileShader(s);
        return s;
      }
      const prog = gl.createProgram();
      gl.attachShader(prog, makeShader(gl, gl.VERTEX_SHADER, vs));
      gl.attachShader(prog, makeShader(gl, gl.FRAGMENT_SHADER, fs));
      gl.linkProgram(prog);
      gl.useProgram(prog);

      const buf = gl.createBuffer();
      gl.bindBuffer(gl.ARRAY_BUFFER, buf);
      gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1, 3,-1, -1,3]), gl.STATIC_DRAW);
      const pos = gl.getAttribLocation(prog, 'position');
      gl.enableVertexAttribArray(pos);
      gl.vertexAttribPointer(pos, 2, gl.FLOAT, false, 0, 0);

      const uRes = gl.getUniformLocation(prog, 'iResolution');
      const uTime = gl.getUniformLocation(prog, 'iTime');
      const t0 = performance.now();

      const draw = () => {
        gl.viewport(0, 0, canvas.width, canvas.height);
        gl.uniform2f(uRes, canvas.width, canvas.height);
        gl.uniform1f(uTime, (performance.now() - t0) * 0.001);
        gl.drawArrays(gl.TRIANGLES, 0, 3);
        raf = requestAnimationFrame(draw);
      };
      raf = requestAnimationFrame(draw);

    } else if (type === 'particles') {
      const ctx = canvas.getContext('2d');
      const count = 80;
      const pts = Array.from({ length: count }, () => ({
        x: Math.random(), y: Math.random(), z: Math.random(),
        vx: (Math.random() - 0.5) * 0.0003, vy: (Math.random() - 0.5) * 0.0003,
        size: 1 + Math.random() * 2,
        color: ['rgba(139,92,246,', 'rgba(167,139,250,', 'rgba(34,197,94,'][Math.floor(Math.random() * 3)],
      }));
      const draw = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        pts.forEach(p => {
          p.x += p.vx; p.y += p.vy;
          if (p.x < 0 || p.x > 1) p.vx *= -1;
          if (p.y < 0 || p.y > 1) p.vy *= -1;
          const alpha = 0.15 + p.z * 0.2;
          ctx.beginPath();
          ctx.arc(p.x * canvas.width, p.y * canvas.height, p.size * dpr, 0, Math.PI * 2);
          ctx.fillStyle = p.color + alpha + ')';
          ctx.fill();
        });
        raf = requestAnimationFrame(draw);
      };
      raf = requestAnimationFrame(draw);

    } else if (type === 'squares') {
      const ctx = canvas.getContext('2d');
      const sz = 40 * dpr;
      const offset = { x: 0, y: 0 };
      const draw = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const startX = Math.floor(offset.x / sz) * sz;
        const startY = Math.floor(offset.y / sz) * sz;
        ctx.strokeStyle = 'rgba(255,255,255,0.04)';
        ctx.lineWidth = dpr;
        for (let x = startX; x < canvas.width + sz; x += sz) {
          for (let y = startY; y < canvas.height + sz; y += sz) {
            ctx.strokeRect(x - (offset.x % sz), y - (offset.y % sz), sz, sz);
          }
        }
        offset.x = (offset.x - 0.3 * dpr + sz) % sz;
        offset.y = (offset.y - 0.3 * dpr + sz) % sz;
        raf = requestAnimationFrame(draw);
      };
      raf = requestAnimationFrame(draw);

    } else if (type === 'dots') {
      const ctx = canvas.getContext('2d');
      const gap = 32 * dpr;
      const dotR = 2 * dpr;
      const draw = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let x = gap; x < canvas.width; x += gap) {
          for (let y = gap; y < canvas.height; y += gap) {
            ctx.beginPath();
            ctx.arc(x, y, dotR, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(139,92,246,0.08)';
            ctx.fill();
          }
        }
        raf = requestAnimationFrame(draw);
      };
      raf = requestAnimationFrame(draw);

    } else if (type === 'snow') {
      const ctx = canvas.getContext('2d');
      const count = 120;
      const flakes = Array.from({ length: count }, () => ({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        size: (1 + Math.random() * 2) * dpr,
        speed: (0.3 + Math.random() * 0.7) * dpr,
        drift: (Math.random() - 0.5) * 0.3 * dpr,
        alpha: 0.05 + Math.random() * 0.1,
      }));
      const draw = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        flakes.forEach(f => {
          f.y += f.speed;
          f.x += f.drift;
          if (f.y > canvas.height) { f.y = -f.size; f.x = Math.random() * canvas.width; }
          if (f.x > canvas.width) f.x = 0;
          if (f.x < 0) f.x = canvas.width;
          ctx.fillStyle = `rgba(167,139,250,${f.alpha})`;
          ctx.fillRect(Math.floor(f.x), Math.floor(f.y), f.size, f.size);
        });
        raf = requestAnimationFrame(draw);
      };
      raf = requestAnimationFrame(draw);
    }

    return () => {
      cancelAnimationFrame(raf);
      window.removeEventListener('resize', resize);
    };
  }, [type]);

  if (!type || type === 'none') return null;
  return <canvas key={type} ref={canvasRef} style={{ position: 'fixed', inset: 0, zIndex: 0, pointerEvents: 'none' }} />;
}

/* ========== NAV ICONS ========== */
const IconHome = (active) => (
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke={active ? '#a78bfa' : '#52525b'} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
    <polyline points="9 22 9 12 15 12 15 22" />
  </svg>
);
const IconStocks = (active) => (
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke={active ? '#a78bfa' : '#52525b'} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <line x1="8" y1="6" x2="21" y2="6" /><line x1="8" y1="12" x2="21" y2="12" /><line x1="8" y1="18" x2="21" y2="18" />
    <line x1="3" y1="6" x2="3.01" y2="6" /><line x1="3" y1="12" x2="3.01" y2="12" /><line x1="3" y1="18" x2="3.01" y2="18" />
  </svg>
);
const IconSettings = (active) => (
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke={active ? '#a78bfa' : '#52525b'} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <circle cx="12" cy="12" r="3" />
    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
  </svg>
);

/* ========== LABEL PRINTING ========== */
const LABEL_FORMATS = {
  'L7651': { name: 'Avery J8651 / L7651', cols: 5, rows: 13, labelW: 38.1, labelH: 21.2, marginTop: 10.7, marginLeft: 4.75, gapX: 2.5, gapY: 0, pageW: 210, pageH: 297 },
  'L7161': { name: 'Avery J8161 / L7161', cols: 3, rows: 6, labelW: 63.5, labelH: 46.6, marginTop: 8.7, marginLeft: 7.21, gapX: 2.54, gapY: 0, pageW: 210, pageH: 297 },
};

function crossLabelText(c, stocks) {
  const name = `${sn(stocks, c.parentA)} x ${sn(stocks, c.parentB)}`;
  const tl = getTL(c);
  let action = '';
  if (c.status === 'waiting for virgins' || c.status === 'collecting virgins') {
    action = `Collect virgins from ${tl.virginStart}`;
  } else if (c.status === 'waiting for progeny' || c.status === 'collecting progeny') {
    action = `Collect progeny from ${tl.progenyStart}`;
  } else if (c.status === 'screening') {
    action = 'Screening';
  } else if (c.status === 'ripening') {
    action = 'Ripening';
  } else if (c.status === 'set up') {
    action = `Set up ${c.setupDate || ''}`;
  } else if (c.status === 'done') {
    action = 'Done';
  }
  return { name, action, temp: tempLabel(c.temperature) };
}

function PrintLabelsModal({ open, onClose, printList, setPrintList, printListCrosses, setPrintListCrosses, stocks, crosses, toast }) {
  const [format, setFormat] = useState('L7651');

  if (!open) return null;
  const stockItems = printList.map(id => stocks.find(s => s.id === id)).filter(Boolean);
  const crossItems = (printListCrosses || []).map(id => (crosses || []).find(c => c.id === id)).filter(Boolean);
  const totalCount = stockItems.length + crossItems.length;
  const spec = LABEL_FORMATS[format];

  function doPrint() {
    if (totalCount === 0) return;
    const w = window.open('', '_blank');
    if (!w) { toast.add('Pop-up blocked — allow pop-ups for this site'); return; }

    const baseUrl = window.location.origin + window.location.pathname;

    // Build unified label data
    const allLabels = [];
    stockItems.forEach(s => {
      allLabels.push({ id: 's-' + s.id, name: s.name, line2: s.genotype || '', line3: '', qrUrl: baseUrl + '?stock=' + s.id });
    });
    crossItems.forEach(c => {
      const info = crossLabelText(c, stocks);
      allLabels.push({ id: 'c-' + c.id, name: info.name, line2: info.action, line3: info.temp, qrUrl: '' });
    });

    const perPage = spec.cols * spec.rows;
    const pages = [];
    for (let i = 0; i < allLabels.length; i += perPage) {
      pages.push(allLabels.slice(i, i + perPage));
    }

    const pagesHtml = pages.map((pageItems) => {
      const cells = pageItems.map((lb) => {
        return `<div class="label">
          ${lb.qrUrl ? '<div class="label-qr" id="qr-' + lb.id + '"></div>' : ''}
          <div class="label-text">
            <div class="label-name">${lb.name}</div>
            ${lb.line2 ? '<div class="label-geno">' + lb.line2 + '</div>' : ''}
            ${lb.line3 ? '<div class="label-info">' + lb.line3 + '</div>' : ''}
          </div>
        </div>`;
      }).join('\n');
      return `<div class="page">${cells}</div>`;
    }).join('\n');

    const qrData = JSON.stringify(allLabels.filter(lb => lb.qrUrl).map(lb => ({ id: lb.id, url: lb.qrUrl })));

    // Scale sizes based on label dimensions
    const isLarge = spec.labelH > 30;
    const qrSize = isLarge ? 20 : 10;
    const pad = isLarge ? '2mm 3mm' : '0.8mm 1mm';
    const gap = isLarge ? '2mm' : '1mm';
    const nameSize = isLarge ? '10pt' : '6.5pt';
    const genoSize = isLarge ? '7pt' : '4.5pt';
    const genoClamp = isLarge ? 5 : 3;
    const infoSize = isLarge ? '7pt' : '4.5pt';

    w.document.write(`<!DOCTYPE html><html><head><title>Flomington Labels</title>
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"><\/script>
<style>
@page { size: A4; margin: 0; }
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { width: ${spec.pageW}mm; }
body { font-family: Arial, Helvetica, sans-serif; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
.page {
  width: ${spec.pageW}mm; height: ${spec.pageH}mm;
  padding-top: ${spec.marginTop}mm;
  padding-left: ${spec.marginLeft}mm;
  display: grid;
  grid-template-columns: repeat(${spec.cols}, ${spec.labelW}mm);
  grid-template-rows: repeat(${spec.rows}, ${spec.labelH}mm);
  column-gap: ${spec.gapX}mm;
  row-gap: ${spec.gapY}mm;
  page-break-after: always;
  overflow: hidden;
}
.page:last-child { page-break-after: auto; }
.label {
  width: ${spec.labelW}mm; height: ${spec.labelH}mm;
  overflow: hidden;
  padding: ${pad};
  display: flex; flex-direction: row; align-items: center; gap: ${gap};
}
.label-qr { flex-shrink: 0; width: ${qrSize}mm; height: ${qrSize}mm; }
.label-qr svg { display: block; width: ${qrSize}mm; height: ${qrSize}mm; }
.label-text { flex: 1; min-width: 0; overflow: hidden; }
.label-name { font-size: ${nameSize}; font-weight: bold; line-height: 1.2; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; word-break: break-word; }
.label-geno { font-size: ${genoSize}; font-family: 'Courier New', monospace; line-height: 1.2; overflow: hidden; word-break: break-all; display: -webkit-box; -webkit-line-clamp: ${genoClamp}; -webkit-box-orient: vertical; color: #444; margin-top: 0.5mm; }
.label-info { font-size: ${infoSize}; color: #666; line-height: 1.2; margin-top: 0.3mm; }
@media print {
  body { margin: 0; }
  .page { break-after: page; }
  .page:last-child { break-after: auto; }
}
</style></head><body>${pagesHtml}
<script>
var items = ${qrData};
var qrSz = '${qrSize}mm';
items.forEach(function(s) {
  var el = document.getElementById('qr-' + s.id);
  if (!el) return;
  try {
    var qr = qrcode(0, 'L');
    qr.addData(s.url);
    qr.make();
    el.innerHTML = qr.createSvgTag({ cellSize: 2, margin: 0, scalable: true });
    var svg = el.querySelector('svg');
    if (svg) { svg.setAttribute('width', qrSz); svg.setAttribute('height', qrSz); svg.style.display = 'block'; }
  } catch(e) { el.textContent = ''; }
});
setTimeout(function(){ window.print(); }, 500);
<\/script></body></html>`);
    w.document.close();
  }

  return (
    <Modal open={open} onClose={onClose} title="Print Labels" wide>
      <div className="mb-4">
        <div className="flex items-center justify-between mb-3">
          <p className="text-xs" style={{ color: 'var(--text-3)' }}>{totalCount} label{totalCount !== 1 ? 's' : ''} queued</p>
          <select value={format} onChange={e => setFormat(e.target.value)}
            className="px-3 py-1.5 text-xs rounded-lg" style={{ background: 'var(--surface-2)', color: 'var(--text-1)', border: '1px solid var(--border)' }}>
            {Object.entries(LABEL_FORMATS).map(([k, v]) => (
              <option key={k} value={k}>{v.name} ({v.labelW}x{v.labelH}mm, {v.cols * v.rows}/sheet)</option>
            ))}
          </select>
        </div>

        {totalCount === 0 ? (
          <div className="text-center py-8">
            <p className="text-sm" style={{ color: 'var(--text-3)' }}>No labels queued</p>
            <p className="text-xs mt-1" style={{ color: 'var(--text-3)' }}>Tap the printer icon in stock or cross details to add them</p>
          </div>
        ) : (
          <div className="space-y-2 max-h-[40vh] overflow-y-auto mb-4">
            {stockItems.length > 0 && <p className="text-[10px] uppercase tracking-wider font-semibold" style={{ color: 'var(--text-3)' }}>Stocks</p>}
            {stockItems.map(s => (
              <div key={s.id} className="flex items-center gap-3 p-3 rounded-xl" style={{ background: 'var(--surface)', border: '1px solid var(--border)' }}>
                <div className="flex-1 min-w-0">
                  <p className="text-sm font-semibold truncate" style={{ color: 'var(--text-1)' }}>{s.name}</p>
                  {s.genotype && <p className="text-xs mono truncate" style={{ color: 'var(--text-3)' }}>{s.genotype}</p>}
                </div>
                <button onClick={() => setPrintList(p => p.filter(x => x !== s.id))} className="touch shrink-0 p-1.5 rounded-lg transition-all active:scale-90"
                  style={{ color: 'var(--text-3)' }} title="Remove">
                  <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><line x1="1" y1="1" x2="13" y2="13"/><line x1="13" y1="1" x2="1" y2="13"/></svg>
                </button>
              </div>
            ))}
            {crossItems.length > 0 && <p className="text-[10px] uppercase tracking-wider font-semibold mt-2" style={{ color: 'var(--text-3)' }}>Crosses</p>}
            {crossItems.map(c => {
              const info = crossLabelText(c, stocks);
              return (
                <div key={c.id} className="flex items-center gap-3 p-3 rounded-xl" style={{ background: 'var(--surface)', border: '1px solid var(--border)' }}>
                  <div className="flex-1 min-w-0">
                    <p className="text-sm font-semibold truncate" style={{ color: 'var(--text-1)' }}>{info.name}</p>
                    <p className="text-xs truncate" style={{ color: 'var(--text-3)' }}>{info.action}</p>
                  </div>
                  <button onClick={() => setPrintListCrosses(p => p.filter(x => x !== c.id))} className="touch shrink-0 p-1.5 rounded-lg transition-all active:scale-90"
                    style={{ color: 'var(--text-3)' }} title="Remove">
                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><line x1="1" y1="1" x2="13" y2="13"/><line x1="13" y1="1" x2="1" y2="13"/></svg>
                  </button>
                </div>
              );
            })}
          </div>
        )}
      </div>

      <div className="flex gap-2">
        <Btn onClick={doPrint} disabled={totalCount === 0} className="flex-1">Print {totalCount > 0 ? `(${totalCount})` : ''}</Btn>
        {totalCount > 0 && <Btn v="d" onClick={() => { setPrintList([]); setPrintListCrosses([]); toast.add('Print list cleared'); }}>Clear All</Btn>}
        <Btn v="s" onClick={onClose}>Close</Btn>
      </div>
    </Modal>
  );
}

function App() {
  const [currentUser, setCurrentUser] = useLS('flo-user', 'Flo');
  const [locked, setLocked] = useState(() => {
    if (!localStorage.getItem(`flo-pin-${currentUser}`)) return true;
    return false;
  });
  const [pendingUser, setPendingUser] = useState(null);
  const [tab, setTab] = useState('home');
  const [stocks, setStocks] = useLS('flo-stocks', []);
  const [crosses, setCrosses] = useLS('flo-crosses', []);
  const [bgEffect, setBgEffect] = useLS('flo-bg', 'grainient');
  useEffect(() => { if (localStorage.getItem('flo-bg') === '"none"') { setBgEffect('grainient'); } }, []);
  const [virginBank, setVirginBank] = useLS(`flo-virgins-${currentUser}`, {});
  const [virginsPerCross, setVirginsPerCross] = useLS('flo-vpc', 5);
  const [transfers, setTransfers] = useLS('flo-transfers', []);
  const [collections, setCollections] = useLS('flo-collections', DEFAULT_CATS);
  const STOCK_CATS = collections;
  const [notifyVirgins, setNotifyVirgins] = useLS('flo-notify-virgins', false);
  const [printList, setPrintList] = useLS('flo-print-list', []);
  const [printListCrosses, setPrintListCrosses] = useLS('flo-print-crosses', []);
  const [printOpen, setPrintOpen] = useState(false);
  const SHEETS_SYNC_URL = 'https://script.google.com/macros/s/AKfycbxuR_-oBOJlg4bwL-A0S1wIF2irDL0zky57REwP_kLEHBnhy8fgUm_MpSk4ct22kHCdKw/exec';
  const [syncUrl, setSyncUrl] = useLS('flo-sync-url', SHEETS_SYNC_URL);
  useEffect(() => { if (!syncUrl) setSyncUrl(SHEETS_SYNC_URL); }, []);
  const [syncStatus, setSyncStatus] = useState('');
  const syncTimer = useRef(null);

  // Auto-push stocks to sheet on changes (debounced)
  useEffect(() => {
    if (!syncUrl) return;
    clearTimeout(syncTimer.current);
    syncTimer.current = setTimeout(() => {
      sheetsPush(syncUrl, stocks).then(() => {
        setSyncStatus('Synced ' + new Date().toLocaleTimeString());
      }).catch(() => setSyncStatus('Push failed'));
    }, 3000);
  }, [stocks, syncUrl]);

  // Pull from sheet on first load
  const hasPulled = useRef(false);
  useEffect(() => {
    if (!syncUrl || hasPulled.current) return;
    hasPulled.current = true;
    setSyncStatus('Syncing...');
    sheetsPull(syncUrl).then(remote => {
      if (remote.length > 0) {
        setStocks(local => mergeStocks(local, remote));
      }
      setSyncStatus('Synced ' + new Date().toLocaleTimeString());
    }).catch(() => setSyncStatus('Pull failed'));
  }, [syncUrl]);

  const [newCrossOpen, setNewCrossOpen] = useState(false);
  const [virginCrossStock, setVirginCrossStock] = useState(null);
  const toast = useToast();

  // Deep link: ?stock=<id> opens that stock
  const [deepLinkStock, setDeepLinkStock] = useState(() => {
    const params = new URLSearchParams(window.location.search);
    const stockId = params.get('stock');
    if (stockId) {
      history.replaceState(null, '', window.location.pathname);
      return stockId;
    }
    return null;
  });
  useEffect(() => {
    if (deepLinkStock && stocks.length > 0) {
      setTab('stocks');
    }
  }, [deepLinkStock]);

  // Virgin collection notifications at 9:00, 13:30, 18:00
  useEffect(() => {
    if (!notifyVirgins) return;
    const NOTIFY_TIMES = [[9, 0], [13, 30], [18, 0]];
    const lastNotify = { key: '' };

    function check() {
      const now = new Date();
      const h = now.getHours(), m = now.getMinutes();
      const timeKey = `${now.toDateString()}-${h}:${m}`;
      if (lastNotify.key === timeKey) return;

      const match = NOTIFY_TIMES.some(([th, tm]) => h === th && m === tm);
      if (!match) return;
      lastNotify.key = timeKey;

      const virginCrosses = crosses.filter(c =>
        c.owner === currentUser &&
        ['collecting virgins', 'waiting for virgins'].includes(c.status)
      );
      if (virginCrosses.length === 0) return;

      if (Notification.permission === 'granted') {
        const count = virginCrosses.length;
        new Notification('Flomington — Virgin Collection', {
          body: `${count} cross${count > 1 ? 'es' : ''} need${count === 1 ? 's' : ''} virgin collection`,
          icon: 'icon-192.png',
          tag: 'virgin-' + timeKey,
        });
      }
    }

    const interval = setInterval(check, 30000); // check every 30s
    check();
    return () => clearInterval(interval);
  }, [notifyVirgins, crosses, currentUser]);

  const myTransfers = transfers.filter(t => t.to === currentUser && t.status === 'pending');
  const sentResolved = transfers.filter(t => t.from === currentUser && (t.status === 'accepted' || t.status === 'declined') && !t.seen);

  function handleUserSwitch(newUser) {
    if (newUser === currentUser) return;
    setPendingUser(newUser);
  }

  function createTransfer(t) {
    const transfer = { id: uid(), from: currentUser, status: 'pending', createdAt: today(), ...t };
    setTransfers(p => [...p, transfer]);
    toast.add(`Transfer request sent to ${t.to}`);
  }

  if (locked) return <PinLock user={currentUser} onSelectUser={setCurrentUser} onUnlock={() => setLocked(false)} />;
  if (pendingUser) return <PinLock user={pendingUser} onSelectUser={u => setPendingUser(u)} onUnlock={() => { setCurrentUser(pendingUser); setPendingUser(null); }} />;

  return (
    <div className="min-h-screen flex flex-col" style={{ background: 'var(--bg)' }}>
      <BackgroundCanvas type={bgEffect} />

      {/* Header */}
      <header className="px-4 py-3 sticky top-0 z-20" style={{ background: 'rgba(9,9,11,0.8)', backdropFilter: 'blur(20px) saturate(180%)', WebkitBackdropFilter: 'blur(20px) saturate(180%)', borderBottom: '1px solid var(--border)' }}>
        <div className="max-w-6xl mx-auto flex items-center justify-between">
          <h1 className="text-lg font-extrabold tracking-tight cursor-pointer" onClick={() => setTab('home')} style={{ color: 'var(--text-1)' }}>Flomington</h1>
          <select value={currentUser} onChange={e => handleUserSwitch(e.target.value)}
            className="px-4 py-1.5 text-sm font-semibold rounded-xl" style={{ background: 'var(--surface-2)', color: 'var(--text-1)', border: '1px solid var(--border)', outline: 'none', textAlign: 'center' }}>
            {USERS.map(u => <option key={u} value={u}>{u}</option>)}
          </select>
          <span className="text-xs" style={{ color: 'var(--text-3)' }}>{new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</span>
        </div>
      </header>

      {/* Main content */}
      <main className="flex-1 overflow-y-auto pb-28" style={{ position: 'relative', zIndex: 1 }}>
        <div className="max-w-6xl mx-auto px-6 py-6">
          {tab === 'home' && <HomeScreen stocks={stocks} setStocks={setStocks} crosses={crosses} setCrosses={setCrosses} toast={toast} onNewCross={() => setNewCrossOpen(true)} virginBank={virginBank} setVirginBank={setVirginBank} virginsPerCross={virginsPerCross} currentUser={currentUser} onTransfer={createTransfer} transfers={myTransfers} onAcceptTransfer={(t) => {
            if (t.type === 'stock') setStocks(p => p.map(s => s.id === t.itemId ? { ...s, maintainer: currentUser } : s));
            else if (t.type === 'cross') setCrosses(p => p.map(c => c.id === t.itemId ? { ...c, owner: currentUser } : c));
            else if (t.type === 'collection') setStocks(p => p.map(s => (s.category || 'Lab Stocks') === t.collection && s.maintainer === t.from ? { ...s, maintainer: currentUser } : s));
            setTransfers(p => p.map(x => x.id === t.id ? { ...x, status: 'accepted' } : x));
            toast.add(`Accepted transfer from ${t.from}`);
          }} onDeclineTransfer={(t) => {
            setTransfers(p => p.map(x => x.id === t.id ? { ...x, status: 'declined' } : x));
            toast.add('Transfer declined');
          }} STOCK_CATS={STOCK_CATS} sentTransfers={sentResolved} onDismissTransfer={(t) => {
            setTransfers(p => p.map(x => x.id === t.id ? { ...x, seen: true } : x));
          }} printListCrosses={printListCrosses} setPrintListCrosses={setPrintListCrosses} />}
          {tab === 'stocks' && <StocksScreen stocks={stocks} setStocks={setStocks} toast={toast} currentUser={currentUser} onTransfer={createTransfer} STOCK_CATS={STOCK_CATS} setCollections={setCollections} virginBank={virginBank} setVirginBank={setVirginBank} initialStockId={deepLinkStock} printList={printList} setPrintList={setPrintList} onOpenPrint={() => setPrintOpen(true)} />}
          {tab === 'virgins' && <VirginsScreen stocks={stocks} virginBank={virginBank} setVirginBank={setVirginBank} toast={toast} onStartCross={(stockId) => { setVirginCrossStock(stockId); setNewCrossOpen(true); }} />}
          {tab === 'settings' && <SettingsScreen stocks={stocks} crosses={crosses} setStocks={setStocks} setCrosses={setCrosses} toast={toast} bgEffect={bgEffect} setBgEffect={setBgEffect} virginsPerCross={virginsPerCross} setVirginsPerCross={setVirginsPerCross} setVirginBank={setVirginBank} setTransfers={setTransfers} setCollections={setCollections} notifyVirgins={notifyVirgins} setNotifyVirgins={setNotifyVirgins} syncUrl={syncUrl} setSyncUrl={setSyncUrl} syncStatus={syncStatus} setSyncStatus={setSyncStatus} />}
        </div>
      </main>

      {/* Floating pill navigation */}
      <nav className="bottom-nav">
        <div onClick={() => setTab('home')} className={`nav-item ${tab === 'home' ? 'active' : ''}`}>
          {IconHome(tab === 'home')}
          <span style={{ color: tab === 'home' ? 'var(--accent-2)' : 'var(--text-3)' }}>Home</span>
        </div>
        <div onClick={() => setTab('stocks')} className={`nav-item ${tab === 'stocks' ? 'active' : ''}`}>
          {IconStocks(tab === 'stocks')}
          <span style={{ color: tab === 'stocks' ? 'var(--accent-2)' : 'var(--text-3)' }}>Stocks</span>
        </div>
        <div onClick={() => setNewCrossOpen(true)} className="nav-item" style={{ position: 'relative' }}>
          <div className="flex items-center justify-center w-10 h-10 rounded-full" style={{
            background: 'linear-gradient(135deg, #7c3aed, #6d28d9)',
            boxShadow: '0 4px 12px var(--accent-glow)',
            marginTop: '-8px',
          }}>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" strokeWidth="2.5" strokeLinecap="round">
              <line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" />
            </svg>
          </div>
          <span style={{ color: 'var(--accent-2)', fontSize: '9px', fontWeight: 600 }}>Cross</span>
        </div>
        <div onClick={() => setTab('virgins')} className={`nav-item ${tab === 'virgins' ? 'active' : ''}`}>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke={tab === 'virgins' ? '#f9a8d4' : '#52525b'} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <circle cx="12" cy="8" r="5" /><path d="M12 13v8" /><path d="M9 18h6" />
          </svg>
          <span style={{ color: tab === 'virgins' ? '#f9a8d4' : 'var(--text-3)' }}>Virgins</span>
        </div>
        <div onClick={() => setTab('settings')} className={`nav-item ${tab === 'settings' ? 'active' : ''}`}>
          {IconSettings(tab === 'settings')}
          <span style={{ color: tab === 'settings' ? 'var(--accent-2)' : 'var(--text-3)' }}>Settings</span>
        </div>
      </nav>

      <NewCrossWizard open={newCrossOpen} onClose={() => { setNewCrossOpen(false); setVirginCrossStock(null); }} stocks={stocks} setCrosses={setCrosses} toast={toast} virginBank={virginBank} setVirginBank={setVirginBank} preselectedVirgin={virginCrossStock} virginsPerCross={virginsPerCross} currentUser={currentUser} />
      <PrintLabelsModal open={printOpen} onClose={() => setPrintOpen(false)} printList={printList} setPrintList={setPrintList} printListCrosses={printListCrosses} setPrintListCrosses={setPrintListCrosses} stocks={stocks} crosses={crosses} toast={toast} />
      <Toasts items={toast.items} remove={toast.rm} />
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}
</script>
</body>
</html>
